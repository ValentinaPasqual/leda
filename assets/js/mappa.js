var is=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);import{l as os,U as as,a as ls}from"./universalFooter-C2U-GN5J.js";import{p as cs}from"./dataParser-B8qsNdIx.js";import{i as us}from"./initMap-C4-fR1Ni.js";var Ea=is((fe,pe)=>{var vn=typeof global=="object"&&global&&global.Object===Object&&global,ds=typeof self=="object"&&self&&self.Object===Object&&self,Se=vn||ds||Function("return this")(),me=Se.Symbol,yn=Object.prototype,hs=yn.hasOwnProperty,fs=yn.toString,Je=me?me.toStringTag:void 0,ps=Object.prototype.toString,gs="[object Null]",ms="[object Undefined]",_r=me?me.toStringTag:void 0;function Ge(r){return r==null?r===void 0?ms:gs:_r&&_r in Object(r)?function(e){var t=hs.call(e,Je),n=e[Je];try{e[Je]=void 0;var s=!0}catch{}var i=fs.call(e);return s&&(t?e[Je]=n:delete e[Je]),i}(r):function(e){return ps.call(e)}(r)}function Me(r){return r!=null&&typeof r=="object"}var vs="[object Symbol]";function Ue(r){return typeof r=="symbol"||Me(r)&&Ge(r)==vs}function Ve(r,e){for(var t=-1,n=r==null?0:r.length,s=Array(n);++t<n;)s[t]=e(r[t],t,r);return s}var ie=Array.isArray,ys=1/0,Sr=me?me.prototype:void 0,Cr=Sr?Sr.toString:void 0;function bn(r){if(typeof r=="string")return r;if(ie(r))return Ve(r,bn)+"";if(Ue(r))return Cr?Cr.call(r):"";var e=r+"";return e=="0"&&1/r==-ys?"-0":e}function Be(r){var e=typeof r;return r!=null&&(e=="object"||e=="function")}function St(r){return r}var bs="[object AsyncFunction]",ws="[object Function]",xs="[object GeneratorFunction]",_s="[object Proxy]";function wn(r){if(!Be(r))return!1;var e=Ge(r);return e==ws||e==xs||e==bs||e==_s}var Er,$t=Se["__core-js_shared__"],kr=(Er=/[^.]+$/.exec($t&&$t.keys&&$t.keys.IE_PROTO||""))?"Symbol(src)_1."+Er:"",Ss=Function.prototype.toString;function Re(r){if(r!=null){try{return Ss.call(r)}catch{}try{return r+""}catch{}}return""}var Cs=/^\[object .+?Constructor\]$/,Es=RegExp("^"+Function.prototype.toString.call(Object.prototype.hasOwnProperty).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function ze(r,e){var t=function(n,s){return n==null?void 0:n[s]}(r,e);return function(n){return!(!Be(n)||(s=n,kr&&kr in s))&&(wn(n)?Es:Cs).test(Re(n));var s}(t)?t:void 0}var Mr,Nt,Tt,qt=ze(Se,"WeakMap"),Ar=Object.create,ks=function(){function r(){}return function(e){if(!Be(e))return{};if(Ar)return Ar(e);r.prototype=e;var t=new r;return r.prototype=void 0,t}}(),Ms=Date.now,As=function(){try{var r=ze(Object,"defineProperty");return r({},"",{}),r}catch{}}(),bt=As,js=bt?function(r,e){return bt(r,"toString",{configurable:!0,enumerable:!1,value:(t=e,function(){return t}),writable:!0});var t}:St,Ls=(Mr=js,Nt=0,Tt=0,function(){var r=Ms(),e=16-(r-Tt);if(Tt=r,e>0){if(++Nt>=800)return arguments[0]}else Nt=0;return Mr.apply(void 0,arguments)});function Fs(r){return r!=r}function Is(r,e){return!(r==null||!r.length)&&function(t,n,s){return n==n?function(i,o,a){for(var u=-1,c=i.length;++u<c;)if(i[u]===o)return u;return-1}(t,n):function(i,o,a,u){for(var c=i.length,h=-1;++h<c;)if(o(i[h],h,i))return h;return-1}(t,Fs)}(r,e)>-1}var Os=9007199254740991,Ps=/^(?:0|[1-9]\d*)$/;function tr(r,e){var t=typeof r;return!!(e=e??Os)&&(t=="number"||t!="symbol"&&Ps.test(r))&&r>-1&&r%1==0&&r<e}function rr(r,e,t){e=="__proto__"&&bt?bt(r,e,{configurable:!0,enumerable:!0,value:t,writable:!0}):r[e]=t}function Ct(r,e){return r===e||r!=r&&e!=e}var $s=Object.prototype.hasOwnProperty;function xn(r,e,t){var n=r[e];$s.call(r,e)&&Ct(n,t)&&(t!==void 0||e in r)||rr(r,e,t)}function ut(r,e,t,n){var s=!t;t||(t={});for(var i=-1,o=e.length;++i<o;){var a=e[i],u=void 0;u===void 0&&(u=r[a]),s?rr(t,a,u):xn(t,a,u)}return t}var jr=Math.max;function _n(r,e){return Ls(function(t,n,s){return n=jr(n===void 0?t.length-1:n,0),function(){for(var i=arguments,o=-1,a=jr(i.length-n,0),u=Array(a);++o<a;)u[o]=i[n+o];o=-1;for(var c=Array(n+1);++o<n;)c[o]=i[o];return c[n]=s(u),function(h,v,m){switch(m.length){case 0:return h.call(v);case 1:return h.call(v,m[0]);case 2:return h.call(v,m[0],m[1]);case 3:return h.call(v,m[0],m[1],m[2])}return h.apply(v,m)}(t,this,c)}}(r,e,St),r+"")}var Ns=9007199254740991;function nr(r){return typeof r=="number"&&r>-1&&r%1==0&&r<=Ns}function Ze(r){return r!=null&&nr(r.length)&&!wn(r)}function Lr(r,e,t){if(!Be(t))return!1;var n=typeof e;return!!(n=="number"?Ze(t)&&tr(e,t.length):n=="string"&&e in t)&&Ct(t[e],r)}var Ts=Object.prototype;function sr(r){var e=r&&r.constructor;return r===(typeof e=="function"&&e.prototype||Ts)}function Fr(r){return Me(r)&&Ge(r)=="[object Arguments]"}var Sn=Object.prototype,Bs=Sn.hasOwnProperty,Rs=Sn.propertyIsEnumerable,ir=Fr(function(){return arguments}())?Fr:function(r){return Me(r)&&Bs.call(r,"callee")&&!Rs.call(r,"callee")},Cn=typeof fe=="object"&&fe&&!fe.nodeType&&fe,Ir=Cn&&typeof pe=="object"&&pe&&!pe.nodeType&&pe,Or=Ir&&Ir.exports===Cn?Se.Buffer:void 0,wt=(Or?Or.isBuffer:void 0)||function(){return!1},W={};function Et(r){return function(e){return r(e)}}W["[object Float32Array]"]=W["[object Float64Array]"]=W["[object Int8Array]"]=W["[object Int16Array]"]=W["[object Int32Array]"]=W["[object Uint8Array]"]=W["[object Uint8ClampedArray]"]=W["[object Uint16Array]"]=W["[object Uint32Array]"]=!0,W["[object Arguments]"]=W["[object Array]"]=W["[object ArrayBuffer]"]=W["[object Boolean]"]=W["[object DataView]"]=W["[object Date]"]=W["[object Error]"]=W["[object Function]"]=W["[object Map]"]=W["[object Number]"]=W["[object Object]"]=W["[object RegExp]"]=W["[object Set]"]=W["[object String]"]=W["[object WeakMap]"]=!1;var En=typeof fe=="object"&&fe&&!fe.nodeType&&fe,et=En&&typeof pe=="object"&&pe&&!pe.nodeType&&pe,Bt=et&&et.exports===En&&vn.process,We=function(){try{return et&&et.require&&et.require("util").types||Bt&&Bt.binding&&Bt.binding("util")}catch{}}(),Pr=We&&We.isTypedArray,kn=Pr?Et(Pr):function(r){return Me(r)&&nr(r.length)&&!!W[Ge(r)]},zs=Object.prototype.hasOwnProperty;function Mn(r,e){var t=ie(r),n=!t&&ir(r),s=!t&&!n&&wt(r),i=!t&&!n&&!s&&kn(r),o=t||n||s||i,a=o?function(h,v){for(var m=-1,p=Array(h);++m<h;)p[m]=v(m);return p}(r.length,String):[],u=a.length;for(var c in r)!e&&!zs.call(r,c)||o&&(c=="length"||s&&(c=="offset"||c=="parent")||i&&(c=="buffer"||c=="byteLength"||c=="byteOffset")||tr(c,u))||a.push(c);return a}function An(r,e){return function(t){return r(e(t))}}var Ds=An(Object.keys,Object),Hs=Object.prototype.hasOwnProperty;function it(r){return Ze(r)?Mn(r):function(e){if(!sr(e))return Ds(e);var t=[];for(var n in Object(e))Hs.call(e,n)&&n!="constructor"&&t.push(n);return t}(r)}var qs=Object.prototype.hasOwnProperty;function Vs(r){return Ze(r)?Mn(r,!0):function(e){if(!Be(e))return function(i){var o=[];if(i!=null)for(var a in Object(i))o.push(a);return o}(e);var t=sr(e),n=[];for(var s in e)(s!="constructor"||!t&&qs.call(e,s))&&n.push(s);return n}(r)}var Us=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Ws=/^\w*$/;function Vt(r,e){if(ie(r))return!1;var t=typeof r;return!(t!="number"&&t!="symbol"&&t!="boolean"&&r!=null&&!Ue(r))||Ws.test(r)||!Us.test(r)||e!=null&&r in Object(e)}var Ke=ze(Object,"create"),Gs=Object.prototype.hasOwnProperty,Zs=Object.prototype.hasOwnProperty;function Te(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var n=r[e];this.set(n[0],n[1])}}function dt(r,e){for(var t=r.length;t--;)if(Ct(r[t][0],e))return t;return-1}Te.prototype.clear=function(){this.__data__=Ke?Ke(null):{},this.size=0},Te.prototype.delete=function(r){var e=this.has(r)&&delete this.__data__[r];return this.size-=e?1:0,e},Te.prototype.get=function(r){var e=this.__data__;if(Ke){var t=e[r];return t==="__lodash_hash_undefined__"?void 0:t}return Gs.call(e,r)?e[r]:void 0},Te.prototype.has=function(r){var e=this.__data__;return Ke?e[r]!==void 0:Zs.call(e,r)},Te.prototype.set=function(r,e){var t=this.__data__;return this.size+=this.has(r)?0:1,t[r]=Ke&&e===void 0?"__lodash_hash_undefined__":e,this};var Xs=Array.prototype.splice;function ke(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var n=r[e];this.set(n[0],n[1])}}ke.prototype.clear=function(){this.__data__=[],this.size=0},ke.prototype.delete=function(r){var e=this.__data__,t=dt(e,r);return!(t<0||(t==e.length-1?e.pop():Xs.call(e,t,1),--this.size,0))},ke.prototype.get=function(r){var e=this.__data__,t=dt(e,r);return t<0?void 0:e[t][1]},ke.prototype.has=function(r){return dt(this.__data__,r)>-1},ke.prototype.set=function(r,e){var t=this.__data__,n=dt(t,r);return n<0?(++this.size,t.push([r,e])):t[n][1]=e,this};var rt=ze(Se,"Map");function ht(r,e){var t,n,s=r.__data__;return((n=typeof(t=e))=="string"||n=="number"||n=="symbol"||n=="boolean"?t!=="__proto__":t===null)?s[typeof e=="string"?"string":"hash"]:s.map}function Ee(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var n=r[e];this.set(n[0],n[1])}}function or(r,e){if(typeof r!="function"||e!=null&&typeof e!="function")throw new TypeError("Expected a function");var t=function(){var n=arguments,s=e?e.apply(this,n):n[0],i=t.cache;if(i.has(s))return i.get(s);var o=r.apply(this,n);return t.cache=i.set(s,o)||i,o};return t.cache=new(or.Cache||Ee),t}Ee.prototype.clear=function(){this.size=0,this.__data__={hash:new Te,map:new(rt||ke),string:new Te}},Ee.prototype.delete=function(r){var e=ht(this,r).delete(r);return this.size-=e?1:0,e},Ee.prototype.get=function(r){return ht(this,r).get(r)},Ee.prototype.has=function(r){return ht(this,r).has(r)},Ee.prototype.set=function(r,e){var t=ht(this,r),n=t.size;return t.set(r,e),this.size+=t.size==n?0:1,this},or.Cache=Ee;var Rt,zt,Ys=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Qs=/\\(\\)?/g,Js=(Rt=or(function(r){var e=[];return r.charCodeAt(0)===46&&e.push(""),r.replace(Ys,function(t,n,s,i){e.push(s?i.replace(Qs,"$1"):n||t)}),e},function(r){return zt.size===500&&zt.clear(),r}),zt=Rt.cache,Rt);function jn(r,e){return ie(r)?r:Vt(r,e)?[r]:Js(function(t){return t==null?"":bn(t)}(r))}var Ks=1/0;function mt(r){if(typeof r=="string"||Ue(r))return r;var e=r+"";return e=="0"&&1/r==-Ks?"-0":e}function Ut(r,e){for(var t=0,n=(e=jn(e,r)).length;r!=null&&t<n;)r=r[mt(e[t++])];return t&&t==n?r:void 0}function ar(r,e){for(var t=-1,n=e.length,s=r.length;++t<n;)r[s+t]=e[t];return r}var $r=me?me.isConcatSpreadable:void 0;function ei(r){return ie(r)||ir(r)||!!($r&&r&&r[$r])}function ti(r,e,t,n,s){var i=-1,o=r.length;for(t||(t=ei),s||(s=[]);++i<o;){var a=r[i];t(a)?ar(s,a):s[s.length]=a}return s}var Ln=An(Object.getPrototypeOf,Object);function _e(r){var e=this.__data__=new ke(r);this.size=e.size}_e.prototype.clear=function(){this.__data__=new ke,this.size=0},_e.prototype.delete=function(r){var e=this.__data__,t=e.delete(r);return this.size=e.size,t},_e.prototype.get=function(r){return this.__data__.get(r)},_e.prototype.has=function(r){return this.__data__.has(r)},_e.prototype.set=function(r,e){var t=this.__data__;if(t instanceof ke){var n=t.__data__;if(!rt||n.length<199)return n.push([r,e]),this.size=++t.size,this;t=this.__data__=new Ee(n)}return t.set(r,e),this.size=t.size,this};var Fn=typeof fe=="object"&&fe&&!fe.nodeType&&fe,Nr=Fn&&typeof pe=="object"&&pe&&!pe.nodeType&&pe,Tr=Nr&&Nr.exports===Fn?Se.Buffer:void 0,Br=Tr?Tr.allocUnsafe:void 0;function In(){return[]}var ri=Object.prototype.propertyIsEnumerable,Rr=Object.getOwnPropertySymbols,ni=Rr?function(r){return r==null?[]:(r=Object(r),function(e,t){for(var n=-1,s=e==null?0:e.length,i=0,o=[];++n<s;){var a=e[n];ri.call(r,a)&&(o[i++]=a)}return o}(Rr(r)))}:In,lr=ni,si=Object.getOwnPropertySymbols?function(r){for(var e=[];r;)ar(e,lr(r)),r=Ln(r);return e}:In;function ii(r,e,t){var n=e(r);return ie(r)?n:ar(n,t(r))}function Wt(r){return ii(r,it,lr)}var Gt=ze(Se,"DataView"),Zt=ze(Se,"Promise"),Xt=ze(Se,"Set"),zr="[object Map]",Dr="[object Promise]",Hr="[object Set]",qr="[object WeakMap]",Vr="[object DataView]",oi=Re(Gt),ai=Re(rt),li=Re(Zt),ci=Re(Xt),ui=Re(qt),Ne=Ge;(Gt&&Ne(new Gt(new ArrayBuffer(1)))!=Vr||rt&&Ne(new rt)!=zr||Zt&&Ne(Zt.resolve())!=Dr||Xt&&Ne(new Xt)!=Hr||qt&&Ne(new qt)!=qr)&&(Ne=function(r){var e=Ge(r),t=e=="[object Object]"?r.constructor:void 0,n=t?Re(t):"";if(n)switch(n){case oi:return Vr;case ai:return zr;case li:return Dr;case ci:return Hr;case ui:return qr}return e});var nt=Ne,di=Object.prototype.hasOwnProperty,xt=Se.Uint8Array;function hi(r){var e=new r.constructor(r.byteLength);return new xt(e).set(new xt(r)),e}var fi=/\w*$/,Ur=me?me.prototype:void 0,Wr=Ur?Ur.valueOf:void 0,pi="[object Boolean]",gi="[object Date]",mi="[object Map]",vi="[object Number]",yi="[object RegExp]",bi="[object Set]",wi="[object String]",xi="[object Symbol]",_i="[object ArrayBuffer]",Si="[object DataView]",Ci="[object Float32Array]",Ei="[object Float64Array]",ki="[object Int8Array]",Mi="[object Int16Array]",Ai="[object Int32Array]",ji="[object Uint8Array]",Li="[object Uint8ClampedArray]",Fi="[object Uint16Array]",Ii="[object Uint32Array]",Gr=We&&We.isMap,Oi=Gr?Et(Gr):function(r){return Me(r)&&nt(r)=="[object Map]"},Zr=We&&We.isSet,Pi=Zr?Et(Zr):function(r){return Me(r)&&nt(r)=="[object Set]"},$i=1,Ni=2,On="[object Arguments]",Pn="[object Function]",Ti="[object GeneratorFunction]",$n="[object Object]",V={};function vt(r,e,t,n,s,i){var o,a=e&$i,u=e&Ni;if(o!==void 0)return o;if(!Be(r))return r;var c=ie(r);if(c){if(o=function(y){var w=y.length,A=new y.constructor(w);return w&&typeof y[0]=="string"&&di.call(y,"index")&&(A.index=y.index,A.input=y.input),A}(r),!a)return function(y,w){var A=-1,F=y.length;for(w||(w=Array(F));++A<F;)w[A]=y[A];return w}(r,o)}else{var h=nt(r),v=h==Pn||h==Ti;if(wt(r))return function(y,w){var A=y.length,F=Br?Br(A):new y.constructor(A);return y.copy(F),F}(r);if(h==$n||h==On||v&&!s){if(o=v?{}:function(y){return typeof y.constructor!="function"||sr(y)?{}:ks(Ln(y))}(r),!a)return u?function(y,w){return ut(y,si(y),w)}(r,function(y,w){return y&&ut(w,Vs(w),y)}(o,r)):function(y,w){return ut(y,lr(y),w)}(r,function(y,w){return y&&ut(w,it(w),y)}(o,r))}else{if(!V[h])return s?r:{};o=function(y,w,A){var F,T,U=y.constructor;switch(w){case _i:return hi(y);case pi:case gi:return new U(+y);case Si:return function($,X){var I=$.buffer;return new $.constructor(I,$.byteOffset,$.byteLength)}(y);case Ci:case Ei:case ki:case Mi:case Ai:case ji:case Li:case Fi:case Ii:return function($,X){var I=$.buffer;return new $.constructor(I,$.byteOffset,$.length)}(y);case mi:return new U;case vi:case wi:return new U(y);case yi:return(T=new(F=y).constructor(F.source,fi.exec(F))).lastIndex=F.lastIndex,T;case bi:return new U;case xi:return Wr?Object(Wr.call(y)):{}}}(r,h)}}i||(i=new _e);var m=i.get(r);if(m)return m;i.set(r,o),Pi(r)?r.forEach(function(y){o.add(vt(y,e,t,y,r,i))}):Oi(r)&&r.forEach(function(y,w){o.set(w,vt(y,e,t,w,r,i))});var p=c?void 0:Wt(r);return function(y,w){for(var A=-1,F=y==null?0:y.length;++A<F&&w(y[A],A)!==!1;);}(p||r,function(y,w){p&&(y=r[w=y]),xn(o,w,vt(y,e,t,w,r,i))}),o}function Dt(r){return vt(r,4)}function tt(r){var e=-1,t=r==null?0:r.length;for(this.__data__=new Ee;++e<t;)this.add(r[e])}function Bi(r,e){for(var t=-1,n=r==null?0:r.length;++t<n;)if(e(r[t],t,r))return!0;return!1}function Yt(r,e){return r.has(e)}V[On]=V["[object Array]"]=V["[object ArrayBuffer]"]=V["[object DataView]"]=V["[object Boolean]"]=V["[object Date]"]=V["[object Float32Array]"]=V["[object Float64Array]"]=V["[object Int8Array]"]=V["[object Int16Array]"]=V["[object Int32Array]"]=V["[object Map]"]=V["[object Number]"]=V[$n]=V["[object RegExp]"]=V["[object Set]"]=V["[object String]"]=V["[object Symbol]"]=V["[object Uint8Array]"]=V["[object Uint8ClampedArray]"]=V["[object Uint16Array]"]=V["[object Uint32Array]"]=!0,V["[object Error]"]=V[Pn]=V["[object WeakMap]"]=!1,tt.prototype.add=tt.prototype.push=function(r){return this.__data__.set(r,"__lodash_hash_undefined__"),this},tt.prototype.has=function(r){return this.__data__.has(r)};var Ri=1,zi=2;function Xr(r,e,t,n,s,i){var o=t&Ri,a=r.length,u=e.length;if(a!=u&&!(o&&u>a))return!1;var c=i.get(r),h=i.get(e);if(c&&h)return c==e&&h==r;var v=-1,m=!0,p=t&zi?new tt:void 0;for(i.set(r,e),i.set(e,r);++v<a;){var y=r[v],w=e[v];if(n)var A=o?n(w,y,v,e,r,i):n(y,w,v,r,e,i);if(A!==void 0){if(A)continue;m=!1;break}if(p){if(!Bi(e,function(F,T){if(!Yt(p,T)&&(y===F||s(y,F,t,n,i)))return p.push(T)})){m=!1;break}}else if(y!==w&&!s(y,w,t,n,i)){m=!1;break}}return i.delete(r),i.delete(e),m}function Di(r){var e=-1,t=Array(r.size);return r.forEach(function(n,s){t[++e]=[s,n]}),t}function Hi(r){var e=-1,t=Array(r.size);return r.forEach(function(n){t[++e]=n}),t}var qi=1,Vi=2,Ui="[object Boolean]",Wi="[object Date]",Gi="[object Error]",Zi="[object Map]",Xi="[object Number]",Yi="[object RegExp]",Qi="[object Set]",Ji="[object String]",Ki="[object Symbol]",eo="[object ArrayBuffer]",to="[object DataView]",Yr=me?me.prototype:void 0,Ht=Yr?Yr.valueOf:void 0,ro=1,no=Object.prototype.hasOwnProperty,so=1,Qr="[object Arguments]",Jr="[object Array]",ft="[object Object]",Kr=Object.prototype.hasOwnProperty;function Qt(r,e,t,n,s){return r===e||(r==null||e==null||!Me(r)&&!Me(e)?r!=r&&e!=e:function(i,o,a,u,c,h){var v=ie(i),m=ie(o),p=v?Jr:nt(i),y=m?Jr:nt(o),w=(p=p==Qr?ft:p)==ft,A=(y=y==Qr?ft:y)==ft,F=p==y;if(F&&wt(i)){if(!wt(o))return!1;v=!0,w=!1}if(F&&!w)return h||(h=new _e),v||kn(i)?Xr(i,o,a,u,c,h):function(I,P,Y,ce,be,te,le){switch(Y){case to:if(I.byteLength!=P.byteLength||I.byteOffset!=P.byteOffset)return!1;I=I.buffer,P=P.buffer;case eo:return!(I.byteLength!=P.byteLength||!te(new xt(I),new xt(P)));case Ui:case Wi:case Xi:return Ct(+I,+P);case Gi:return I.name==P.name&&I.message==P.message;case Yi:case Ji:return I==P+"";case Zi:var ue=Di;case Qi:if(ue||(ue=Hi),I.size!=P.size&&!(ce&qi))return!1;var ge=le.get(I);if(ge)return ge==P;ce|=Vi,le.set(I,P);var de=Xr(ue(I),ue(P),ce,be,te,le);return le.delete(I),de;case Ki:if(Ht)return Ht.call(I)==Ht.call(P)}return!1}(i,o,p,a,u,c,h);if(!(a&so)){var T=w&&Kr.call(i,"__wrapped__"),U=A&&Kr.call(o,"__wrapped__");if(T||U){var $=T?i.value():i,X=U?o.value():o;return h||(h=new _e),c($,X,a,u,h)}}return!!F&&(h||(h=new _e),function(I,P,Y,ce,be,te){var le=Y&ro,ue=Wt(I),ge=ue.length;if(ge!=Wt(P).length&&!le)return!1;for(var de=ge;de--;){var x=ue[de];if(!(le?x in P:no.call(P,x)))return!1}var l=te.get(I),f=te.get(P);if(l&&f)return l==P&&f==I;var _=!0;te.set(I,P),te.set(P,I);for(var C=le;++de<ge;){var M=I[x=ue[de]],j=P[x];if(ce)var R=le?ce(j,M,x,P,I,te):ce(M,j,x,I,P,te);if(!(R===void 0?M===j||be(M,j,Y,ce,te):R)){_=!1;break}C||(C=x=="constructor")}if(_&&!C){var J=I.constructor,z=P.constructor;J==z||!("constructor"in I)||!("constructor"in P)||typeof J=="function"&&J instanceof J&&typeof z=="function"&&z instanceof z||(_=!1)}return te.delete(I),te.delete(P),_}(i,o,a,u,c,h))}(r,e,t,n,Qt,s))}var io=1,oo=2;function en(r){return r==r&&!Be(r)}function tn(r,e){return function(t){return t!=null&&t[r]===e&&(e!==void 0||r in Object(t))}}function ao(r,e){return r!=null&&e in Object(r)}var lo=1,co=2;function De(r){return typeof r=="function"?r:r==null?St:typeof r=="object"?ie(r)?function(i,o){return Vt(i)&&en(o)?tn(mt(i),o):function(a){var u=function(c,h,v){var m=c==null?void 0:Ut(c,h);return m===void 0?void 0:m}(a,i);return u===void 0&&u===o?function(c,h){return c!=null&&function(v,m,p){for(var y=-1,w=(m=jn(m,v)).length,A=!1;++y<w;){var F=mt(m[y]);if(!(A=v!=null&&p(v,F)))break;v=v[F]}return A||++y!=w?A:!!(w=v==null?0:v.length)&&nr(w)&&tr(F,w)&&(ie(v)||ir(v))}(c,h,ao)}(a,i):Qt(o,u,lo|co)}}(r[0],r[1]):(s=function(i){for(var o=it(i),a=o.length;a--;){var u=o[a],c=i[u];o[a]=[u,c,en(c)]}return o}(n=r),s.length==1&&s[0][2]?tn(s[0][0],s[0][1]):function(i){return i===n||function(o,a,u,c){var h=u.length,v=h;if(o==null)return!v;for(o=Object(o);h--;){var m=u[h];if(m[2]?m[1]!==o[m[0]]:!(m[0]in o))return!1}for(;++h<v;){var p=(m=u[h])[0],y=o[p],w=m[1];if(m[2]){if(y===void 0&&!(p in o))return!1}else{var A=new _e;if(!Qt(w,y,io|oo,void 0,A))return!1}}return!0}(i,0,s)}):Vt(e=r)?(t=mt(e),function(i){return i==null?void 0:i[t]}):function(i){return function(o){return Ut(o,i)}}(e);var e,t,n,s}var uo=function(r,e,t){for(var n=-1,s=Object(r),i=t(r),o=i.length;o--;){var a=i[++n];if(e(s[a],a,s)===!1)break}return r};function Nn(r,e){return r&&uo(r,e,it)}var rn,ho=(rn=Nn,function(r,e){if(r==null)return r;if(!Ze(r))return rn(r,e);for(var t=r.length,n=-1,s=Object(r);++n<t&&e(s[n],n,s)!==!1;);return r});function Tn(r,e){var t=-1,n=Ze(r)?Array(r.length):[];return ho(r,function(s,i,o){n[++t]=e(s,i,o)}),n}function fo(r,e){return r>e}var po=Math.min;function go(r){return function(e){return Me(e)&&Ze(e)}(r)?r:[]}var mo=_n(function(r){var e=Ve(r,go);return e.length&&e[0]===r[0]?function(t,n,s){for(var i=Is,o=t[0].length,a=t.length,u=a,c=Array(a),h=1/0,v=[];u--;){var m=t[u];h=po(m.length,h),c[u]=o>=120&&m.length>=120?new tt(u&&m):void 0}m=t[0];var p=-1,y=c[0];e:for(;++p<o&&v.length<h;){var w=m[p],A=w;if(w=w!==0?w:0,!(y?Yt(y,A):i(v,A,s))){for(u=a;--u;){var F=c[u];if(!(F?Yt(F,A):i(t[u],A,s)))continue e}y&&y.push(A),v.push(w)}}return v}(e):[]}),vo=mo;function yo(r,e){return r<e}function B(r,e){var t={};return e=De(e),Nn(r,function(n,s,i){rr(t,s,e(n,s,i))}),t}function Bn(r,e,t){for(var n=-1,s=r.length;++n<s;){var i=r[n],o=e(i);if(o!=null&&(a===void 0?o==o&&!Ue(o):t(o,a)))var a=o,u=i}return u}function bo(r,e){return r&&r.length?Bn(r,De(e),fo):void 0}function Rn(r,e){for(var t,n=-1,s=r.length;++n<s;){var i=e(r[n]);i!==void 0&&(t=t===void 0?i:t+i)}return t}function wo(r,e){return function(t,n){var s=t==null?0:t.length;return s?Rn(t,n)/s:NaN}(r,De(e))}function xo(r,e){if(r!==e){var t=r!==void 0,n=r===null,s=r==r,i=Ue(r),o=e!==void 0,a=e===null,u=e==e,c=Ue(e);if(!a&&!c&&!i&&r>e||i&&o&&u&&!a&&!c||n&&o&&u||!t&&u||!s)return 1;if(!n&&!i&&!c&&r<e||c&&t&&s&&!n&&!i||a&&t&&s||!o&&s||!u)return-1}return 0}function zn(r,e,t){e=e.length?Ve(e,function(s){return ie(s)?function(i){return Ut(i,s.length===1?s[0]:s)}:s}):[St];var n=-1;return e=Ve(e,Et(De)),function(s,i){var o=s.length;for(s.sort(function(a,u){return function(c,h,v){for(var m=-1,p=c.criteria,y=h.criteria,w=p.length,A=v.length;++m<w;){var F=xo(p[m],y[m]);if(F)return m>=A?F:F*(v[m]=="desc"?-1:1)}return c.index-h.index}(a,u,t)});o--;)s[o]=s[o].value;return s}(Tn(r,function(s,i,o){return{criteria:Ve(e,function(a){return a(s)}),index:++n,value:s}}))}function cr(r,e,t,n){return r==null?[]:(ie(e)||(e=e==null?[]:[e]),ie(t=t)||(t=t==null?[]:[t]),zn(r,e,t))}var _o=_n(function(r,e){if(r==null)return[];var t=e.length;return t>1&&Lr(r,e[0],e[1])?e=[]:t>2&&Lr(e[0],e[1],e[2])&&(e=[e[0]]),zn(r,ti(e),[])});function So(r,e){return r&&r.length?Rn(r,De(e)):0}function N(r){if(this.words=[],r)if(Symbol&&Symbol.iterator&&r[Symbol.iterator]!==void 0){const e=r[Symbol.iterator]();let t=e.next();for(;!t.done;)this.add(t.value),t=e.next()}else for(let e=0;e<r.length;e++)this.add(r[e])}N.fromWords=function(r){const e=Object.create(N.prototype);return e.words=r,e},N.prototype.add=function(r){this.resize(r),this.words[r>>>5]|=1<<r},N.prototype.flip=function(r){this.resize(r),this.words[r>>>5]^=1<<r},N.prototype.clear=function(){this.words.length=0},N.prototype.remove=function(r){this.resize(r),this.words[r>>>5]&=~(1<<r)},N.prototype.isEmpty=function(r){const e=this.words.length;for(let t=0;t<e;t++)if(this.words[t]!==0)return!1;return!0},N.prototype.has=function(r){return(this.words[r>>>5]&1<<r)!=0},N.prototype.checkedAdd=function(r){this.resize(r);const e=this.words[r>>>5],t=e|1<<r;return this.words[r>>>5]=t,(t^e)>>>r},N.prototype.trim=function(r){let e=this.words.length;for(;e>0&&this.words[e-1]===0;)e--;this.words.length=e},N.prototype.resize=function(r){const e=r+32>>>5;for(let t=this.words.length;t<e;t++)this.words[t]=0},N.prototype.hammingWeight=function(r){return 16843009*((r=(858993459&(r-=r>>>1&1431655765))+(r>>>2&858993459))+(r>>>4)&252645135)>>>24},N.prototype.hammingWeight4=function(r,e,t,n){return 16843009*((r=(r=(858993459&(r-=r>>>1&1431655765))+(r>>>2&858993459))+(r>>>4)&252645135)+(e=(e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)+(t=(t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)+(n=(n=(858993459&(n-=n>>>1&1431655765))+(n>>>2&858993459))+(n>>>4)&252645135))>>>24},N.prototype.size=function(){let r=0;const e=this.words.length,t=this.words;for(let n=0;n<e;n++)r+=this.hammingWeight(t[n]);return r},N.prototype.array=function(){const r=new Array(this.size());let e=0;const t=this.words.length;for(let n=0;n<t;++n){let s=this.words[n];for(;s!=0;){const i=s&-s;r[e++]=(n<<5)+this.hammingWeight(i-1|0),s^=i}}return r},N.prototype.forEach=function(r){const e=this.words.length;for(let t=0;t<e;++t){let n=this.words[t];for(;n!=0;){const s=n&-n;r((t<<5)+this.hammingWeight(s-1|0)),n^=s}}},N.prototype[Symbol.iterator]=function(){const r=this.words.length;let e=0,t=this.words[e],n=this.hammingWeight,s=this.words;return{[Symbol.iterator](){return this},next(){for(;e<r;){if(t!==0){const i=t&-t,o=(e<<5)+n(i-1|0);return t^=i,{done:!1,value:o}}e++,e<r&&(t=s[e])}return{done:!0,value:void 0}}}},N.prototype.clone=function(){const r=Object.create(N.prototype);return r.words=this.words.slice(),r},N.prototype.intersects=function(r){const e=Math.min(this.words.length,r.words.length);for(let t=0;t<e;++t)if(this.words[t]&r.words[t])return!0;return!1},N.prototype.intersection=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]&=r.words[t],this.words[t+1]&=r.words[t+1],this.words[t+2]&=r.words[t+2],this.words[t+3]&=r.words[t+3],this.words[t+4]&=r.words[t+4],this.words[t+5]&=r.words[t+5],this.words[t+6]&=r.words[t+6],this.words[t+7]&=r.words[t+7];for(;t<e;++t)this.words[t]&=r.words[t];const n=this.words.length;for(t=e;t<n;++t)this.words[t]=0;return this},N.prototype.intersection_size=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(let n=0;n<e;++n)t+=this.hammingWeight(this.words[n]&r.words[n]);return t},N.prototype.new_intersection=function(r){const e=Object.create(N.prototype),t=Math.min(this.words.length,r.words.length);e.words=new Array(t);let n=0;for(;n+7<t;n+=8)e.words[n]=this.words[n]&r.words[n],e.words[n+1]=this.words[n+1]&r.words[n+1],e.words[n+2]=this.words[n+2]&r.words[n+2],e.words[n+3]=this.words[n+3]&r.words[n+3],e.words[n+4]=this.words[n+4]&r.words[n+4],e.words[n+5]=this.words[n+5]&r.words[n+5],e.words[n+6]=this.words[n+6]&r.words[n+6],e.words[n+7]=this.words[n+7]&r.words[n+7];for(;n<t;++n)e.words[n]=this.words[n]&r.words[n];return e},N.prototype.equals=function(r){const e=Math.min(this.words.length,r.words.length);for(let t=0;t<e;++t)if(this.words[t]!=r.words[t])return!1;if(this.words.length<r.words.length){const t=r.words.length;for(let n=this.words.length;n<t;++n)if(r.words[n]!=0)return!1}else if(r.words.length<this.words.length){const t=this.words.length;for(let n=r.words.length;n<t;++n)if(this.words[n]!=0)return!1}return!0},N.prototype.difference=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]&=~r.words[t],this.words[t+1]&=~r.words[t+1],this.words[t+2]&=~r.words[t+2],this.words[t+3]&=~r.words[t+3],this.words[t+4]&=~r.words[t+4],this.words[t+5]&=~r.words[t+5],this.words[t+6]&=~r.words[t+6],this.words[t+7]&=~r.words[t+7];for(;t<e;++t)this.words[t]&=~r.words[t];return this},N.prototype.new_difference=function(r){return this.clone().difference(r)},N.prototype.difference2=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)r.words[t]=this.words[t]&~r.words[t],r.words[t+1]=this.words[t+1]&~r.words[t+1],r.words[t+2]=this.words[t+2]&~r.words[t+2],r.words[t+3]=this.words[t+3]&~r.words[t+3],r.words[t+4]=this.words[t+4]&~r.words[t+4],r.words[t+5]=this.words[t+5]&~r.words[t+5],r.words[t+6]=this.words[t+6]&~r.words[t+6],r.words[t+7]=this.words[t+7]&~r.words[t+7];for(;t<e;++t)r.words[t]=this.words[t]&~r.words[t];for(t=this.words.length-1;t>=e;--t)r.words[t]=this.words[t];return r.words.length=this.words.length,r},N.prototype.difference_size=function(r){const e=Math.min(this.words.length,r.words.length);let t=0,n=0;for(;n<e;++n)t+=this.hammingWeight(this.words[n]&~r.words[n]);const s=this.words.length;for(;n<s;++n)t+=this.hammingWeight(this.words[n]);return t},N.prototype.change=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]^=r.words[t],this.words[t+1]^=r.words[t+1],this.words[t+2]^=r.words[t+2],this.words[t+3]^=r.words[t+3],this.words[t+4]^=r.words[t+4],this.words[t+5]^=r.words[t+5],this.words[t+6]^=r.words[t+6],this.words[t+7]^=r.words[t+7];for(;t<e;++t)this.words[t]^=r.words[t];for(t=r.words.length-1;t>=e;--t)this.words[t]=r.words[t];return this},N.prototype.new_change=function(r){const e=Object.create(N.prototype),t=Math.max(this.words.length,r.words.length);e.words=new Array(t);const n=Math.min(this.words.length,r.words.length);let s=0;for(;s+7<n;s+=8)e.words[s]=this.words[s]^r.words[s],e.words[s+1]=this.words[s+1]^r.words[s+1],e.words[s+2]=this.words[s+2]^r.words[s+2],e.words[s+3]=this.words[s+3]^r.words[s+3],e.words[s+4]=this.words[s+4]^r.words[s+4],e.words[s+5]=this.words[s+5]^r.words[s+5],e.words[s+6]=this.words[s+6]^r.words[s+6],e.words[s+7]=this.words[s+7]^r.words[s+7];for(;s<n;++s)e.words[s]=this.words[s]^r.words[s];const i=this.words.length;for(s=n;s<i;++s)e.words[s]=this.words[s];const o=r.words.length;for(s=n;s<o;++s)e.words[s]=r.words[s];return e},N.prototype.change_size=function(r){const e=Math.min(this.words.length,r.words.length);let t=0,n=0;for(;n<e;++n)t+=this.hammingWeight(this.words[n]^r.words[n]);const s=this.words.length>r.words.length?this:r,i=s.words.length;for(;n<i;++n)t+=this.hammingWeight(s.words[n]);return t},N.prototype.toString=function(){return"{"+this.array().join(",")+"}"},N.prototype.union=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]|=r.words[t],this.words[t+1]|=r.words[t+1],this.words[t+2]|=r.words[t+2],this.words[t+3]|=r.words[t+3],this.words[t+4]|=r.words[t+4],this.words[t+5]|=r.words[t+5],this.words[t+6]|=r.words[t+6],this.words[t+7]|=r.words[t+7];for(;t<e;++t)this.words[t]|=r.words[t];if(this.words.length<r.words.length){this.resize((r.words.length<<5)-1);const n=r.words.length;for(let s=e;s<n;++s)this.words[s]=r.words[s]}return this},N.prototype.new_union=function(r){const e=Object.create(N.prototype),t=Math.max(this.words.length,r.words.length);e.words=new Array(t);const n=Math.min(this.words.length,r.words.length);let s=0;for(;s+7<n;s+=8)e.words[s]=this.words[s]|r.words[s],e.words[s+1]=this.words[s+1]|r.words[s+1],e.words[s+2]=this.words[s+2]|r.words[s+2],e.words[s+3]=this.words[s+3]|r.words[s+3],e.words[s+4]=this.words[s+4]|r.words[s+4],e.words[s+5]=this.words[s+5]|r.words[s+5],e.words[s+6]=this.words[s+6]|r.words[s+6],e.words[s+7]=this.words[s+7]|r.words[s+7];for(;s<n;++s)e.words[s]=this.words[s]|r.words[s];const i=this.words.length;for(s=n;s<i;++s)e.words[s]=this.words[s];const o=r.words.length;for(s=n;s<o;++s)e.words[s]=r.words[s];return e},N.prototype.union_size=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(let n=0;n<e;++n)t+=this.hammingWeight(this.words[n]|r.words[n]);if(this.words.length<r.words.length){const n=r.words.length;for(let s=this.words.length;s<n;++s)t+=this.hammingWeight(0|r.words[s])}else{const n=this.words.length;for(let s=r.words.length;s<n;++s)t+=this.hammingWeight(0|this.words[s])}return t};var ae=N;function Jt(){return Jt=Object.assign||function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])}return r},Jt.apply(this,arguments)}function Co(r,e){var t=[];return r.forEach(function(n){e.forEach(function(s){t.push(n.concat(s))})}),t}function Dn(r){return!!~r.search(/\(|\)/)}function nn(r,e){for(var t=e.split(" "+r+" "),n=[],s=[],i=0;i<t.length;i++)if(Dn(t[i])||s.length>0){s.push(t[i]);var o=""+s;(o.match(/\(/g)||[]).length===(o.match(/\)/g)||[]).length&&(n.push(s.join(" "+r+" ")),s=[])}else n.push(t[i]);return n}var Eo=function r(e){return function(n){for(var s=n[0],i=1;i<n.length;i++)s=s.concat(n[i]);return s}(nn("OR",(t=e=function(n){if(n.charAt(0)==="("){for(var s=0,i=0;i<n.length;i++)if(n.charAt(i)==="("?s++:n.charAt(i)===")"&&s--,s===0)return i!==n.length-1?n:n.substring(1,n.length-1)}return n}(e),e=t.replace(/[\s]+/g," "))).map(function(n){for(var s=nn("AND",n),i=[],o=[],a=0;a<s.length;a++)Dn(s[a])?i.push(r(s[a])):o.push(s[a]);return i.push([o]),function(u){for(var c=[[]],h=0;h<u.length;h++)c=Co(c,u[h]);return c}(i)}));var t};const sn=function(r){try{return structuredClone(r)}catch{try{return JSON.parse(JSON.stringify(r))}catch{return r}}},on=function(r,e){let t=new ae([]),n=0;return B(e,function(s,i){s.forEach(o=>{++n,t=t.new_union(r[i][o]||new ae([]))})}),n===0?null:t},ko=function(r,e,t){let n=1;return B(r.bits_data_temp,(s,i)=>{let o,a,u,c,h,v,m;t[i]&&(o=t[i].order,a=t[i].sort,u=t[i].size,c=t[i].title,h=t[i].show_facet_stats||!1,v=t[i].chosen_filters_on_top!==!1,m=t[i].hide_zero_doc_count||!1);let p,y,w,A,F=Object.entries(s).map($=>{let X=[];e&&e.filters&&e.filters[i]&&(X=e.filters[i]);const I=$[1].array().length;if(!m||I!==0||X.indexOf($[0])!==-1)return{key:$[0],doc_count:I,selected:X.indexOf($[0])!==-1}}).filter(Boolean);var T,U;return ie(a)?(p=a||["key"],y=o||["asc"]):(a==="term"||a==="key"?(p=["key"],y=[o||"asc"]):(p=["doc_count","key"],y=[o||"desc","asc"]),v&&(p.unshift("selected"),y.unshift("desc"))),F=cr(F,p,y),F=F.slice(0,u||10),h&&(w=[],Object.entries(s).forEach($=>{if(isNaN($[0]))throw new Error("You cant use chars to calculate the facet_stats.");$[1].array().length>0&&$[1].forEach(()=>{w.push(parseInt($[0]))})}),A={min:(T=w,T&&T.length?Bn(T,De(void 0),yo):void 0),max:bo(w),avg:wo(w),sum:So(w)}),Jt({name:i,title:c||(U=i,U.replace(/^[\s_]+|[\s_]+$/g,"").replace(/[_\s]+/g," ").replace(/^[a-z]/,function($){return $.toUpperCase()})),position:n++,buckets:F},h&&{facet_stats:A})})};function an(r,e,t,n,s){e=e||Object.create(null);const i=parseInt(e.per_page||12),o=parseInt(e.page||1),a=e.is_all_filtered_items||!1;if(t.native_search_enabled===!1&&(e.query||e.filter))throw new Error('"query" and "filter" options are not working once native search is disabled');let u=0;const c=new Date().getTime();let h,v,m,p=s.bits_ids();if(e._ids)h=new ae(e._ids),v=e._ids;else if(e.ids)v=s.internal_ids_from_ids_map(e.ids),h=new ae(v);else if(n&&(e.query||e.filter)){const I=new Date().getTime();v=n.search(e.query,e.filter),u=new Date().getTime()-I,h=new ae(v)}let y=new Date().getTime();const w=s.search(e,{query_ids:h});y=new Date().getTime()-y,h&&(p=h),w.ids&&(p=p.new_intersection(w.ids)),w.not_ids&&(p=p.new_difference(w.not_ids));let A=p.array(),F=A.map(I=>s.get_item(I)),T=!1;const U=new Date().getTime();let $=0;e.sort?F=function(I,P,Y){return Y&&Y[P]&&(P=Y[P]),P.field?cr(I,P.field,P.order||"asc"):I}(F,e.sort,t.sortings):v&&(A=v.filter(I=>p.has(I)),F=A.slice((o-1)*i,o*i).map(I=>s.get_item(I)),T=!0),T||(m=a?F:null,F=F.slice((o-1)*i,o*i)),$=new Date().getTime()-U;const X=new Date().getTime()-c;return{pagination:{per_page:i,page:o,total:A.length},timings:{total:X,facets:y,search:u,sorting:$},data:{items:F,allFilteredItems:m,aggregations:ko(w,e,t.aggregations)}}}var pt=function(r){var e={exports:{}};return function(t,n){(function(){var s,i,o,a,u,c,h,v,m,p,y,w,A,F,T,U,$,X,I,P,Y,ce,be,te,le,ue,ge,de,x=function(l){var f=new x.Index;return f.pipeline.add(x.trimmer,x.stopWordFilter,x.stemmer),l&&l.call(f,f),f};x.version="1.0.0",x.utils={},x.utils.warn=function(l){return function(f){l.console&&console.warn&&console.warn(f)}}(this),x.utils.asString=function(l){return l==null?"":l.toString()},x.EventEmitter=function(){this.events={}},x.EventEmitter.prototype.addListener=function(){var l=Array.prototype.slice.call(arguments),f=l.pop(),_=l;if(typeof f!="function")throw new TypeError("last argument must be a function");_.forEach(function(C){this.hasHandler(C)||(this.events[C]=[]),this.events[C].push(f)},this)},x.EventEmitter.prototype.removeListener=function(l,f){if(this.hasHandler(l)){var _=this.events[l].indexOf(f);this.events[l].splice(_,1),this.events[l].length||delete this.events[l]}},x.EventEmitter.prototype.emit=function(l){if(this.hasHandler(l)){var f=Array.prototype.slice.call(arguments,1);this.events[l].forEach(function(_){_.apply(void 0,f)})}},x.EventEmitter.prototype.hasHandler=function(l){return l in this.events},x.tokenizer=function(l){return arguments.length&&l!=null&&l!=null?Array.isArray(l)?l.map(function(f){return x.utils.asString(f).toLowerCase()}):l.toString().trim().toLowerCase().split(x.tokenizer.separator):[]},x.tokenizer.separator=/[\s\-]+/,x.tokenizer.load=function(l){var f=this.registeredFunctions[l];if(!f)throw new Error("Cannot load un-registered function: "+l);return f},x.tokenizer.label="default",x.tokenizer.registeredFunctions={default:x.tokenizer},x.tokenizer.registerFunction=function(l,f){f in this.registeredFunctions&&x.utils.warn("Overwriting existing tokenizer: "+f),l.label=f,this.registeredFunctions[f]=l},x.Pipeline=function(){this._stack=[]},x.Pipeline.registeredFunctions={},x.Pipeline.registerFunction=function(l,f){f in this.registeredFunctions&&x.utils.warn("Overwriting existing registered function: "+f),l.label=f,x.Pipeline.registeredFunctions[l.label]=l},x.Pipeline.warnIfFunctionNotRegistered=function(l){l.label&&l.label in this.registeredFunctions||x.utils.warn(`Function is not registered with pipeline. This may cause problems when serialising the index.
`,l)},x.Pipeline.load=function(l){var f=new x.Pipeline;return l.forEach(function(_){var C=x.Pipeline.registeredFunctions[_];if(!C)throw new Error("Cannot load un-registered function: "+_);f.add(C)}),f},x.Pipeline.prototype.add=function(){Array.prototype.slice.call(arguments).forEach(function(l){x.Pipeline.warnIfFunctionNotRegistered(l),this._stack.push(l)},this)},x.Pipeline.prototype.after=function(l,f){x.Pipeline.warnIfFunctionNotRegistered(f);var _=this._stack.indexOf(l);if(_==-1)throw new Error("Cannot find existingFn");this._stack.splice(_+=1,0,f)},x.Pipeline.prototype.before=function(l,f){x.Pipeline.warnIfFunctionNotRegistered(f);var _=this._stack.indexOf(l);if(_==-1)throw new Error("Cannot find existingFn");this._stack.splice(_,0,f)},x.Pipeline.prototype.remove=function(l){var f=this._stack.indexOf(l);f!=-1&&this._stack.splice(f,1)},x.Pipeline.prototype.run=function(l){for(var f=[],_=l.length,C=this._stack.length,M=0;M<_;M++){for(var j=l[M],R=0;R<C&&(j=this._stack[R](j,M,l))!==void 0&&j!=="";R++);j!==void 0&&j!==""&&f.push(j)}return f},x.Pipeline.prototype.reset=function(){this._stack=[]},x.Pipeline.prototype.toJSON=function(){return this._stack.map(function(l){return x.Pipeline.warnIfFunctionNotRegistered(l),l.label})},x.Vector=function(){this._magnitude=null,this.list=void 0,this.length=0},x.Vector.Node=function(l,f,_){this.idx=l,this.val=f,this.next=_},x.Vector.prototype.insert=function(l,f){this._magnitude=void 0;var _=this.list;if(!_)return this.list=new x.Vector.Node(l,f,_),this.length++;if(l<_.idx)return this.list=new x.Vector.Node(l,f,_),this.length++;for(var C=_,M=_.next;M!=null;){if(l<M.idx)return C.next=new x.Vector.Node(l,f,M),this.length++;C=M,M=M.next}return C.next=new x.Vector.Node(l,f,M),this.length++},x.Vector.prototype.magnitude=function(){if(this._magnitude)return this._magnitude;for(var l,f=this.list,_=0;f;)_+=(l=f.val)*l,f=f.next;return this._magnitude=Math.sqrt(_)},x.Vector.prototype.dot=function(l){for(var f=this.list,_=l.list,C=0;f&&_;)f.idx<_.idx?f=f.next:(f.idx>_.idx||(C+=f.val*_.val,f=f.next),_=_.next);return C},x.Vector.prototype.similarity=function(l){return this.dot(l)/(this.magnitude()*l.magnitude())},x.SortedSet=function(){this.length=0,this.elements=[]},x.SortedSet.load=function(l){var f=new this;return f.elements=l,f.length=l.length,f},x.SortedSet.prototype.add=function(){var l,f;for(l=0;l<arguments.length;l++)~this.indexOf(f=arguments[l])||this.elements.splice(this.locationFor(f),0,f);this.length=this.elements.length},x.SortedSet.prototype.toArray=function(){return this.elements.slice()},x.SortedSet.prototype.map=function(l,f){return this.elements.map(l,f)},x.SortedSet.prototype.forEach=function(l,f){return this.elements.forEach(l,f)},x.SortedSet.prototype.indexOf=function(l){for(var f=0,_=this.elements.length,C=_-f,M=f+Math.floor(C/2),j=this.elements[M];C>1;){if(j===l)return M;j<l&&(f=M),j>l&&(_=M),C=_-f,M=f+Math.floor(C/2),j=this.elements[M]}return j===l?M:-1},x.SortedSet.prototype.locationFor=function(l){for(var f=0,_=this.elements.length,C=_-f,M=f+Math.floor(C/2),j=this.elements[M];C>1;)j<l&&(f=M),j>l&&(_=M),C=_-f,M=f+Math.floor(C/2),j=this.elements[M];return j>l?M:j<l?M+1:void 0},x.SortedSet.prototype.intersect=function(l){for(var f=new x.SortedSet,_=0,C=0,M=this.length,j=l.length,R=this.elements,J=l.elements;!(_>M-1||C>j-1);)R[_]!==J[C]?R[_]<J[C]?_++:R[_]>J[C]&&C++:(f.add(R[_]),_++,C++);return f},x.SortedSet.prototype.clone=function(){var l=new x.SortedSet;return l.elements=this.toArray(),l.length=l.elements.length,l},x.SortedSet.prototype.union=function(l){var f,_,C;this.length>=l.length?(f=this,_=l):(f=l,_=this),C=f.clone();for(var M=0,j=_.toArray();M<j.length;M++)C.add(j[M]);return C},x.SortedSet.prototype.toJSON=function(){return this.toArray()},x.Index=function(){this._fields=[],this._ref="id",this.pipeline=new x.Pipeline,this.documentStore=new x.Store,this.tokenStore=new x.TokenStore,this.corpusTokens=new x.SortedSet,this.eventEmitter=new x.EventEmitter,this.tokenizerFn=x.tokenizer,this._idfCache={},this.on("add","remove","update",(function(){this._idfCache={}}).bind(this))},x.Index.prototype.on=function(){var l=Array.prototype.slice.call(arguments);return this.eventEmitter.addListener.apply(this.eventEmitter,l)},x.Index.prototype.off=function(l,f){return this.eventEmitter.removeListener(l,f)},x.Index.load=function(l){l.version!==x.version&&x.utils.warn("version mismatch: current "+x.version+" importing "+l.version);var f=new this;return f._fields=l.fields,f._ref=l.ref,f.tokenizer(x.tokenizer.load(l.tokenizer)),f.documentStore=x.Store.load(l.documentStore),f.tokenStore=x.TokenStore.load(l.tokenStore),f.corpusTokens=x.SortedSet.load(l.corpusTokens),f.pipeline=x.Pipeline.load(l.pipeline),f},x.Index.prototype.field=function(l,f){return this._fields.push({name:l,boost:(f=f||{}).boost||1}),this},x.Index.prototype.ref=function(l){return this._ref=l,this},x.Index.prototype.tokenizer=function(l){return l.label&&l.label in x.tokenizer.registeredFunctions||x.utils.warn("Function is not a registered tokenizer. This may cause problems when serialising the index"),this.tokenizerFn=l,this},x.Index.prototype.add=function(l,f){var _={},C=new x.SortedSet,M=l[this._ref];f=f===void 0||f,this._fields.forEach(function(He){var Ae=this.pipeline.run(this.tokenizerFn(l[He.name]));_[He.name]=Ae;for(var je=0;je<Ae.length;je++){var Le=Ae[je];C.add(Le),this.corpusTokens.add(Le)}},this),this.documentStore.set(M,C);for(var j=0;j<C.length;j++){for(var R=C.elements[j],J=0,z=0;z<this._fields.length;z++){var we=this._fields[z],Pe=_[we.name],he=Pe.length;if(he){for(var xe=0,Ce=0;Ce<he;Ce++)Pe[Ce]===R&&xe++;J+=xe/he*we.boost}}this.tokenStore.add(R,{ref:M,tf:J})}f&&this.eventEmitter.emit("add",l,this)},x.Index.prototype.remove=function(l,f){var _=l[this._ref];if(f=f===void 0||f,this.documentStore.has(_)){var C=this.documentStore.get(_);this.documentStore.remove(_),C.forEach(function(M){this.tokenStore.remove(M,_)},this),f&&this.eventEmitter.emit("remove",l,this)}},x.Index.prototype.update=function(l,f){f=f===void 0||f,this.remove(l,!1),this.add(l,!1),f&&this.eventEmitter.emit("update",l,this)},x.Index.prototype.idf=function(l){var f="@"+l;if(Object.prototype.hasOwnProperty.call(this._idfCache,f))return this._idfCache[f];var _=this.tokenStore.count(l),C=1;return _>0&&(C=1+Math.log(this.documentStore.length/_)),this._idfCache[f]=C},x.Index.prototype.search=function(l){var f=this.pipeline.run(this.tokenizerFn(l)),_=new x.Vector,C=[],M=this._fields.reduce(function(j,R){return j+R.boost},0);return f.some(function(j){return this.tokenStore.has(j)},this)?(f.forEach(function(j,R,J){var z=1/J.length*this._fields.length*M,we=this,Pe=this.tokenStore.expand(j).reduce(function(he,xe){var Ce=we.corpusTokens.indexOf(xe),He=we.idf(xe),Ae=1,je=new x.SortedSet;if(xe!==j){var Le=Math.max(3,xe.length-j.length);Ae=1/Math.log(Le)}Ce>-1&&_.insert(Ce,z*He*Ae);for(var qe=we.tokenStore.get(xe),ot=Object.keys(qe),Mt=ot.length,Xe=0;Xe<Mt;Xe++)je.add(qe[ot[Xe]].ref);return he.union(je)},new x.SortedSet);C.push(Pe)},this),C.reduce(function(j,R){return j.intersect(R)}).map(function(j){return{ref:j,score:_.similarity(this.documentVector(j))}},this).sort(function(j,R){return R.score-j.score})):[]},x.Index.prototype.documentVector=function(l){for(var f=this.documentStore.get(l),_=f.length,C=new x.Vector,M=0;M<_;M++){var j=f.elements[M],R=this.tokenStore.get(j)[l].tf,J=this.idf(j);C.insert(this.corpusTokens.indexOf(j),R*J)}return C},x.Index.prototype.toJSON=function(){return{version:x.version,fields:this._fields,ref:this._ref,tokenizer:this.tokenizerFn.label,documentStore:this.documentStore.toJSON(),tokenStore:this.tokenStore.toJSON(),corpusTokens:this.corpusTokens.toJSON(),pipeline:this.pipeline.toJSON()}},x.Index.prototype.use=function(l){var f=Array.prototype.slice.call(arguments,1);f.unshift(this),l.apply(this,f)},x.Store=function(){this.store={},this.length=0},x.Store.load=function(l){var f=new this;return f.length=l.length,f.store=Object.keys(l.store).reduce(function(_,C){return _[C]=x.SortedSet.load(l.store[C]),_},{}),f},x.Store.prototype.set=function(l,f){this.has(l)||this.length++,this.store[l]=f},x.Store.prototype.get=function(l){return this.store[l]},x.Store.prototype.has=function(l){return l in this.store},x.Store.prototype.remove=function(l){this.has(l)&&(delete this.store[l],this.length--)},x.Store.prototype.toJSON=function(){return{store:this.store,length:this.length}},x.stemmer=(s={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},i={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},c="^("+(a="[^aeiou][^aeiouy]*")+")?"+(u=(o="[aeiouy]")+"[aeiou]*")+a+"("+u+")?$",h="^("+a+")?"+u+a+u+a,v="^("+a+")?"+o,m=new RegExp("^("+a+")?"+u+a),p=new RegExp(h),y=new RegExp(c),w=new RegExp(v),A=/^(.+?)(ss|i)es$/,F=/^(.+?)([^s])s$/,T=/^(.+?)eed$/,U=/^(.+?)(ed|ing)$/,$=/.$/,X=/(at|bl|iz)$/,I=new RegExp("([^aeiouylsz])\\1$"),P=new RegExp("^"+a+o+"[^aeiouwxy]$"),Y=/^(.+?[^aeiou])y$/,ce=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/,be=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,te=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/,le=/^(.+?)(s|t)(ion)$/,ue=/^(.+?)e$/,ge=/ll$/,de=new RegExp("^"+a+o+"[^aeiouwxy]$"),function(l){var f,_,C,M,j,R,J;if(l.length<3)return l;if((C=l.substr(0,1))=="y"&&(l=C.toUpperCase()+l.substr(1)),j=F,(M=A).test(l)?l=l.replace(M,"$1$2"):j.test(l)&&(l=l.replace(j,"$1$2")),j=U,(M=T).test(l)){var z=M.exec(l);(M=m).test(z[1])&&(l=l.replace(M=$,""))}else j.test(l)&&(z=j.exec(l),(j=w).test(f=z[1])&&(R=I,J=P,(j=X).test(l=f)?l+="e":R.test(l)?l=l.replace(M=$,""):J.test(l)&&(l+="e")));return(M=Y).test(l)&&(l=(f=(z=M.exec(l))[1])+"i"),(M=ce).test(l)&&(_=(z=M.exec(l))[2],(M=m).test(f=z[1])&&(l=f+s[_])),(M=be).test(l)&&(_=(z=M.exec(l))[2],(M=m).test(f=z[1])&&(l=f+i[_])),j=le,(M=te).test(l)?(z=M.exec(l),(M=p).test(f=z[1])&&(l=f)):j.test(l)&&(z=j.exec(l),(j=p).test(f=z[1]+z[2])&&(l=f)),(M=ue).test(l)&&(z=M.exec(l),j=y,R=de,((M=p).test(f=z[1])||j.test(f)&&!R.test(f))&&(l=f)),j=p,(M=ge).test(l)&&j.test(l)&&(l=l.replace(M=$,"")),C=="y"&&(l=C.toLowerCase()+l.substr(1)),l}),x.Pipeline.registerFunction(x.stemmer,"stemmer"),x.generateStopWordFilter=function(l){var f=l.reduce(function(_,C){return _[C]=C,_},{});return function(_){if(_&&f[_]!==_)return _}},x.stopWordFilter=x.generateStopWordFilter(["a","able","about","across","after","all","almost","also","am","among","an","and","any","are","as","at","be","because","been","but","by","can","cannot","could","dear","did","do","does","either","else","ever","every","for","from","get","got","had","has","have","he","her","hers","him","his","how","however","i","if","in","into","is","it","its","just","least","let","like","likely","may","me","might","most","must","my","neither","no","nor","not","of","off","often","on","only","or","other","our","own","rather","said","say","says","she","should","since","so","some","than","that","the","their","them","then","there","these","they","this","tis","to","too","twas","us","wants","was","we","were","what","when","where","which","while","who","whom","why","will","with","would","yet","you","your"]),x.Pipeline.registerFunction(x.stopWordFilter,"stopWordFilter"),x.trimmer=function(l){return l.replace(/^\W+/,"").replace(/\W+$/,"")},x.Pipeline.registerFunction(x.trimmer,"trimmer"),x.TokenStore=function(){this.root={docs:{}},this.length=0},x.TokenStore.load=function(l){var f=new this;return f.root=l.root,f.length=l.length,f},x.TokenStore.prototype.add=function(l,f,_){_=_||this.root;var C=l.charAt(0),M=l.slice(1);return C in _||(_[C]={docs:{}}),M.length===0?(_[C].docs[f.ref]=f,void(this.length+=1)):this.add(M,f,_[C])},x.TokenStore.prototype.has=function(l){if(!l)return!1;for(var f=this.root,_=0;_<l.length;_++){if(!f[l.charAt(_)])return!1;f=f[l.charAt(_)]}return!0},x.TokenStore.prototype.getNode=function(l){if(!l)return{};for(var f=this.root,_=0;_<l.length;_++){if(!f[l.charAt(_)])return{};f=f[l.charAt(_)]}return f},x.TokenStore.prototype.get=function(l,f){return this.getNode(l,f).docs||{}},x.TokenStore.prototype.count=function(l,f){return Object.keys(this.get(l,f)).length},x.TokenStore.prototype.remove=function(l,f){if(l){for(var _=this.root,C=0;C<l.length;C++){if(!(l.charAt(C)in _))return;_=_[l.charAt(C)]}delete _.docs[f]}},x.TokenStore.prototype.expand=function(l,f){var _=this.getNode(l);return f=f||[],Object.keys(_.docs||{}).length&&f.push(l),Object.keys(_).forEach(function(C){C!=="docs"&&f.concat(this.expand(l+C,f))},this),f},x.TokenStore.prototype.toJSON=function(){return{root:this.root,length:this.length}},t.exports=x})()}(e),e.exports}();class ln{constructor(e,t){this.store=new Map,this.idx=pt(function(){this.field("name",{boost:10}),((t==null?void 0:t.searchableFields)||[]).forEach(s=>this.field(s)),this.ref("_id"),t!=null&&t.isExactSearch&&(this.pipeline.remove(pt.stemmer),this.pipeline.remove(pt.stopWordFilter)),t!=null&&t.removeStopWordFilter&&this.pipeline.remove(pt.stopWordFilter)});let n=1;(e||[]).map(s=>{s._id=n,++n,this.idx.add(s),this.store.set(s._id,s)})}search_full(e,t){return this.search(e,t).map(n=>this.store.get(n))}search(e,t){return t instanceof Function?(e?this.idx.search(e).map(n=>this.store.get(n.ref)):[...this.store.values()]).filter(t).map(n=>n._id):e?this.idx.search(e).map(n=>n.ref):[...this.store.keys()]}}class cn{constructor(e,t){(t=t||Object.create(null)).aggregations=t.aggregations||Object.create(null),this._items=e,this.config=t.aggregations,this.facets=function(o,a){a=a||[];const u={data:Object.create(null),bits_data:Object.create(null),bits_data_temp:Object.create(null)};let c=1;return a.forEach(h=>{u.data[h]=Object.create(null)}),o&&o.map(h=>(h._id||(h._id=c,++c),h)),o&&o.map(h=>(a.forEach(v=>{if(h){if(Array.isArray(h[v]))h[v].forEach(m=>{h[v]&&(u.data[v][m]||(u.data[v][m]=[]),u.data[v][m].push(parseInt(h._id)))});else if(h[v]!==void 0){const m=h[v];u.data[v][m]||(u.data[v][m]=[]),u.data[v][m].push(parseInt(h._id))}}}),h)),u.data=B(u.data,function(h,v){return u.bits_data[v]||(u.bits_data[v]=Object.create(null),u.bits_data_temp[v]=Object.create(null)),B(h,function(m,p){const y=_o(m);return u.bits_data[v][p]=new ae(y),y})}),u}(e,it(t.aggregations)),this._items_map=Object.create(null),this._ids=[];let n=1;var s,i;i=o=>{this._ids.push(n),this._items_map[n]=o,o._id=n,++n},(ie(s=e)?Ve:Tn)(s,De(i)),this.ids_map=Object.create(null),e&&e.forEach(o=>{const a=t.custom_id_field||"id";o[a]&&o._id&&(this.ids_map[o[a]]=o._id)}),this._bits_ids=new ae(this._ids)}items(){return this._items}bits_ids(e){return e?new ae(e):this._bits_ids}internal_ids_from_ids_map(e){return e.map(t=>this.ids_map[t])}index(){return this.facets}get_item(e){return this._items_map[e]}search(e,t){const n=this.config;t=t||Object.create(null);const s=Dt(this.facets);let i;s.not_ids=on(s.bits_data,e.not_filters);const o=function(a,u){const c=[];return B(a.filters,function(h,v){if(h&&h.length)if(u[v].conjunction!==!1)B(h,function(m){c.push([v,m])});else{const m=[];B(h,function(p){m.push([v,p])}),c.push(m)}}),B(a.not_filters,function(h,v){h&&h.length&&B(h,function(m){c.push([v,"-",m])})}),c}(e,n);return i=function(a,u){const c=Dt(a);let h;u=u||[],B(c.bits_data,function(m,p){B(c.bits_data[p],function(y,w){c.bits_data_temp[p][w]=c.bits_data[p][w]})}),c.is_temp_copied=!0;const v=function(m,p){const y=Object.create(null);return B(p,function(w){if(Array.isArray(w[0])){let A=new ae([]);B(w,function(F){const T=F[0];A=A.new_union(m.bits_data[T][F[1]]||new ae([])),y[T]=A})}}),y}(a,u);return B(u,function(m){if(!Array.isArray(m[0])){const p=m[0],y=m[1];h=h&&c.bits_data_temp[p][y]?c.bits_data_temp[p][y].new_intersection(h):h&&!c.bits_data_temp[p][y]?new ae([]):c.bits_data_temp[p][y]}}),h&&B(c.bits_data_temp,function(m,p){B(c.bits_data_temp[p],function(y,w){c.bits_data_temp[p][w]=c.bits_data_temp[p][w].new_intersection(h)})}),B(u,function(m){if(m.length===3&&m[1]==="-"){const p=c.bits_data_temp[m[0]][m[2]].clone();B(c.bits_data_temp,function(y,w){B(c.bits_data_temp[w],function(A,F){c.bits_data_temp[w][F]=c.bits_data_temp[w][F].new_difference(p)})})}}),B(c.bits_data_temp,function(m,p){B(c.bits_data_temp[p],function(y,w){B(v,function(A,F){F!==p&&(c.bits_data_temp[p][w]=c.bits_data_temp[p][w].new_intersection(A))})})}),c}(this.facets,o),e.filters_query&&(i=function(a,u){const c=Dt(a);c.is_temp_copied||B(c.bits_data,function(v,m){B(c.bits_data[m],function(p,y){c.bits_data_temp[m][y]=c.bits_data[m][y]})});let h=null;return B(u,function(v){let m=null;B(v,function(p){const y=p[0],w=p[1];if(!c.bits_data_temp[y])throw new Error("Panic. The key does not exist in facets lists.");m=m&&c.bits_data_temp[y][w]?c.bits_data_temp[y][w].new_intersection(m):m&&!c.bits_data_temp[y][w]?new ae([]):c.bits_data_temp[y][w]}),h=(h||new ae([])).new_union(m||new ae([]))}),h!==null&&B(c.bits_data_temp,function(v,m){B(c.bits_data_temp[m],function(p,y){c.bits_data_temp[m][y]=c.bits_data_temp[m][y].new_intersection(h)})}),c}(i,Eo(e.filters_query).map(a=>Array.isArray(a)?a.map(u=>Array.isArray(u)?u.map(c=>c):u.split(":")):a.split(":")))),s.bits_data_temp=i.bits_data_temp,B(s.bits_data_temp,function(a,u){B(s.bits_data_temp[u],function(c,h){t.query_ids&&(s.bits_data_temp[u][h]=t.query_ids.new_intersection(s.bits_data_temp[u][h])),t.test&&(s.data[u][h]=s.bits_data_temp[u][h].array())})}),s.ids=e.filters_query?function(a){let u=new ae([]);return B(a,function(c,h){B(a[h],function(v,m){u=u.new_union(a[h][m])})}),u}(s.bits_data_temp):on(s.bits_data_temp,e.filters),s}}function Mo(r,e){let t;(e=e||Object.create(null)).native_search_enabled!==!1&&(t=new ln(r,e));let n=new cn(r,e);return{search:function(s){return(s=s||Object.create(null)).aggregations=function(i,o){return B(sn(i),(a,u)=>{a.field||(a.field=u);let c=[];o.filters&&o.filters[u]&&(c=o.filters[u]),a.filters=c;let h=[];return o.not_filters&&o.not_filters[u]&&(h=o.not_filters[u]),o.exclude_filters&&o.exclude_filters[u]&&(h=o.exclude_filters[u]),a.not_filters=h,a})}(e.aggregations,s),an(0,s,e,t,n)},similar:function(s,i){return function(o,a,u){const c=u.per_page||10,h=u.minimum||0,v=u.page||1;let m;for(let w=0;w<o.length;++w)if(o[w].id==a){m=o[w];break}if(!u.field)throw new Error("Please define field in options");const p=u.field;let y=[];for(let w=0;w<o.length;++w)if(o[w].id!==a){const A=vo(m[p],o[w][p]);A.length>=h&&(y.push(o[w]),y[y.length-1].intersection_length=A.length)}return y=cr(y,["intersection_length"],["desc"]),{pagination:{per_page:c,page:v,total:y.length},data:{items:y.slice((v-1)*c,v*c)}}}(r,s,i)},aggregation:function(s){return function(i,o,a,u,c){const h=o.per_page||10,v=o.page||1;if(o.name&&(!a.aggregations||!a.aggregations[o.name]))throw new Error('Please define aggregation "'.concat(o.name,'" in config'));const m=sn(o);if(m.page=1,m.per_page=0,!o.name)throw new Error("field name is required");a.aggregations[o.name].size=1e4;const p=an(0,m,a,u,c).data.aggregations[o.name].buckets;return{pagination:{per_page:h,page:v,total:p.length},data:{buckets:p.slice((v-1)*h,v*h)}}}(0,s,e,t,n)},reindex:function(s){t=new ln(r=s,e),n=new cn(r,e)}}}const ve={showElement(r){r&&(r.classList.remove("hidden"),r.style.opacity="1")},hideElement(r){r&&(r.classList.add("hidden"),r.style.opacity="0")},escapeHtml(r){const e=document.createElement("div");return e.textContent=r,e.innerHTML},waitForGlobal(r,e,t=1e4){const n=Date.now(),s=setInterval(()=>{window[r]?(e(window[r]),clearInterval(s)):Date.now()-n>t&&(console.warn(`Timeout waiting for ${r}`),clearInterval(s))},100)}},Ao={positionPopup(r,e,t={}){const{offset:n=10,maxWidth:s=288,placement:i="above"}=t,o=e.getBoundingClientRect();r.style.left=`${o.left}px`,i==="above"?r.style.bottom=`${window.innerHeight-o.top+n}px`:r.style.top=`${o.bottom+n}px`,o.left+s>window.innerWidth&&(r.style.left=`${window.innerWidth-s-16}px`)}},Oe={emit(r,e={},t=document){const n=new CustomEvent(r,{detail:e,bubbles:!0,cancelable:!0});t.dispatchEvent(n)},createOutsideClickHandler(r,e,t){return n=>{!r.contains(n.target)&&!e.contains(n.target)&&t()}},createEscapeKeyHandler(r){return e=>{e.key==="Escape"&&r()}}},jo={calculateActiveFiltersCount(r){if(!r||typeof r!="object")return 0;let e=0;return Object.values(r).forEach(t=>{Array.isArray(t)?t.length===2&&typeof t[0]=="number"&&typeof t[1]=="number"?e+=1:e+=t.length:t&&typeof t=="object"&&(t.min!==void 0||t.max!==void 0)&&(e+=1)}),e},formatRangeFilter(r){return r.min!==void 0&&r.max!==void 0?`${r.min} - ${r.max}`:r.min!==void 0?`≥ ${r.min}`:r.max!==void 0?`≤ ${r.max}`:"Range filter"},getFacetLabel(r,e){return e&&e.aggregations&&e.aggregations[r]?e.aggregations[r].title||r:r.replace(/[_-]/g," ").replace(/\b\w/g,t=>t.toUpperCase())}},un={getNotificationClasses(r){const e={success:"bg-green-500 text-white",error:"bg-red-500 text-white",warning:"bg-yellow-500 text-white",info:"bg-primary-500 text-white"};return e[r]||e.info},show(r,e="info",t=3e3){const n=document.createElement("div");n.className=`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg shadow-lg ${this.getNotificationClasses(e)}`,n.style.opacity="1",n.textContent=r,document.body.appendChild(n),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},t)}},gt={resetFacetsInterface(){const r=document.getElementById("facets-container");r&&(r.querySelectorAll('input[type="checkbox"]').forEach(e=>e.checked=!1),r.querySelectorAll('[id$="-slider"]').forEach(e=>{if(e.noUiSlider)try{const t=e.noUiSlider.options.range;e.noUiSlider.set([t.min,t.max]);const n=e.id.replace("-slider",""),s=document.getElementById(`${n}-min-input`),i=document.getElementById(`${n}-max-input`);s&&(s.value=t.min),i&&(i.value=t.max)}catch(t){console.warn(`Failed to reset slider ${e.id}:`,t)}}),r.querySelectorAll(".toggle-btn").forEach(e=>{const t=e.dataset.path,n=r.querySelector(`[data-parent="${t}"]`);n&&n.style.display!=="none"&&(n.style.display="none",e.textContent="▶")}))},clearSearchInput(){const r=["#search-input","#query-input",".search-input",'input[type="search"]','input[placeholder*="search" i]','input[placeholder*="cerca" i]'];for(const e of r){const t=document.querySelector(e);if(t){t.value="",t.dispatchEvent(new Event("input",{bubbles:!0}));break}}}};class ur{constructor(e,t){this.triggerId=e,this.popupId=t,this.triggerElement=null,this.isOpen=!1,this.outsideClickHandler=null,this.escapeKeyHandler=null}init(){if(this.triggerElement=document.getElementById(this.triggerId),!this.triggerElement){console.warn(`Trigger element ${this.triggerId} not found`);return}this.triggerElement.style.cursor="pointer",this.triggerElement.addEventListener("click",e=>{e.stopPropagation(),this.toggle()})}toggle(){this.isOpen?this.hide():this.show()}show(){if(this.isOpen)return;const e=this.createPopup();e&&(document.body.appendChild(e),this.isOpen=!0,this.bindEvents(e))}hide(){const e=document.getElementById(this.popupId);e&&e.parentNode&&e.parentNode.removeChild(e),this.cleanup(),this.isOpen=!1}createPopup(){throw new Error("createPopup must be implemented by subclass")}bindEvents(e){const t=e.querySelector(`#close-${this.popupId}`);t&&t.addEventListener("click",()=>this.hide()),this.outsideClickHandler=Oe.createOutsideClickHandler(e,this.triggerElement,()=>this.hide()),document.addEventListener("click",this.outsideClickHandler),this.escapeKeyHandler=Oe.createEscapeKeyHandler(()=>this.hide()),document.addEventListener("keydown",this.escapeKeyHandler)}cleanup(){this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler),this.outsideClickHandler=null),this.escapeKeyHandler&&(document.removeEventListener("keydown",this.escapeKeyHandler),this.escapeKeyHandler=null)}createBasePopup(e){const t=document.createElement("div");t.id=this.popupId,t.className="fixed p-2 w-72 max-w-sm bg-white rounded-lg shadow-2xl border border-gray-200 max-h-96 overflow-hidden",t.style.zIndex="9999",Ao.positionPopup(t,this.triggerElement);const n=document.createElement("div");return n.className="flex items-center justify-between mb-2",n.innerHTML=`
            <h3 class="p-2 text-sm font-semibold text-gray-800">${e}</h3>
            <button id="close-${this.popupId}" class="absolute top-2 right-2 p-1.5 bg-pink-100 hover:bg-pink-200 active:bg-pink-200 rounded-full text-red-500 shadow-md hover:shadow-lg group">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        `,t.appendChild(n),t}destroy(){this.hide(),this.cleanup()}}class Lo extends ur{constructor(e){super("active-filters-badge","active-filters-popup"),this.navBar=e}init(){super.init(),this.triggerElement&&(this.triggerElement.title="Clicca per vedere i filtri attivi")}createPopup(){const e=this.createBasePopup("Filtri Attivi"),t=document.createElement("div");return t.className="space-y-1 max-h-64 overflow-y-auto overflow-x-hidden",t.innerHTML=this.buildFiltersContent(),e.appendChild(t),e}buildFiltersContent(){const{currentFilters:e,currentQuery:t,config:n}=this.navBar;if(!e||Object.keys(e).length===0)return`
                <div class="flex items-center p-4 rounded-lg bg-gray-50">
                    <span class="text-sm text-gray-700">Nessun filtro attivo</span>
                </div>
            `;let s="";t&&t.trim()&&(s+=`
                <div class="mb-3 p-3 rounded-lg bg-primary-50 border border-primary-100">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 text-primary-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <div class="flex-1 min-w-0">
                            <span class="text-sm font-medium text-primary-700">Ricerca:</span>
                            <span class="text-sm text-primary-600 ml-1 font-mono bg-primary-100 px-2 py-1 rounded text-xs">"${ve.escapeHtml(t)}"</span>
                        </div>
                    </div>
                </div>
            `);const i=this.groupFiltersByCategory();return Object.entries(i).forEach(([o,a])=>{s+=this.buildCategorySection(o,a)}),s||`
            <div class="flex items-center p-4 rounded-lg bg-gray-50">
                <span class="text-sm text-gray-700">Nessun filtro attivo</span>
            </div>
        `}groupFiltersByCategory(){const{currentFilters:e,config:t}=this.navBar,n={};return Object.entries(e).forEach(([s,i])=>{if(!i||Array.isArray(i)&&i.length===0)return;const o=this.getFacetLabel(s);n[o]||(n[o]=[]),this.processFilterValues(n[o],i,s)}),n}processFilterValues(e,t,n){Array.isArray(t)?t.length===2&&typeof t[0]=="number"&&typeof t[1]=="number"?e.push({type:"range",value:this.formatRangeFilter({min:t[0],max:t[1]}),facetKey:n}):t.forEach(s=>{e.push({type:"value",value:s,facetKey:n})}):typeof t=="object"&&e.push({type:"range",value:this.formatRangeFilter(t),facetKey:n})}buildCategorySection(e,t){let n=`
            <div class="mb-3 p-3 rounded-lg bg-gray-50 border border-gray-200">
                <div class="flex items-start">
                    <div class="w-2 h-2 rounded-full bg-indigo-500 mt-2 mr-3 flex-shrink-0"></div>
                    <div class="flex-1 min-w-0">
                        <h4 class="text-sm font-semibold text-gray-800 mb-2">${e}</h4>
                        <div class="flex flex-wrap gap-1.5">
        `;return t.forEach(s=>{const i=s.type==="range",o=i?"bg-orange-100 text-orange-700 border-orange-200":"bg-indigo-100 text-indigo-700 border-indigo-200",a=this.getFilterIcon(i);n+=`
                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border ${o} hover:shadow-sm">
                    ${a}
                    ${ve.escapeHtml(s.value)}
                </span>
            `}),n+=`
                        </div>
                    </div>
                </div>
            </div>
        `,n}getFilterIcon(e){return e?`<svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
            </svg>`:`<svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>`}getFacetLabel(e){const{config:t}=this.navBar;return t&&t.aggregations&&t.aggregations[e]?t.aggregations[e].title||e:e.replace(/[_-]/g," ").replace(/\b\w/g,n=>n.toUpperCase())}formatRangeFilter(e){return e.min!==void 0&&e.max!==void 0?`${e.min} - ${e.max}`:e.min!==void 0?`≥ ${e.min}`:e.max!==void 0?`≤ ${e.max}`:"Range filter"}}class Fo extends ur{constructor(e){super("map-layer-selector","layer-selection-popup"),this.layers=e,this.currentLayerName="Default",this.currentTileLayer=null}init(){super.init(),this.triggerElement&&(this.triggerElement.title="Clicca per cambiare layer",this.updateButtonText(this.currentLayerName))}createPopup(){const e=this.createBasePopup("Seleziona Layer"),t=document.createElement("div");return t.className="space-y-1 max-h-64 overflow-y-auto overflow-x-hidden mb-3 p-3 rounded-lg bg-gray-50 border border-gray-200",t.innerHTML=this.buildLayersContent(),e.appendChild(t),e}buildLayersContent(){let e="";for(let t in this.layers){const n=t===this.currentLayerName,s=this.layers[t];e+=`
                <div class="layer-item flex items-center justify-between p-2 rounded hover:bg-gray-100 cursor-pointer" 
                    data-layer-name="${t}" 
                    data-layer-url="${s.tileLayer}"
                    data-layer-attribution="${s.attribution}">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-700">${t}</span>
                    </div>
                    <div class="flex items-center">
                        ${n?`
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                        `:""}
                    </div>
                </div>
            `}return e}bindEvents(e){super.bindEvents(e),e.querySelectorAll(".layer-item").forEach(n=>{n.addEventListener("click",s=>{const i=n.dataset.layerName,o=n.dataset.layerUrl,a=n.dataset.layerAttribution;this.selectLayer(i,o,a),this.hide()})})}selectLayer(e,t,n){this.updateButtonText(e),this.currentTileLayer&&window.map&&window.map.removeLayer(this.currentTileLayer),window.L&&window.map&&(this.currentTileLayer=window.L.tileLayer(t,{attribution:n,maxZoom:18}),this.currentTileLayer.addTo(window.map)),this.currentLayerName=e,Oe.emit("layerChanged",{layerName:e,layerUrl:t,attribution:n})}updateButtonText(e){const t=this.triggerElement.querySelector("i")||this.triggerElement.querySelector(".icon");t?(this.triggerElement.innerHTML="",this.triggerElement.appendChild(t),this.triggerElement.appendChild(document.createTextNode("Strati cartografici"))):this.triggerElement.textContent=e}}class Io extends ur{constructor(e){super("map-markers-selector","markers-selection-popup"),this.mapInstance=e,this.currentMarkerType="clusters",this.markerTypes={clusters:{name:"Clusters geografici",description:"Raggruppamenti dinamici"},pins:{name:"Pin con numeri",description:"Pin con conteggio occorrenze"},circles:{name:"Cerchi Proporzionali",description:"Cerchi con diametro basato su occorrenze"}}}init(){super.init(),this.triggerElement&&(this.triggerElement.title="Clicca per cambiare tipo di marker",this.updateButtonText(this.markerTypes[this.currentMarkerType].name))}createPopup(){const e=this.createBasePopup("Tipo di Marker"),t=document.createElement("div");return t.className="space-y-1 max-h-64 overflow-y-auto overflow-x-hidden",t.innerHTML=this.buildMarkersContent(),e.appendChild(t),e}buildMarkersContent(){let e="";for(let t in this.markerTypes){const n=t===this.currentMarkerType,s=this.markerTypes[t],i=this.getMarkerIcon(t);e+=`
                <div class="marker-item flex items-center justify-between p-2 rounded hover:bg-gray-50 hover:shadow-md cursor-pointer" 
                     data-marker-type="${t}">
                    <div class="flex items-center space-x-3">
                        ${i}
                        <div>
                            <span class="text-sm font-medium text-gray-700">${s.name}</span>
                            <p class="text-xs text-gray-500">${s.description}</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        ${n?`
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                        `:""}
                    </div>
                </div>
            `}return e}getMarkerIcon(e){const t={clusters:`
                <svg class="w-4 h-4 text-primary-500" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"></path>
                </svg>
            `,pins:`
                <svg class="w-4 h-4 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                </svg>
            `,circles:`
                <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm0-2a6 6 0 100-12 6 6 0 000 12z" clip-rule="evenodd"></path>
                </svg>
            `};return t[e]||t.clusters}bindEvents(e){super.bindEvents(e),e.querySelectorAll(".marker-item").forEach(n=>{n.addEventListener("click",s=>{const i=n.dataset.markerType;this.selectMarkerType(i),this.hide()})})}selectMarkerType(e){this.updateButtonText(this.markerTypes[e].name),this.currentMarkerType=e,window.switchMarkerType?window.switchMarkerType(e):this.mapInstance&&this.mapInstance.switchMarkerType?this.mapInstance.switchMarkerType(e):console.warn("No switchMarkerType function available"),Oe.emit("markerTypeChanged",{markerType:e,markerName:this.markerTypes[e].name})}updateButtonText(e){const t=this.triggerElement.querySelector("i")||this.triggerElement.querySelector(".icon");t?(this.triggerElement.innerHTML="",this.triggerElement.appendChild(t),this.triggerElement.appendChild(document.createTextNode(` ${e}`))):this.triggerElement.textContent=e}}class Oo{constructor(){this.elements={},this.state={activeFiltersCount:0,resultsCount:0,uniqueResultsCount:0,isInitialized:!1,isMobileMenuOpen:!1},this.currentFilters={},this.currentQuery="",this.config=null,this.mapInstance=null,this.popupManagers={activeFilters:null,layers:null,markers:null},this.init()}init(){this.initializeElements(),this.initializeConfiguration(),this.initializePanelStates(),this.createMobileMenu(),this.bindEventHandlers(),this.setupResponsiveBehavior(),this.styleClearAllButton(),this.state.isInitialized=!0}initializeElements(){this.elements={filtersPanel:document.getElementById("filters-panel"),resultsPanel:document.getElementById("results-panel"),toggleFilters:document.getElementById("toggle-filters"),toggleResults:document.getElementById("toggle-results"),activeFiltersBadge:document.getElementById("active-filters-badge"),activeFiltersCount:document.getElementById("active-filters-count"),resultsCounter:document.getElementById("results-counter"),resultsCount:document.getElementById("results-count"),uniqueResultsCounter:document.getElementById("unique-results-counter"),uniqueResultsCount:document.getElementById("unique-results-count"),clearAllBtn:document.getElementById("clear-all-btn"),layerButton:document.getElementById("map-layer-selector"),markersButton:document.getElementById("map-markers-selector"),toggleLegendBtn:document.getElementById("toggle-legend-btn")}}createMobileMenu(){const e=document.createElement("button");e.id="mobile-menu-toggle",e.className="md:hidden p-2 text-gray-600 hover:text-gray-800 focus:outline-none",e.innerHTML=`
            <div class="w-6 h-6 flex flex-col justify-center items-center">
                <span class="block w-5 h-0.5 bg-current mb-1 transition-all duration-200"></span>
                <span class="block w-5 h-0.5 bg-current mb-1 transition-all duration-200"></span>
                <span class="block w-5 h-0.5 bg-current transition-all duration-200"></span>
            </div>
        `;const t=document.createElement("div");t.id="mobile-menu",t.className="md:hidden fixed inset-0 bg-black bg-opacity-50 z-50 hidden";const n=document.createElement("div");n.className="fixed top-0 right-0 h-full w-80 bg-white shadow-lg transform translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto",n.innerHTML=`
            <div class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Pannello di Controllo</h3>
                    <button id="mobile-menu-close" class="p-2 text-gray-600 hover:text-gray-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-4 space-y-4">
                <div id="mobile-menu-items" class="space-y-3"></div>
            </div>
        `,t.appendChild(n);const s=document.querySelector('nav, .navbar, [role="navigation"]')||document.body.firstElementChild;s&&(s.appendChild(e),document.body.appendChild(t)),this.elements.hamburgerBtn=e,this.elements.mobileMenu=t,this.elements.mobileMenuContent=n,this.elements.mobileMenuItems=document.getElementById("mobile-menu-items"),this.populateMobileMenu()}populateMobileMenu(){if(!this.elements.mobileMenuItems)return;this.originalPositions={};const e=document.createElement("div");e.className="mobile-group mb-4 pb-4";const t=document.createElement("div");t.className="flex gap-4";const n=document.createElement("div");n.className="flex-1",this.elements.toggleFilters&&this.moveElementToMobile(this.elements.toggleFilters,n);const s=document.createElement("div");s.className="flex-1 flex flex-col gap-2",this.elements.activeFiltersBadge&&this.moveElementToMobile(this.elements.activeFiltersBadge,s),this.elements.clearAllBtn&&this.moveElementToMobile(this.elements.clearAllBtn,s),t.appendChild(n),t.appendChild(s),e.appendChild(t),this.elements.mobileMenuItems.appendChild(e);const i=document.createElement("div");i.className="mobile-group mb-4 pb-4";const o=document.createElement("div");o.className="flex gap-4";const a=document.createElement("div");a.className="flex-1",this.elements.toggleResults&&this.moveElementToMobile(this.elements.toggleResults,a);const u=document.createElement("div");u.className="flex-1 flex flex-col gap-2",this.elements.resultsCounter&&this.moveElementToMobile(this.elements.resultsCounter,u),this.elements.uniqueResultsCounter&&this.moveElementToMobile(this.elements.uniqueResultsCounter,u),o.appendChild(a),o.appendChild(u),i.appendChild(o),this.elements.mobileMenuItems.appendChild(i);const c=document.createElement("div");c.className="h-4",this.elements.mobileMenuItems.appendChild(c),[this.elements.layerButton,this.elements.markersButton,this.elements.toggleLegendBtn].forEach(v=>{if(v&&v.parentNode){const m=document.createElement("div");m.className="mobile-menu-item w-full mb-2",this.moveElementToMobile(v,m),this.elements.mobileMenuItems.appendChild(m)}}),this.bindMobileMenuEvents()}moveElementToMobile(e,t){!e||!e.parentNode||!t||(this.originalPositions[e.id]={parent:e.parentNode,nextSibling:e.nextElementSibling,originalClasses:e.className},t.appendChild(e))}styleMobileElements(){}bindMobileMenuEvents(){this.elements.mobileMenuItems.addEventListener("click",e=>{const t=e.target.closest("button, [onclick]");t&&(["toggle-filters","toggle-results"].includes(t.id)?setTimeout(()=>this.closeMobileMenu(),100):setTimeout(()=>this.closeMobileMenu(),300))})}restoreOriginalPositions(){Object.entries(this.originalPositions).forEach(([e,t])=>{const n=document.getElementById(e);n&&t.parent&&(n.className=t.originalClasses,t.nextSibling?t.parent.insertBefore(n,t.nextSibling):t.parent.appendChild(n))}),this.elements.mobileMenuItems&&(this.elements.mobileMenuItems.innerHTML="")}toggleMobileMenu(){this.state.isMobileMenuOpen?this.closeMobileMenu():this.openMobileMenu()}openMobileMenu(){this.state.isMobileMenuOpen=!0,this.elements.mobileMenu.classList.remove("hidden"),setTimeout(()=>{this.elements.mobileMenuContent.style.transform="translateX(0)"},10);const e=this.elements.hamburgerBtn.querySelectorAll("span");e[0].style.transform="rotate(45deg) translate(6px, 6px)",e[1].style.opacity="0",e[2].style.transform="rotate(-45deg) translate(6px, -6px)"}closeMobileMenu(){this.state.isMobileMenuOpen=!1,this.elements.mobileMenuContent.style.transform="translateX(100%)",setTimeout(()=>{this.elements.mobileMenu.classList.add("hidden")},300);const e=this.elements.hamburgerBtn.querySelectorAll("span");e[0].style.transform="",e[1].style.opacity="",e[2].style.transform=""}updateMobileCounters(){}initializeConfiguration(){ve.waitForGlobal("ledaSearch",e=>{this.config=e.config,this.mapInstance=e.mapInstance,this.initializePopupManagers()})}initializePopupManagers(){this.popupManagers.activeFilters=new Lo(this),this.popupManagers.activeFilters.init(),this.config&&this.config.map&&this.config.map.tileLayers&&(this.popupManagers.layers=new Fo(this.config.map.tileLayers),this.popupManagers.layers.init()),this.popupManagers.markers=new Io(this.mapInstance),this.popupManagers.markers.init()}styleClearAllButton(){this.elements.clearAllBtn&&(this.elements.clearAllBtn.className="ml-2 px-3 py-1 bg-pink-100 hover:bg-pink-200 text-red-500 text-xs rounded-full",this.elements.clearAllBtn.innerHTML='<i class="fas fa-times mr-1"></i>Cancella tutto')}updateFromSearchState(e,t=0,n={}){if(!e)return;this.currentFilters={...e.filters},this.currentQuery=e.query||"";const s=n.uniqueResultsCount||0,i=jo.calculateActiveFiltersCount(e.filters);this.updateActiveFiltersCount(i),this.updateResultsCount(t,s)}updateActiveFiltersCount(e){this.state.activeFiltersCount=e,this.elements.activeFiltersCount.textContent=e,e>0?(ve.showElement(this.elements.activeFiltersBadge),ve.showElement(this.elements.clearAllBtn)):(ve.hideElement(this.elements.activeFiltersBadge),ve.hideElement(this.elements.clearAllBtn)),this.updateMobileCounters(),Oe.emit("navbar:activeFiltersChanged",{count:e})}updateResultsCount(e,t=0){this.state.resultsCount=e,this.state.uniqueResultsCount=t,this.elements.resultsCount.textContent=e,this.updateUniqueResultsDisplay(t),e>0?ve.showElement(this.elements.resultsCounter):ve.hideElement(this.elements.resultsCounter),t>0&&this.elements.uniqueResultsCounter?ve.showElement(this.elements.uniqueResultsCounter):this.elements.uniqueResultsCounter&&ve.hideElement(this.elements.uniqueResultsCounter),this.updateMobileCounters(),Oe.emit("navbar:resultsCountChanged",{totalCount:e,uniqueResultsCount:t})}updateUniqueResultsDisplay(e){let t=document.getElementById("unique-results-count");if(!t){t=document.createElement("span"),t.id="unique-results-count",t.className="ml-2 text-xs text-gray-600 bg-blue-100 px-2 py-1 rounded-full";const n=this.elements.resultsCounter;n&&n.appendChild(t)}e>0?(t.textContent=`${e}`,t.style.display="inline"):t.style.display="none"}bindEventHandlers(){var t,n,s,i,o;(t=this.elements.toggleFilters)==null||t.addEventListener("click",()=>{this.togglePanel("filters")}),(n=this.elements.toggleResults)==null||n.addEventListener("click",()=>{this.togglePanel("results")}),(s=this.elements.clearAllBtn)==null||s.addEventListener("click",()=>{this.handleClearAllFilters()}),(i=this.elements.hamburgerBtn)==null||i.addEventListener("click",()=>{this.toggleMobileMenu()});const e=document.getElementById("mobile-menu-close");e&&e.addEventListener("click",()=>{this.closeMobileMenu()}),(o=this.elements.mobileMenu)==null||o.addEventListener("click",a=>{a.target===this.elements.mobileMenu&&this.closeMobileMenu()})}initializePanelStates(){var e,t,n,s,i,o;(e=this.elements.filtersPanel)==null||e.classList.remove("panel-closed"),(t=this.elements.resultsPanel)==null||t.classList.remove("panel-closed-right"),(n=this.elements.toggleFilters)==null||n.classList.add("active"),(s=this.elements.toggleResults)==null||s.classList.add("active"),(i=this.elements.filtersPanel)==null||i.classList.add("panel-open"),(o=this.elements.resultsPanel)==null||o.classList.add("panel-open")}togglePanel(e){const t=this.getPanelConfig(e);if(!t)return;const{panel:n,button:s,closedClass:i}=t,o=!n.classList.contains(i);o?this.closePanel(n,s,i):this.openPanel(n,s,i),Oe.emit("navbar:panelToggled",{type:e,isOpen:!o})}getPanelConfig(e){return{filters:{panel:this.elements.filtersPanel,button:this.elements.toggleFilters,closedClass:"panel-closed"},results:{panel:this.elements.resultsPanel,button:this.elements.toggleResults,closedClass:"panel-closed-right"}}[e]}closePanel(e,t,n){e==null||e.classList.add(n),e==null||e.classList.remove("panel-open"),t==null||t.classList.remove("active")}openPanel(e,t,n){e==null||e.classList.remove(n),e==null||e.classList.add("panel-open"),t==null||t.classList.add("active")}closeAllPanels(){this.closePanel(this.elements.filtersPanel,this.elements.toggleFilters,"panel-closed"),this.closePanel(this.elements.resultsPanel,this.elements.toggleResults,"panel-closed-right")}handleClearAllFilters(){var e;(e=this.popupManagers.activeFilters)==null||e.hide(),this.currentFilters={},this.currentQuery="",this.updateActiveFiltersCount(0),this.updateResultsCount(0),Oe.emit("navbar:clearAllFilters",{resetInterface:!0,clearSearch:!0,clearFacets:!0,clearMap:!0}),setTimeout(()=>{gt.resetFacetsInterface(),gt.clearSearchInput()},100),un.show("Tutti i filtri sono stati rimossi","success",2e3)}setupResponsiveBehavior(){const e=()=>{window.innerWidth>=768?(this.restoreOriginalPositions(),this.closeMobileMenu()):this.elements.mobileMenuItems&&this.elements.mobileMenuItems.children.length===0&&this.populateMobileMenu()};window.addEventListener("resize",e),window.innerWidth<768&&this.closeAllPanels()}getState(){var e,t;return{...this.state,isFiltersOpen:!((e=this.elements.filtersPanel)!=null&&e.classList.contains("panel-closed")),isResultsOpen:!((t=this.elements.resultsPanel)!=null&&t.classList.contains("panel-closed-right")),currentFilters:{...this.currentFilters},currentQuery:this.currentQuery}}setState(e){Object.entries(e).forEach(([t,n])=>{switch(t){case"activeFiltersCount":this.updateActiveFiltersCount(n);break;case"resultsCount":this.updateResultsCount(n,e.uniqueResultsCount);break;case"isFiltersOpen":this.setPanelState("filters",n);break;case"isResultsOpen":this.setPanelState("results",n);break;case"currentFilters":this.currentFilters={...n};break;case"currentQuery":this.currentQuery=n;break;default:this.state.hasOwnProperty(t)&&(this.state[t]=n)}})}setPanelState(e,t){const n=this.getPanelConfig(e);if(!n)return;const{panel:s,closedClass:i}=n,o=!(s!=null&&s.classList.contains(i));t!==o&&this.togglePanel(e)}addEventListener(e,t){document.addEventListener(`navbar:${e}`,t)}removeEventListener(e,t){document.removeEventListener(`navbar:${e}`,t)}showNotification(e,t="info",n=3e3){un.show(e,t,n)}resetInterface(){var e;this.currentFilters={},this.currentQuery="",this.updateActiveFiltersCount(0),this.updateResultsCount(0),(e=this.popupManagers.activeFilters)==null||e.hide(),this.closeAllPanels(),this.closeMobileMenu(),gt.resetFacetsInterface(),gt.clearSearchInput()}destroy(){var e,t;this.restoreOriginalPositions(),Object.values(this.popupManagers).forEach(n=>{n==null||n.destroy()}),(e=this.elements.hamburgerBtn)==null||e.remove(),(t=this.elements.mobileMenu)==null||t.remove(),this.elements={},this.originalPositions={},this.currentFilters={},this.currentQuery="",this.config=null,this.mapInstance=null,this.popupManagers={},this.state.isInitialized=!1}}const Po=new Oo;class Hn{constructor(){this.originalFacetData=null}renderTaxonomy(e,t,n,s){const i=this._buildHierarchy(t);this._calculateTotalCounts(i),e.className="taxonomy-container max-w-full overflow-x-auto max-h-80 overflow-y-auto",e.innerHTML=this._createTaxonomyHTML(i,[],0,n,s),this._setCheckboxStates(e,i,s[n]||[]),this._addEventListeners(e,i,n)}resetOriginalData(){this.originalFacetData=null}_buildHierarchy(e){const t={};return Array.isArray(e)&&e.forEach(n=>{const s=n.key.split(" > ");let i=t;s.forEach((o,a)=>{i[o]||(i[o]={children:{},docCount:0,selfCount:0}),a===s.length-1&&(i[o].selfCount=n.doc_count),i=i[o].children})}),t}_calculateTotalCounts(e){const t=n=>{let s=n.selfCount||0;return Object.values(n.children||{}).forEach(i=>{s+=t(i)}),n.docCount=s,s};Object.values(e).forEach(t)}_setCheckboxStates(e,t,n){const s=(i,o=[])=>{Object.entries(i).forEach(([a,u])=>{if(this._isMetadataKey(a))return;const c=[...o,a].join(" > "),h=e.querySelector(`input[value="${c}"]`);if(!h)return;h.checked=n.includes(c);const m=this._getAllChildPaths(u.children||{},[...o,a]).some(p=>n.includes(p));h.indeterminate=m&&!h.checked,s(u.children,[...o,a])})};s(t)}_createTaxonomyHTML(e,t=[],n=0,s,i){const o=i[s]||[];let a='<div class="space-y-1">';return Object.entries(e).forEach(([u,c])=>{if(this._isMetadataKey(u))return;const h=[...t,u],v=h.join(" > "),m=Object.keys(c.children).length>0,p=o.includes(v),y=m&&this._hasSelectedChild(c.children,o,h),w=p||y;a+=`
        <div class="taxonomy-item">
          <label class="cursor-pointer block facet-option ${c.docCount===0?"text-gray-400":""}" data-search-text="${u.toLowerCase()}">
            <div></div>
            ${this._createToggleButton(m,v,w)}
            <div class="flex items-center gap-2 min-w-0">
              <input type="checkbox" value="${v}" data-facet-type="${s}" class="form-checkbox flex-shrink-0" ${p?"checked":""}>
              <span class="text-sm">${u}</span>
            </div>
            <span class="text-xs text-secondary-500 bg-secondary-100 px-2 py-0.5 rounded-full flex-shrink-0">${c.docCount}</span>
          </label>
          ${this._createChildrenContainer(m,v,w,c.children,h,n+1,s,i)}
        </div>`}),a+"</div>"}_createToggleButton(e,t,n){return e?`<button class="toggle-btn flex-shrink-0 w-5 h-5 flex items-center justify-center rounded hover:bg-gray-200 transition-colors" data-path="${t}">
        <svg class="w-3 h-3 text-gray-600 transform transition-transform duration-200 ${n?"rotate-90":""}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </button>`:'<div class="w-5 h-5 flex-shrink-0"></div>'}_createChildrenContainer(e,t,n,s,i,o,a,u){return e?`<div class="children ${n?"":"hidden"}" data-parent="${t}">
        ${this._createTaxonomyHTML(s,i,o,a,u)}
      </div>`:""}_isMetadataKey(e){return["children","docCount","selfCount"].includes(e)}_hasSelectedChild(e,t,n=[]){for(const[s,i]of Object.entries(e)){if(this._isMetadataKey(s))continue;const o=[...n,s].join(" > ");if(t.includes(o)||Object.keys(i.children).length>0&&this._hasSelectedChild(i.children,t,[...n,s]))return!0}return!1}_getParentPaths(e){const t=e.split(" > "),n=[];for(let s=1;s<t.length;s++)n.push(t.slice(0,s).join(" > "));return n}_getAllChildPaths(e,t=[]){const n=[];return Object.entries(e).forEach(([s,i])=>{if(this._isMetadataKey(s))return;const o=[...t,s].join(" > ");n.push(o),Object.keys(i.children).length>0&&n.push(...this._getAllChildPaths(i.children,[...t,s]))}),n}_getChildPathsForNode(e,t){const n=t.split(" > ");let s=e;for(const i of n)if(s[i])s=s[i];else return[];return this._getAllChildPaths(s.children,n)}_addEventListeners(e,t,n){e._hierarchy=t,this._addToggleListeners(e),this._addCheckboxListeners(e,t,n)}_addToggleListeners(e){e.addEventListener("click",t=>{const n=t.target.closest(".toggle-btn");if(!n)return;const s=n.dataset.path,i=e.querySelector(`[data-parent="${s}"]`),o=n.querySelector("svg");if(i&&o){const a=i.classList.contains("hidden");i.classList.toggle("hidden"),o.classList.toggle("rotate-90",a)}})}_addCheckboxListeners(e,t,n){e.addEventListener("change",s=>{if(s.target.type!=="checkbox")return;const i=s.target,o=i.value,a=i.checked;s.stopPropagation();const u=this._getParentPaths(o),c=this._getChildPathsForNode(t,o);this._updateRelatedCheckboxes(e,t,o,a,u,c),e.dispatchEvent(new CustomEvent("taxonomyChange",{detail:{facetKey:n,path:o,checked:a,action:a?"add":"remove"}}))})}_updateRelatedCheckboxes(e,t,n,s,i,o){s?(this._updateCheckboxes(e,i,!0),this._updateCheckboxes(e,o,!0)):(this._updateCheckboxes(e,o,!1),this._updateParentCheckboxes(e,t,i)),this._updateCheckboxVisuals(e.querySelector(`input[value="${n}"]`),s)}_updateCheckboxes(e,t,n){t==null||t.forEach(s=>{const i=e.querySelector(`input[value="${s}"]`);i&&i.checked!==n&&(i.checked=n,this._updateCheckboxVisuals(i,n))})}_updateParentCheckboxes(e,t,n){n==null||n.forEach(s=>{const i=e.querySelector(`input[value="${s}"]`);if(!(i!=null&&i.checked))return;this._getChildPathsForNode(t,s).some(u=>{const c=e.querySelector(`input[value="${u}"]`);return c==null?void 0:c.checked})||(i.checked=!1,this._updateCheckboxVisuals(i,!1))})}_updateCheckboxVisuals(e,t){var s;if(!e)return;const n=(s=e.closest("label"))==null?void 0:s.querySelector("span.text-sm");n&&(n.classList.toggle("font-medium",t),n.classList.toggle("text-primary-700",t))}_renderTaxonomyFacet(e,t,n,s,i,o){const a=document.createElement("div"),u=s[t]||[];this.renderTaxonomy(a,u,t,i),a.addEventListener("taxonomyChange",c=>{const{facetKey:h,path:v,checked:m}=c.detail;o({type:"FACET_CHANGE",facetType:h,value:v,checked:m})}),e.appendChild(a)}}var Ie;(function(r){r.Range="range",r.Steps="steps",r.Positions="positions",r.Count="count",r.Values="values"})(Ie||(Ie={}));var oe;(function(r){r[r.None=-1]="None",r[r.NoValue=0]="NoValue",r[r.LargeValue=1]="LargeValue",r[r.SmallValue=2]="SmallValue"})(oe||(oe={}));function $o(r){return _t(r)&&typeof r.from=="function"}function _t(r){return typeof r=="object"&&typeof r.to=="function"}function dn(r){r.parentElement.removeChild(r)}function Kt(r){return r!=null}function hn(r){r.preventDefault()}function No(r){return r.filter(function(e){return this[e]?!1:this[e]=!0},{})}function To(r,e){return Math.round(r/e)*e}function Bo(r,e){var t=r.getBoundingClientRect(),n=r.ownerDocument,s=n.documentElement,i=qn(n);return/webkit.*Chrome.*Mobile/i.test(navigator.userAgent)&&(i.x=0),e?t.top+i.y-s.clientTop:t.left+i.x-s.clientLeft}function ye(r){return typeof r=="number"&&!isNaN(r)&&isFinite(r)}function fn(r,e,t){t>0&&(se(r,e),setTimeout(function(){yt(r,e)},t))}function pn(r){return Math.max(Math.min(r,100),0)}function kt(r){return Array.isArray(r)?r:[r]}function Ro(r){r=String(r);var e=r.split(".");return e.length>1?e[1].length:0}function se(r,e){r.classList&&!/\s/.test(e)?r.classList.add(e):r.className+=" "+e}function yt(r,e){r.classList&&!/\s/.test(e)?r.classList.remove(e):r.className=r.className.replace(new RegExp("(^|\\b)"+e.split(" ").join("|")+"(\\b|$)","gi")," ")}function zo(r,e){return r.classList?r.classList.contains(e):new RegExp("\\b"+e+"\\b").test(r.className)}function qn(r){var e=window.pageXOffset!==void 0,t=(r.compatMode||"")==="CSS1Compat",n=e?window.pageXOffset:t?r.documentElement.scrollLeft:r.body.scrollLeft,s=e?window.pageYOffset:t?r.documentElement.scrollTop:r.body.scrollTop;return{x:n,y:s}}function Do(){return window.navigator.pointerEnabled?{start:"pointerdown",move:"pointermove",end:"pointerup"}:window.navigator.msPointerEnabled?{start:"MSPointerDown",move:"MSPointerMove",end:"MSPointerUp"}:{start:"mousedown touchstart",move:"mousemove touchmove",end:"mouseup touchend"}}function Ho(){var r=!1;try{var e=Object.defineProperty({},"passive",{get:function(){r=!0}});window.addEventListener("test",null,e)}catch{}return r}function qo(){return window.CSS&&CSS.supports&&CSS.supports("touch-action","none")}function dr(r,e){return 100/(e-r)}function er(r,e,t){return e*100/(r[t+1]-r[t])}function Vo(r,e){return er(r,r[0]<0?e+Math.abs(r[0]):e-r[0],0)}function Uo(r,e){return e*(r[1]-r[0])/100+r[0]}function st(r,e){for(var t=1;r>=e[t];)t+=1;return t}function Wo(r,e,t){if(t>=r.slice(-1)[0])return 100;var n=st(t,r),s=r[n-1],i=r[n],o=e[n-1],a=e[n];return o+Vo([s,i],t)/dr(o,a)}function Go(r,e,t){if(t>=100)return r.slice(-1)[0];var n=st(t,e),s=r[n-1],i=r[n],o=e[n-1],a=e[n];return Uo([s,i],(t-o)*dr(o,a))}function Zo(r,e,t,n){if(n===100)return n;var s=st(n,r),i=r[s-1],o=r[s];return t?n-i>(o-i)/2?o:i:e[s-1]?r[s-1]+To(n-r[s-1],e[s-1]):n}var Vn=function(){function r(e,t,n){this.xPct=[],this.xVal=[],this.xSteps=[],this.xNumSteps=[],this.xHighestCompleteStep=[],this.xSteps=[n||!1],this.xNumSteps=[!1],this.snap=t;var s,i=[];for(Object.keys(e).forEach(function(o){i.push([kt(e[o]),o])}),i.sort(function(o,a){return o[0][0]-a[0][0]}),s=0;s<i.length;s++)this.handleEntryPoint(i[s][1],i[s][0]);for(this.xNumSteps=this.xSteps.slice(0),s=0;s<this.xNumSteps.length;s++)this.handleStepPoint(s,this.xNumSteps[s])}return r.prototype.getDistance=function(e){for(var t=[],n=0;n<this.xNumSteps.length-1;n++)t[n]=er(this.xVal,e,n);return t},r.prototype.getAbsoluteDistance=function(e,t,n){var s=0;if(e<this.xPct[this.xPct.length-1])for(;e>this.xPct[s+1];)s++;else e===this.xPct[this.xPct.length-1]&&(s=this.xPct.length-2);!n&&e===this.xPct[s+1]&&s++,t===null&&(t=[]);var i,o=1,a=t[s],u=0,c=0,h=0,v=0;for(n?i=(e-this.xPct[s])/(this.xPct[s+1]-this.xPct[s]):i=(this.xPct[s+1]-e)/(this.xPct[s+1]-this.xPct[s]);a>0;)u=this.xPct[s+1+v]-this.xPct[s+v],t[s+v]*o+100-i*100>100?(c=u*i,o=(a-100*i)/t[s+v],i=1):(c=t[s+v]*u/100*o,o=0),n?(h=h-c,this.xPct.length+v>=1&&v--):(h=h+c,this.xPct.length-v>=1&&v++),a=t[s+v]*o;return e+h},r.prototype.toStepping=function(e){return e=Wo(this.xVal,this.xPct,e),e},r.prototype.fromStepping=function(e){return Go(this.xVal,this.xPct,e)},r.prototype.getStep=function(e){return e=Zo(this.xPct,this.xSteps,this.snap,e),e},r.prototype.getDefaultStep=function(e,t,n){var s=st(e,this.xPct);return(e===100||t&&e===this.xPct[s-1])&&(s=Math.max(s-1,1)),(this.xVal[s]-this.xVal[s-1])/n},r.prototype.getNearbySteps=function(e){var t=st(e,this.xPct);return{stepBefore:{startValue:this.xVal[t-2],step:this.xNumSteps[t-2],highestStep:this.xHighestCompleteStep[t-2]},thisStep:{startValue:this.xVal[t-1],step:this.xNumSteps[t-1],highestStep:this.xHighestCompleteStep[t-1]},stepAfter:{startValue:this.xVal[t],step:this.xNumSteps[t],highestStep:this.xHighestCompleteStep[t]}}},r.prototype.countStepDecimals=function(){var e=this.xNumSteps.map(Ro);return Math.max.apply(null,e)},r.prototype.hasNoSize=function(){return this.xVal[0]===this.xVal[this.xVal.length-1]},r.prototype.convert=function(e){return this.getStep(this.toStepping(e))},r.prototype.handleEntryPoint=function(e,t){var n;if(e==="min"?n=0:e==="max"?n=100:n=parseFloat(e),!ye(n)||!ye(t[0]))throw new Error("noUiSlider: 'range' value isn't numeric.");this.xPct.push(n),this.xVal.push(t[0]);var s=Number(t[1]);n?this.xSteps.push(isNaN(s)?!1:s):isNaN(s)||(this.xSteps[0]=s),this.xHighestCompleteStep.push(0)},r.prototype.handleStepPoint=function(e,t){if(t){if(this.xVal[e]===this.xVal[e+1]){this.xSteps[e]=this.xHighestCompleteStep[e]=this.xVal[e];return}this.xSteps[e]=er([this.xVal[e],this.xVal[e+1]],t,0)/dr(this.xPct[e],this.xPct[e+1]);var n=(this.xVal[e+1]-this.xVal[e])/this.xNumSteps[e],s=Math.ceil(Number(n.toFixed(3))-1),i=this.xVal[e]+this.xNumSteps[e]*s;this.xHighestCompleteStep[e]=i}},r}(),gn={to:function(r){return r===void 0?"":r.toFixed(2)},from:Number},Un={target:"target",base:"base",origin:"origin",handle:"handle",handleLower:"handle-lower",handleUpper:"handle-upper",touchArea:"touch-area",horizontal:"horizontal",vertical:"vertical",background:"background",connect:"connect",connects:"connects",ltr:"ltr",rtl:"rtl",textDirectionLtr:"txt-dir-ltr",textDirectionRtl:"txt-dir-rtl",draggable:"draggable",drag:"state-drag",tap:"state-tap",active:"active",tooltip:"tooltip",pips:"pips",pipsHorizontal:"pips-horizontal",pipsVertical:"pips-vertical",marker:"marker",markerHorizontal:"marker-horizontal",markerVertical:"marker-vertical",markerNormal:"marker-normal",markerLarge:"marker-large",markerSub:"marker-sub",value:"value",valueHorizontal:"value-horizontal",valueVertical:"value-vertical",valueNormal:"value-normal",valueLarge:"value-large",valueSub:"value-sub"},Fe={tooltips:".__tooltips",aria:".__aria"};function Xo(r,e){if(!ye(e))throw new Error("noUiSlider: 'step' is not numeric.");r.singleStep=e}function Yo(r,e){if(!ye(e))throw new Error("noUiSlider: 'keyboardPageMultiplier' is not numeric.");r.keyboardPageMultiplier=e}function Qo(r,e){if(!ye(e))throw new Error("noUiSlider: 'keyboardMultiplier' is not numeric.");r.keyboardMultiplier=e}function Jo(r,e){if(!ye(e))throw new Error("noUiSlider: 'keyboardDefaultStep' is not numeric.");r.keyboardDefaultStep=e}function Ko(r,e){if(typeof e!="object"||Array.isArray(e))throw new Error("noUiSlider: 'range' is not an object.");if(e.min===void 0||e.max===void 0)throw new Error("noUiSlider: Missing 'min' or 'max' in 'range'.");r.spectrum=new Vn(e,r.snap||!1,r.singleStep)}function ea(r,e){if(e=kt(e),!Array.isArray(e)||!e.length)throw new Error("noUiSlider: 'start' option is incorrect.");r.handles=e.length,r.start=e}function ta(r,e){if(typeof e!="boolean")throw new Error("noUiSlider: 'snap' option must be a boolean.");r.snap=e}function ra(r,e){if(typeof e!="boolean")throw new Error("noUiSlider: 'animate' option must be a boolean.");r.animate=e}function na(r,e){if(typeof e!="number")throw new Error("noUiSlider: 'animationDuration' option must be a number.");r.animationDuration=e}function Wn(r,e){var t=[!1],n;if(e==="lower"?e=[!0,!1]:e==="upper"&&(e=[!1,!0]),e===!0||e===!1){for(n=1;n<r.handles;n++)t.push(e);t.push(!1)}else{if(!Array.isArray(e)||!e.length||e.length!==r.handles+1)throw new Error("noUiSlider: 'connect' option doesn't match handle count.");t=e}r.connect=t}function sa(r,e){switch(e){case"horizontal":r.ort=0;break;case"vertical":r.ort=1;break;default:throw new Error("noUiSlider: 'orientation' option is invalid.")}}function Gn(r,e){if(!ye(e))throw new Error("noUiSlider: 'margin' option must be numeric.");e!==0&&(r.margin=r.spectrum.getDistance(e))}function ia(r,e){if(!ye(e))throw new Error("noUiSlider: 'limit' option must be numeric.");if(r.limit=r.spectrum.getDistance(e),!r.limit||r.handles<2)throw new Error("noUiSlider: 'limit' option is only supported on linear sliders with 2 or more handles.")}function oa(r,e){var t;if(!ye(e)&&!Array.isArray(e))throw new Error("noUiSlider: 'padding' option must be numeric or array of exactly 2 numbers.");if(Array.isArray(e)&&!(e.length===2||ye(e[0])||ye(e[1])))throw new Error("noUiSlider: 'padding' option must be numeric or array of exactly 2 numbers.");if(e!==0){for(Array.isArray(e)||(e=[e,e]),r.padding=[r.spectrum.getDistance(e[0]),r.spectrum.getDistance(e[1])],t=0;t<r.spectrum.xNumSteps.length-1;t++)if(r.padding[0][t]<0||r.padding[1][t]<0)throw new Error("noUiSlider: 'padding' option must be a positive number(s).");var n=e[0]+e[1],s=r.spectrum.xVal[0],i=r.spectrum.xVal[r.spectrum.xVal.length-1];if(n/(i-s)>1)throw new Error("noUiSlider: 'padding' option must not exceed 100% of the range.")}}function aa(r,e){switch(e){case"ltr":r.dir=0;break;case"rtl":r.dir=1;break;default:throw new Error("noUiSlider: 'direction' option was not recognized.")}}function la(r,e){if(typeof e!="string")throw new Error("noUiSlider: 'behaviour' must be a string containing options.");var t=e.indexOf("tap")>=0,n=e.indexOf("drag")>=0,s=e.indexOf("fixed")>=0,i=e.indexOf("snap")>=0,o=e.indexOf("hover")>=0,a=e.indexOf("unconstrained")>=0,u=e.indexOf("invert-connects")>=0,c=e.indexOf("drag-all")>=0,h=e.indexOf("smooth-steps")>=0;if(s){if(r.handles!==2)throw new Error("noUiSlider: 'fixed' behaviour must be used with 2 handles");Gn(r,r.start[1]-r.start[0])}if(u&&r.handles!==2)throw new Error("noUiSlider: 'invert-connects' behaviour must be used with 2 handles");if(a&&(r.margin||r.limit))throw new Error("noUiSlider: 'unconstrained' behaviour cannot be used with margin or limit");r.events={tap:t||i,drag:n,dragAll:c,smoothSteps:h,fixed:s,snap:i,hover:o,unconstrained:a,invertConnects:u}}function ca(r,e){if(e!==!1)if(e===!0||_t(e)){r.tooltips=[];for(var t=0;t<r.handles;t++)r.tooltips.push(e)}else{if(e=kt(e),e.length!==r.handles)throw new Error("noUiSlider: must pass a formatter for all handles.");e.forEach(function(n){if(typeof n!="boolean"&&!_t(n))throw new Error("noUiSlider: 'tooltips' must be passed a formatter or 'false'.")}),r.tooltips=e}}function ua(r,e){if(e.length!==r.handles)throw new Error("noUiSlider: must pass a attributes for all handles.");r.handleAttributes=e}function da(r,e){if(!_t(e))throw new Error("noUiSlider: 'ariaFormat' requires 'to' method.");r.ariaFormat=e}function ha(r,e){if(!$o(e))throw new Error("noUiSlider: 'format' requires 'to' and 'from' methods.");r.format=e}function fa(r,e){if(typeof e!="boolean")throw new Error("noUiSlider: 'keyboardSupport' option must be a boolean.");r.keyboardSupport=e}function pa(r,e){r.documentElement=e}function ga(r,e){if(typeof e!="string"&&e!==!1)throw new Error("noUiSlider: 'cssPrefix' must be a string or `false`.");r.cssPrefix=e}function ma(r,e){if(typeof e!="object")throw new Error("noUiSlider: 'cssClasses' must be an object.");typeof r.cssPrefix=="string"?(r.cssClasses={},Object.keys(e).forEach(function(t){r.cssClasses[t]=r.cssPrefix+e[t]})):r.cssClasses=e}function Zn(r){var e={margin:null,limit:null,padding:null,animate:!0,animationDuration:300,ariaFormat:gn,format:gn},t={step:{r:!1,t:Xo},keyboardPageMultiplier:{r:!1,t:Yo},keyboardMultiplier:{r:!1,t:Qo},keyboardDefaultStep:{r:!1,t:Jo},start:{r:!0,t:ea},connect:{r:!0,t:Wn},direction:{r:!0,t:aa},snap:{r:!1,t:ta},animate:{r:!1,t:ra},animationDuration:{r:!1,t:na},range:{r:!0,t:Ko},orientation:{r:!1,t:sa},margin:{r:!1,t:Gn},limit:{r:!1,t:ia},padding:{r:!1,t:oa},behaviour:{r:!0,t:la},ariaFormat:{r:!1,t:da},format:{r:!1,t:ha},tooltips:{r:!1,t:ca},keyboardSupport:{r:!0,t:fa},documentElement:{r:!1,t:pa},cssPrefix:{r:!0,t:ga},cssClasses:{r:!0,t:ma},handleAttributes:{r:!1,t:ua}},n={connect:!1,direction:"ltr",behaviour:"tap",orientation:"horizontal",keyboardSupport:!0,cssPrefix:"noUi-",cssClasses:Un,keyboardPageMultiplier:5,keyboardMultiplier:1,keyboardDefaultStep:10};r.format&&!r.ariaFormat&&(r.ariaFormat=r.format),Object.keys(t).forEach(function(u){if(!Kt(r[u])&&n[u]===void 0){if(t[u].r)throw new Error("noUiSlider: '"+u+"' is required.");return}t[u].t(e,Kt(r[u])?r[u]:n[u])}),e.pips=r.pips;var s=document.createElement("div"),i=s.style.msTransform!==void 0,o=s.style.transform!==void 0;e.transformRule=o?"transform":i?"msTransform":"webkitTransform";var a=[["left","top"],["right","bottom"]];return e.style=a[e.dir][e.ort],e}function va(r,e,t){var n=Do(),s=qo(),i=s&&Ho(),o=r,a,u,c,h,v,m,p=e.spectrum,y=[],w=[],A=[],F=0,T={},U=!1,$=r.ownerDocument,X=e.documentElement||$.documentElement,I=$.body,P=$.dir==="rtl"||e.ort===1?0:100;function Y(d,g){var b=$.createElement("div");return g&&se(b,g),d.appendChild(b),b}function ce(d,g){var b=Y(d,e.cssClasses.origin),S=Y(b,e.cssClasses.handle);if(Y(S,e.cssClasses.touchArea),S.setAttribute("data-handle",String(g)),e.keyboardSupport&&(S.setAttribute("tabindex","0"),S.addEventListener("keydown",function(k){return Xe(k,g)})),e.handleAttributes!==void 0){var E=e.handleAttributes[g];Object.keys(E).forEach(function(k){S.setAttribute(k,E[k])})}return S.setAttribute("role","slider"),S.setAttribute("aria-orientation",e.ort?"vertical":"horizontal"),g===0?se(S,e.cssClasses.handleLower):g===e.handles-1&&se(S,e.cssClasses.handleUpper),b.handle=S,b}function be(d,g){return g?Y(d,e.cssClasses.connect):!1}function te(d,g){u=Y(g,e.cssClasses.connects),c=[],h=[],h.push(be(u,d[0]));for(var b=0;b<e.handles;b++)c.push(ce(g,b)),A[b]=b,h.push(be(u,d[b+1]))}function le(d){se(d,e.cssClasses.target),e.dir===0?se(d,e.cssClasses.ltr):se(d,e.cssClasses.rtl),e.ort===0?se(d,e.cssClasses.horizontal):se(d,e.cssClasses.vertical);var g=getComputedStyle(d).direction;return g==="rtl"?se(d,e.cssClasses.textDirectionRtl):se(d,e.cssClasses.textDirectionLtr),Y(d,e.cssClasses.base)}function ue(d,g){return!e.tooltips||!e.tooltips[g]?!1:Y(d.firstChild,e.cssClasses.tooltip)}function ge(){return o.hasAttribute("disabled")}function de(d){var g=c[d];return g.hasAttribute("disabled")}function x(d){d!=null?(c[d].setAttribute("disabled",""),c[d].handle.removeAttribute("tabindex")):(o.setAttribute("disabled",""),c.forEach(function(g){g.handle.removeAttribute("tabindex")}))}function l(d){d!=null?(c[d].removeAttribute("disabled"),c[d].handle.setAttribute("tabindex","0")):(o.removeAttribute("disabled"),c.forEach(function(g){g.removeAttribute("disabled"),g.handle.setAttribute("tabindex","0")}))}function f(){m&&(Ye("update"+Fe.tooltips),m.forEach(function(d){d&&dn(d)}),m=null)}function _(){f(),m=c.map(ue),At("update"+Fe.tooltips,function(d,g,b){if(!(!m||!e.tooltips)&&m[g]!==!1){var S=d[g];e.tooltips[g]!==!0&&(S=e.tooltips[g].to(b[g])),m[g].innerHTML=S}})}function C(){Ye("update"+Fe.aria),At("update"+Fe.aria,function(d,g,b,S,E){A.forEach(function(k){var O=c[k],L=at(w,k,0,!0,!0,!0),H=at(w,k,100,!0,!0,!0),q=E[k],G=String(e.ariaFormat.to(b[k]));L=p.fromStepping(L).toFixed(1),H=p.fromStepping(H).toFixed(1),q=p.fromStepping(q).toFixed(1),O.children[0].setAttribute("aria-valuemin",L),O.children[0].setAttribute("aria-valuemax",H),O.children[0].setAttribute("aria-valuenow",q),O.children[0].setAttribute("aria-valuetext",G)})})}function M(d){if(d.mode===Ie.Range||d.mode===Ie.Steps)return p.xVal;if(d.mode===Ie.Count){if(d.values<2)throw new Error("noUiSlider: 'values' (>= 2) required for mode 'count'.");for(var g=d.values-1,b=100/g,S=[];g--;)S[g]=g*b;return S.push(100),j(S,d.stepped)}return d.mode===Ie.Positions?j(d.values,d.stepped):d.mode===Ie.Values?d.stepped?d.values.map(function(E){return p.fromStepping(p.getStep(p.toStepping(E)))}):d.values:[]}function j(d,g){return d.map(function(b){return p.fromStepping(g?p.getStep(b):b)})}function R(d){function g(q,G){return Number((q+G).toFixed(7))}var b=M(d),S={},E=p.xVal[0],k=p.xVal[p.xVal.length-1],O=!1,L=!1,H=0;return b=No(b.slice().sort(function(q,G){return q-G})),b[0]!==E&&(b.unshift(E),O=!0),b[b.length-1]!==k&&(b.push(k),L=!0),b.forEach(function(q,G){var Z,D,K,ne=q,ee=b[G+1],re,Ft,It,Ot,br,Pt,wr,xr=d.mode===Ie.Steps;for(xr&&(Z=p.xNumSteps[G]),Z||(Z=ee-ne),ee===void 0&&(ee=ne),Z=Math.max(Z,1e-7),D=ne;D<=ee;D=g(D,Z)){for(re=p.toStepping(D),Ft=re-H,br=Ft/(d.density||1),Pt=Math.round(br),wr=Ft/Pt,K=1;K<=Pt;K+=1)It=H+K*wr,S[It.toFixed(5)]=[p.fromStepping(It),0];Ot=b.indexOf(D)>-1?oe.LargeValue:xr?oe.SmallValue:oe.NoValue,!G&&O&&D!==ee&&(Ot=0),D===ee&&L||(S[re.toFixed(5)]=[D,Ot]),H=re}}),S}function J(d,g,b){var S,E,k=$.createElement("div"),O=(S={},S[oe.None]="",S[oe.NoValue]=e.cssClasses.valueNormal,S[oe.LargeValue]=e.cssClasses.valueLarge,S[oe.SmallValue]=e.cssClasses.valueSub,S),L=(E={},E[oe.None]="",E[oe.NoValue]=e.cssClasses.markerNormal,E[oe.LargeValue]=e.cssClasses.markerLarge,E[oe.SmallValue]=e.cssClasses.markerSub,E),H=[e.cssClasses.valueHorizontal,e.cssClasses.valueVertical],q=[e.cssClasses.markerHorizontal,e.cssClasses.markerVertical];se(k,e.cssClasses.pips),se(k,e.ort===0?e.cssClasses.pipsHorizontal:e.cssClasses.pipsVertical);function G(D,K){var ne=K===e.cssClasses.value,ee=ne?H:q,re=ne?O:L;return K+" "+ee[e.ort]+" "+re[D]}function Z(D,K,ne){if(ne=g?g(K,ne):ne,ne!==oe.None){var ee=Y(k,!1);ee.className=G(ne,e.cssClasses.marker),ee.style[e.style]=D+"%",ne>oe.NoValue&&(ee=Y(k,!1),ee.className=G(ne,e.cssClasses.value),ee.setAttribute("data-value",String(K)),ee.style[e.style]=D+"%",ee.innerHTML=String(b.to(K)))}}return Object.keys(d).forEach(function(D){Z(D,d[D][0],d[D][1])}),k}function z(){v&&(dn(v),v=null)}function we(d){z();var g=R(d),b=d.filter,S=d.format||{to:function(E){return String(Math.round(E))}};return v=o.appendChild(J(g,b,S)),v}function Pe(){var d=a.getBoundingClientRect(),g="offset"+["Width","Height"][e.ort];return e.ort===0?d.width||a[g]:d.height||a[g]}function he(d,g,b,S){var E=function(O){var L=xe(O,S.pageOffset,S.target||g);if(!L||ge()&&!S.doNotReject||zo(o,e.cssClasses.tap)&&!S.doNotReject||d===n.start&&L.buttons!==void 0&&L.buttons>1||S.hover&&L.buttons)return!1;i||L.preventDefault(),L.calcPoint=L.points[e.ort],b(L,S)},k=[];return d.split(" ").forEach(function(O){g.addEventListener(O,E,i?{passive:!0}:!1),k.push([O,E])}),k}function xe(d,g,b){var S=d.type.indexOf("touch")===0,E=d.type.indexOf("mouse")===0,k=d.type.indexOf("pointer")===0,O=0,L=0;if(d.type.indexOf("MSPointer")===0&&(k=!0),d.type==="mousedown"&&!d.buttons&&!d.touches)return!1;if(S){var H=function(Z){var D=Z.target;return D===b||b.contains(D)||d.composed&&d.composedPath().shift()===b};if(d.type==="touchstart"){var q=Array.prototype.filter.call(d.touches,H);if(q.length>1)return!1;O=q[0].pageX,L=q[0].pageY}else{var G=Array.prototype.find.call(d.changedTouches,H);if(!G)return!1;O=G.pageX,L=G.pageY}}return g=g||qn($),(E||k)&&(O=d.clientX+g.x,L=d.clientY+g.y),d.pageOffset=g,d.points=[O,L],d.cursor=E||k,d}function Ce(d){var g=d-Bo(a,e.ort),b=g*100/Pe();return b=pn(b),e.dir?100-b:b}function He(d){var g=100,b=!1;return c.forEach(function(S,E){if(!de(E)){var k=w[E],O=Math.abs(k-d),L=O===100&&g===100,H=O<g,q=O<=g&&d>k;(H||q||L)&&(b=E,g=O)}}),b}function Ae(d,g){d.type==="mouseout"&&d.target.nodeName==="HTML"&&d.relatedTarget===null&&Le(d,g)}function je(d,g){if(navigator.appVersion.indexOf("MSIE 9")===-1&&d.buttons===0&&g.buttonsProperty!==0)return Le(d,g);var b=(e.dir?-1:1)*(d.calcPoint-g.startCalcPoint),S=b*100/g.baseSize;fr(b>0,S,g.locations,g.handleNumbers,g.connect)}function Le(d,g){g.handle&&(yt(g.handle,e.cssClasses.active),F-=1),g.listeners.forEach(function(b){X.removeEventListener(b[0],b[1])}),F===0&&(yt(o,e.cssClasses.drag),Lt(),d.cursor&&(I.style.cursor="",I.removeEventListener("selectstart",hn))),e.events.smoothSteps&&(g.handleNumbers.forEach(function(b){$e(b,w[b],!0,!0,!1,!1)}),g.handleNumbers.forEach(function(b){Q("update",b)})),g.handleNumbers.forEach(function(b){Q("change",b),Q("set",b),Q("end",b)})}function qe(d,g){if(!g.handleNumbers.some(de)){var b;if(g.handleNumbers.length===1){var S=c[g.handleNumbers[0]];b=S.children[0],F+=1,se(b,e.cssClasses.active)}d.stopPropagation();var E=[],k=he(n.move,X,je,{target:d.target,handle:b,connect:g.connect,listeners:E,startCalcPoint:d.calcPoint,baseSize:Pe(),pageOffset:d.pageOffset,handleNumbers:g.handleNumbers,buttonsProperty:d.buttons,locations:w.slice()}),O=he(n.end,X,Le,{target:d.target,handle:b,listeners:E,doNotReject:!0,handleNumbers:g.handleNumbers}),L=he("mouseout",X,Ae,{target:d.target,handle:b,listeners:E,doNotReject:!0,handleNumbers:g.handleNumbers});E.push.apply(E,k.concat(O,L)),d.cursor&&(I.style.cursor=getComputedStyle(d.target).cursor,c.length>1&&se(o,e.cssClasses.drag),I.addEventListener("selectstart",hn,!1)),g.handleNumbers.forEach(function(H){Q("start",H)})}}function ot(d){d.stopPropagation();var g=Ce(d.calcPoint),b=He(g);b!==!1&&(e.events.snap||fn(o,e.cssClasses.tap,e.animationDuration),$e(b,g,!0,!0),Lt(),Q("slide",b,!0),Q("update",b,!0),e.events.snap?qe(d,{handleNumbers:[b]}):(Q("change",b,!0),Q("set",b,!0)))}function Mt(d){var g=Ce(d.calcPoint),b=p.getStep(g),S=p.fromStepping(b);Object.keys(T).forEach(function(E){E.split(".")[0]==="hover"&&T[E].forEach(function(k){k.call(ct,S)})})}function Xe(d,g){if(ge()||de(g))return!1;var b=["Left","Right"],S=["Down","Up"],E=["PageDown","PageUp"],k=["Home","End"];e.dir&&!e.ort?b.reverse():e.ort&&!e.dir&&(S.reverse(),E.reverse());var O=d.key.replace("Arrow",""),L=O===E[0],H=O===E[1],q=O===S[0]||O===b[0]||L,G=O===S[1]||O===b[1]||H,Z=O===k[0],D=O===k[1];if(!q&&!G&&!Z&&!D)return!0;d.preventDefault();var K;if(G||q){var ne=q?0:1,ee=vr(g),re=ee[ne];if(re===null)return!1;re===!1&&(re=p.getDefaultStep(w[g],q,e.keyboardDefaultStep)),H||L?re*=e.keyboardPageMultiplier:re*=e.keyboardMultiplier,re=Math.max(re,1e-7),re=(q?-1:1)*re,K=y[g]+re}else D?K=e.spectrum.xVal[e.spectrum.xVal.length-1]:K=e.spectrum.xVal[0];return $e(g,p.toStepping(K),!0,!0),Q("slide",g),Q("update",g),Q("change",g),Q("set",g),!1}function hr(d){d.fixed||c.forEach(function(g,b){he(n.start,g.children[0],qe,{handleNumbers:[b]})}),d.tap&&he(n.start,a,ot,{}),d.hover&&he(n.move,a,Mt,{hover:!0}),d.drag&&h.forEach(function(g,b){if(!(g===!1||b===0||b===h.length-1)){var S=c[b-1],E=c[b],k=[g],O=[S,E],L=[b-1,b];se(g,e.cssClasses.draggable),d.fixed&&(k.push(S.children[0]),k.push(E.children[0])),d.dragAll&&(O=c,L=A),k.forEach(function(H){he(n.start,H,qe,{handles:O,handleNumbers:L,connect:g})})}})}function At(d,g){T[d]=T[d]||[],T[d].push(g),d.split(".")[0]==="update"&&c.forEach(function(b,S){Q("update",S)})}function Yn(d){return d===Fe.aria||d===Fe.tooltips}function Ye(d){var g=d&&d.split(".")[0],b=g?d.substring(g.length):d;Object.keys(T).forEach(function(S){var E=S.split(".")[0],k=S.substring(E.length);(!g||g===E)&&(!b||b===k)&&(!Yn(k)||b===k)&&delete T[S]})}function Q(d,g,b){Object.keys(T).forEach(function(S){var E=S.split(".")[0];d===E&&T[S].forEach(function(k){k.call(ct,y.map(e.format.to),g,y.slice(),b||!1,w.slice(),ct)})})}function at(d,g,b,S,E,k,O){var L;return c.length>1&&!e.events.unconstrained&&(S&&g>0&&(L=p.getAbsoluteDistance(d[g-1],e.margin,!1),b=Math.max(b,L)),E&&g<c.length-1&&(L=p.getAbsoluteDistance(d[g+1],e.margin,!0),b=Math.min(b,L))),c.length>1&&e.limit&&(S&&g>0&&(L=p.getAbsoluteDistance(d[g-1],e.limit,!1),b=Math.min(b,L)),E&&g<c.length-1&&(L=p.getAbsoluteDistance(d[g+1],e.limit,!0),b=Math.max(b,L))),e.padding&&(g===0&&(L=p.getAbsoluteDistance(0,e.padding[0],!1),b=Math.max(b,L)),g===c.length-1&&(L=p.getAbsoluteDistance(100,e.padding[1],!0),b=Math.min(b,L))),O||(b=p.getStep(b)),b=pn(b),b===d[g]&&!k?!1:b}function jt(d,g){var b=e.ort;return(b?g:d)+", "+(b?d:g)}function fr(d,g,b,S,E){var k=b.slice(),O=S[0],L=e.events.smoothSteps,H=[!d,d],q=[d,!d];S=S.slice(),d&&S.reverse(),S.length>1?S.forEach(function(Z,D){var K=at(k,Z,k[Z]+g,H[D],q[D],!1,L);K===!1?g=0:(g=K-k[Z],k[Z]=K)}):H=q=[!0];var G=!1;S.forEach(function(Z,D){G=$e(Z,b[Z]+g,H[D],q[D],!1,L)||G}),G&&(S.forEach(function(Z){Q("update",Z),Q("slide",Z)}),E!=null&&Q("drag",O))}function pr(d,g){return e.dir?100-d-g:d}function Qn(d,g){w[d]=g,y[d]=p.fromStepping(g);var b=pr(g,0)-P,S="translate("+jt(b+"%","0")+")";if(c[d].style[e.transformRule]=S,e.events.invertConnects&&w.length>1){var E=w.every(function(k,O,L){return O===0||k>=L[O-1]});if(U!==!E){ns();return}}Qe(d),Qe(d+1),U&&(Qe(d-1),Qe(d+2))}function Lt(){A.forEach(function(d){var g=w[d]>50?-1:1,b=3+(c.length+g*d);c[d].style.zIndex=String(b)})}function $e(d,g,b,S,E,k){return E||(g=at(w,d,g,b,S,!1,k)),g===!1?!1:(Qn(d,g),!0)}function Qe(d){if(h[d]){var g=w.slice();U&&g.sort(function(L,H){return L-H});var b=0,S=100;d!==0&&(b=g[d-1]),d!==h.length-1&&(S=g[d]);var E=S-b,k="translate("+jt(pr(b,E)+"%","0")+")",O="scale("+jt(E/100,"1")+")";h[d].style[e.transformRule]=k+" "+O}}function gr(d,g){return d===null||d===!1||d===void 0||(typeof d=="number"&&(d=String(d)),d=e.format.from(d),d!==!1&&(d=p.toStepping(d)),d===!1||isNaN(d))?w[g]:d}function lt(d,g,b){var S=kt(d),E=w[0]===void 0;g=g===void 0?!0:g,e.animate&&!E&&fn(o,e.cssClasses.tap,e.animationDuration),A.forEach(function(L){$e(L,gr(S[L],L),!0,!1,b)});var k=A.length===1?0:1;if(E&&p.hasNoSize()&&(b=!0,w[0]=0,A.length>1)){var O=100/(A.length-1);A.forEach(function(L){w[L]=L*O})}for(;k<A.length;++k)A.forEach(function(L){$e(L,w[L],!0,!0,b)});Lt(),A.forEach(function(L){Q("update",L),S[L]!==null&&g&&Q("set",L)})}function Jn(d){lt(e.start,d)}function Kn(d,g,b,S){if(d=Number(d),!(d>=0&&d<A.length))throw new Error("noUiSlider: invalid handle number, got: "+d);$e(d,gr(g,d),!0,!0,S),Q("update",d),b&&Q("set",d)}function mr(d){if(d===void 0&&(d=!1),d)return y.length===1?y[0]:y.slice(0);var g=y.map(e.format.to);return g.length===1?g[0]:g}function es(){for(Ye(Fe.aria),Ye(Fe.tooltips),Object.keys(e.cssClasses).forEach(function(d){yt(o,e.cssClasses[d])});o.firstChild;)o.removeChild(o.firstChild);delete o.noUiSlider}function vr(d){var g=w[d],b=p.getNearbySteps(g),S=y[d],E=b.thisStep.step,k=null;if(e.snap)return[S-b.stepBefore.startValue||null,b.stepAfter.startValue-S||null];E!==!1&&S+E>b.stepAfter.startValue&&(E=b.stepAfter.startValue-S),S>b.thisStep.startValue?k=b.thisStep.step:b.stepBefore.step===!1?k=!1:k=S-b.stepBefore.highestStep,g===100?E=null:g===0&&(k=null);var O=p.countStepDecimals();return E!==null&&E!==!1&&(E=Number(E.toFixed(O))),k!==null&&k!==!1&&(k=Number(k.toFixed(O))),[k,E]}function ts(){return A.map(vr)}function rs(d,g){var b=mr(),S=["margin","limit","padding","range","animate","snap","step","format","pips","tooltips","connect"];S.forEach(function(k){d[k]!==void 0&&(t[k]=d[k])});var E=Zn(t);S.forEach(function(k){d[k]!==void 0&&(e[k]=E[k])}),p=E.spectrum,e.margin=E.margin,e.limit=E.limit,e.padding=E.padding,e.pips?we(e.pips):z(),e.tooltips?_():f(),w=[],lt(Kt(d.start)?d.start:b,g),d.connect&&yr()}function yr(){for(;u.firstChild;)u.removeChild(u.firstChild);for(var d=0;d<=e.handles;d++)h[d]=be(u,e.connect[d]),Qe(d);hr({drag:e.events.drag,fixed:!0})}function ns(){U=!U,Wn(e,e.connect.map(function(d){return!d})),yr()}function ss(){a=le(o),te(e.connect,a),hr(e.events),lt(e.start),e.pips&&we(e.pips),e.tooltips&&_(),C()}ss();var ct={destroy:es,steps:ts,on:At,off:Ye,get:mr,set:lt,setHandle:Kn,reset:Jn,disable:x,enable:l,__moveHandles:function(d,g,b){fr(d,g,w,b)},options:t,updateOptions:rs,target:o,removePips:z,removeTooltips:f,getPositions:function(){return w.slice()},getTooltips:function(){return m},getOrigins:function(){return c},pips:we};return ct}function ya(r,e){if(!r||!r.nodeName)throw new Error("noUiSlider: create requires a single element, got: "+r);if(r.noUiSlider)throw new Error("noUiSlider: Slider was already initialized.");var t=Zn(e),n=va(r,t,e);return r.noUiSlider=n,n}const ba={__spectrum:Vn,cssClasses:Un,create:ya};class Xn{constructor(){this.playIntervals=new Map,this.playStates=new Map}_processRangeData(e,t,n){const s=e.map(p=>({value:parseInt(p.key,10),count:p.doc_count||0})).filter(p=>!isNaN(p.value)).sort((p,y)=>p.value-y.value),i=t.map(p=>({value:parseInt(p.key,10),count:p.doc_count||0})).filter(p=>!isNaN(p.value)).sort((p,y)=>p.value-y.value);if(s.length===0)throw new Error("No valid numeric values found in range data");const o=s.map(p=>p.value),a=i.map(p=>p.value),u=o[0],c=o[o.length-1],h=[...new Set(a)];let v,m;return n&&n.length===2?(v=Math.max(n[0],u),m=Math.min(n[1],c)):(v=h[0]||u,m=h[h.length-1]||c),{allBuckets:s,availableBuckets:i,sortedAvailableValues:h,minValue:u,maxValue:c,startValue:v,endValue:m}}_createRangeFacetDOM(e,t){const n=document.createElement("div");return n.className="facet-slider my-3",n.innerHTML=this._getRangeFacetHTML(e,t),n}_getRangeFacetHTML(e,{minValue:t,maxValue:n}){return`
      <div class="space-y-3">
        <!-- Play Controls -->
        <div class="flex items-center justify-center gap-2 pb-3 border-b border-gray-200">
          <button id="${e}-play-btn" class="group relative w-8 h-8 bg-gradient-to-r from-primary-400 to-primary-700 text-white text-xs rounded-full transition-colors duration-200 hover:from-primary-600 hover:to-primary-700 shadow-md hover:shadow-lg flex items-center justify-center" type="button">
            <div class="w-0 h-0 border-l-[5px] border-l-white border-y-[3px] border-y-transparent ml-0.5"></div>
            <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap">Play</span>
          </button>
          <button id="${e}-pause-btn" class="group relative w-8 h-8 bg-gradient-to-r from-secondary-400 to-secondary-700 text-white text-xs rounded-full transition-colors duration-200 hover:from-secondary-600 hover:to-secondary-700 shadow-md hover:shadow-lg flex items-center justify-center" type="button">
            <div class="flex gap-0.5">
              <div class="w-0.5 h-3 bg-white rounded-sm"></div>
              <div class="w-0.5 h-3 bg-white rounded-sm"></div>
            </div>
            <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap">Pause</span>
          </button>
        </div>

        <!-- Chart Container -->
        <div class="relative">
          <div id="${e}-chart" class="w-full h-16 mb-3 bg-gray-50 rounded-md p-2"></div>
        </div>
        
        <!-- Slider Container -->
        <div class="px-1">
          <div id="${e}-slider" class="slider-container"></div>
        </div>
        
        <!-- Value Display -->
        <div class="flex items-center justify-between text-xs text-gray-600 px-1">
          <span id="${e}-min-display" class="font-medium">${t}</span>
          <span id="${e}-max-display" class="font-medium">${n}</span>
        </div>
        
        <!-- Custom Range Inputs -->
        <div class="mt-4 pt-3 border-t border-gray-100">
          <div class="text-xs font-medium text-gray-700 mb-2">Custom range:</div>
          <div class="grid grid-cols-2 gap-2">
            <div class="min-w-0">
              <input id="${e}-min-input" type="number"
                    class="w-full px-2 py-1 text-xs border border-gray-200 rounded focus:ring-1 focus:ring-primary-400 focus:border-primary-400 focus:outline-none"
                    value="${t}"
                    placeholder="Min">
            </div>
            <div class="min-w-0">
              <input id="${e}-max-input" type="number"
                    class="w-full px-2 py-1 text-xs border border-gray-200 rounded focus:ring-1 focus:ring-primary-400 focus:border-primary-400 focus:outline-none"
                    value="${n}"
                    placeholder="Max">
            </div>
          </div>
        </div>
      </div>
    `}_getSliderElements(e,t){return{chartElement:e.querySelector(`#${t}-chart`),slider:e.querySelector(`#${t}-slider`),minInput:e.querySelector(`#${t}-min-input`),maxInput:e.querySelector(`#${t}-max-input`),minDisplay:e.querySelector(`#${t}-min-display`),maxDisplay:e.querySelector(`#${t}-max-display`),playBtn:e.querySelector(`#${t}-play-btn`),pauseBtn:e.querySelector(`#${t}-pause-btn`)}}_initializeSlider(e,t){ba.create(e,{start:[t.startValue,t.endValue],connect:!0,step:1,range:{min:t.minValue,max:t.maxValue},format:{to:n=>Math.round(n),from:n=>parseInt(n,10)}}),e.classList.add("custom-slider")}_setupEventHandlers(e,t,n,s){t.slider.noUiSlider.on("update",i=>{const[o,a]=i.map(u=>Math.round(Number(u)));t.minDisplay.textContent=o.toString(),t.maxDisplay.textContent=a.toString(),document.activeElement!==t.minInput&&(t.minInput.value=o),document.activeElement!==t.maxInput&&(t.maxInput.value=a)}),t.slider.noUiSlider.on("change",i=>{const[o,a]=i.map(u=>Math.round(Number(u)));!isNaN(o)&&!isNaN(a)&&o>=n.minValue&&a<=n.maxValue&&this._updateRange(e,[o,a],s,t.chartElement,n.allBuckets,n)}),t.minInput.addEventListener("change",i=>{this._handleInputChange(i.target,!0,e,t,n,s)}),t.maxInput.addEventListener("change",i=>{this._handleInputChange(i.target,!1,e,t,n,s)}),[t.minInput,t.maxInput].forEach(i=>{i.addEventListener("keypress",o=>{o.key==="Enter"&&o.target.blur()})}),this.setupPlayControls(e,t.playBtn,t.pauseBtn,t.slider,n.sortedAvailableValues,s,t.chartElement,n.allBuckets)}_validateAndClampInput(e,t,n){const s=parseInt(e,10);return isNaN(s)?null:Math.max(t,Math.min(n,s))}_storeSliderReferences(e,t,n){e.slider=t.slider,e.sortedValues=n.sortedAvailableValues,Object.assign(e,t),e.cleanup=()=>{t.slider.noUiSlider&&t.slider.noUiSlider.destroy(),this.playStates.delete(e.facetKey)}}setupPlayControls(e,t,n,s,i,o,a,u){t.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation(),this.startPlay(e,t,n,s,i,o,a,u)}),n.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation(),this.pausePlay(e,t,n)})}startPlay(e,t,n,s,i,o,a,u){if(this.playIntervals.has(e))return;const[c,h]=s.noUiSlider.get().map(Number),v=this._findClosestDatasetValue(i,c),m=this._findClosestDatasetValue(i,h);let p=this.playStates.get(e);if(p)p.currentMaxIndex>=p.maxLimitIndex&&(p.currentMaxIndex=p.startMinIndex,this.playStates.set(e,p));else{const w=i.indexOf(v),A=i.indexOf(m);p={startMinIndex:w,currentMaxIndex:w,maxLimitIndex:A,originalMin:v,originalMax:m},this.playStates.set(e,p)}const y=setInterval(()=>{const w=this.playStates.get(e);if(!w){clearInterval(y),this.playIntervals.delete(e);return}let{startMinIndex:A,currentMaxIndex:F,maxLimitIndex:T}=w;if(F=Math.min(F+1,T),F>=T){const X=i[A],I=i[T];s.noUiSlider.set([X,I]);const P=s.closest(".facet-slider");P.minValue,P.maxValue,o({type:"RANGE_CHANGE",facetKey:e,value:[X,I]}),this.updateChartHighlight(a,u,X,I),this.playStates.delete(e),this.pausePlay(e,t,n);return}this.playStates.set(e,{...w,currentMaxIndex:F});const U=i[A],$=i[F];s.noUiSlider.set([U,$]),o({type:"RANGE_CHANGE",facetKey:e,value:[U,$]}),this.updateChartHighlight(a,u,U,$)},500);this.playIntervals.set(e,y)}pausePlay(e,t,n){const s=this.playIntervals.get(e);s&&(clearInterval(s),this.playIntervals.delete(e))}_updateRange(e,[t,n],s,i,o,a){this.playStates.delete(e);let u;t===a.minValue&&n===a.maxValue?u=null:u=[t,n],s({type:"RANGE_CHANGE",facetKey:e,value:u}),this.updateChartHighlight(i,o,t,n)}_handleInputChange(e,t,n,s,i,o){const a=this._validateAndClampInput(e.value,i.minValue,i.maxValue);if(a===null)return;const[u,c]=s.slider.noUiSlider.get().map(Number),h=t?[Math.max(i.minValue,Math.min(a,c)),c]:[u,Math.min(i.maxValue,Math.max(a,u))];this._updateRange(n,h,o,s.chartElement,i.allBuckets,i),s.slider.noUiSlider.set(h)}_findClosestDatasetValue(e,t){if(e.length===0)return t;if(t<=e[0])return e[0];if(t>=e[e.length-1])return e[e.length-1];let n=0,s=e.length-1;for(;n<=s;){const a=Math.floor((n+s)/2),u=e[a];if(u===t)return u;u<t?n=a+1:s=a-1}if(s<0)return e[0];if(n>=e.length)return e[e.length-1];const i=Math.abs(e[n]-t),o=Math.abs(e[s]-t);return i<=o?e[n]:e[s]}updateChartHighlight(e,t,n,s){const i=e.querySelector(".flex.items-end");if(!i){console.warn("Bars container not found");return}i.querySelectorAll("[data-value]").forEach(a=>{const u=parseInt(a.dataset.value),c=parseInt(a.dataset.count);u>=n&&u<=s?c>0?a.style.backgroundColor="#d1d5db":a.style.backgroundColor="#bfdbfe":a.style.backgroundColor="#d1d5db"})}renderBarChart(e,t,n,s,i,o=null){e.innerHTML="";const a=Math.max(...n.map(v=>v.count),1);this.sortedAllBuckets=[...t].sort((v,m)=>v.value-m.value);const u=document.createElement("div");u.className="w-full h-full flex flex-col",e.appendChild(u);const c=document.createElement("div");c.className="w-full flex-1 rounded px-1 overflow-hidden",c.style.height="150px",u.appendChild(c);const h=document.createElement("div");h.className="flex items-end w-full h-full",c.appendChild(h),this.sortedAllBuckets.forEach(v=>{const m=v.count>0?v.count/a*90:2,p=document.createElement("div");p.className="flex-1 mx-px transition-colors duration-200",p.style.height=`${Math.max(m,1)}%`,p.dataset.value=v.value,p.dataset.count=v.count,v.count>0?(p.title=`Value: ${v.value}, Count: ${v.count}`,p.style.backgroundColor="#3b82f6"):(p.title=`Value: ${v.value}, No data available`,p.style.backgroundColor="#d1d5db"),h.appendChild(p)})}_renderEmptyRangeFacet(e,t){const n=document.createElement("div");return n.className="facet-slider my-3 text-center text-gray-500 py-4",n.innerHTML='<p class="text-sm">No data available for this range</p>',e.appendChild(n),n}_renderRangeFacet(e,t,n,s,i,o,a){const u=s[t]||[],c=u.filter(w=>w.doc_count>0);if(!u||u.length===0)return this._renderEmptyRangeFacet(e,t);const h=this._processRangeData(u,c,o.filters[t]);if(h.sortedAvailableValues.length===0){const w=document.createElement("div");return w.className="facet-slider my-3 text-center text-gray-500 py-4",w.innerHTML=`
        <p class="text-sm">No values available with current filters</p>
        <p class="text-xs text-gray-400">Range: ${h.minValue} - ${h.maxValue}</p>
      `,e.appendChild(w),w}const v=h.sortedAvailableValues[0],m=h.sortedAvailableValues[h.sortedAvailableValues.length-1];if(v===m){const w=v+1;h.sliderMax=w,h.endValue=v}const p=this._createRangeFacetDOM(t,{minValue:h.minValue,maxValue:h.maxValue});e.appendChild(p);const y=this._getSliderElements(p,t);return this.renderBarChart(y.chartElement,h.allBuckets,h.availableBuckets,h.minValue,h.maxValue),this._initializeSlider(y.slider,h),this._setupEventHandlers(t,y,h,a),this.updateChartHighlight(y.chartElement,h.allBuckets,h.startValue,h.endValue),this._storeSliderReferences(p,y,h),p}}class wa{constructor(e){this.config=e,this.taxonomyRenderer=new Hn,this.rangeRenderer=new Xn,this.searchTerms={}}renderFacets(e,t,n){if(!e||!this.config.aggregations){console.error("No aggregations data or configuration available.");return}const s=document.getElementById("facets-container"),i=this._getCheckedState();s.innerHTML="";const o={};Object.entries(this.config.aggregations).forEach(([a,u])=>{const c=u.category||"Other";o[c]||(o[c]=[]),o[c].push({facetKey:a,facetConfig:u})}),Object.entries(o).forEach(([a,u])=>{const c=document.createElement("div");c.className="facet-category",c.setAttribute("data-category",a);const h=document.createElement("h3");h.className="facet-category-title",h.textContent=a,c.appendChild(h);const v=document.createElement("div");v.className="facet-category-content",u.forEach(({facetKey:m,facetConfig:p})=>{const y=this._createFacetGroup(m,p);p.type==="range"?this.rangeRenderer._renderRangeFacet(y,m,p,e,i,t,n):p.type==="taxonomy"?this.taxonomyRenderer._renderTaxonomyFacet(y,m,p,e,i,n):p.type==="simple"&&this._renderStandardFacet(y,m,p,e,i),v.appendChild(y)}),c.appendChild(v),s.appendChild(c)}),this._addFacetEventListeners(n)}_filterFacetOptions(e,t){const n=e.querySelectorAll("label");let s=0;n.forEach(i=>{const o=i.textContent.toLowerCase(),a=t===""||o.includes(t);i.classList.toggle("facet-hidden",!a),a&&s++}),this._showNoResultsMessage(e,s===0&&t!=="")}_showNoResultsMessage(e,t){let n=e.querySelector(".no-results-disclaimer");t?(n||(n=document.createElement("div"),n.className="no-results-disclaimer",n.textContent="Nessun risultato per questa ricerca",n.style.cssText="padding: 10px; color: #666; font-style: italic;",e.appendChild(n)),n.style.display="block"):n&&(n.style.display="none"),e.style.display="block"}_updateCategoryVisibility(){document.querySelectorAll(".facet-category").forEach(t=>{const n=t.querySelectorAll('.facet-group[style*="display: block"], .facet-group:not([style*="display: none"])'),s=Array.from(n).some(i=>i.style.display!=="none");t.style.display=s?"block":"none"})}_getCheckedState(){const e={};return Object.keys(this.config.aggregations).forEach(t=>{const n=document.getElementById(`${t}-facet`);n&&(e[t]=Array.from(n.querySelectorAll("input:checked")).map(s=>s.value))}),e}_createFacetGroup(e,t){const n=document.createElement("div");n.className="facet-group mb-4 p-4 bg-white rounded-lg shadow",n.id=`${e}-facet`;const s=document.createElement("div");s.className="facet-header mb-3";const i=document.createElement("h3");if(i.className="text-lg font-semibold mb-2",i.textContent=t.title||e,s.appendChild(i),t.type=="simple"){const o=document.createElement("div");o.className="facet-search mb-2";const a=document.createElement("input");a.type="text",a.className="facet-search-input w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary-500",a.placeholder="Cerca...",a.id=`search-${e}`;const u=this._debounce(c=>{this._searchWithinFacet(e,c)},300);a.addEventListener("input",c=>{u(c.target.value)}),o.appendChild(a),s.appendChild(o)}return n.appendChild(s),n}_searchWithinFacet(e,t){const n=document.getElementById(`${e}-facet`);n&&(this.searchTerms[e]=t.toLowerCase().trim(),this._filterFacetOptions(n,this.searchTerms[e]))}_renderStandardFacet(e,t,n,s,i){const o=document.createElement("div");o.className="facet-options space-y-2",(s[t]||[]).forEach(u=>{var y;const c=document.createElement("label");c.className="cursor-pointer block facet-option flex items-center justify-between",c.style.display="flex",c.setAttribute("data-search-text",u.key.toLowerCase()),u.doc_count===0&&c.classList.add("text-gray-400");const h=document.createElement("div");h.className="flex items-center";const v=document.createElement("input");v.type="checkbox",v.value=u.key,v.className="form-checkbox mr-2",v.dataset.facetType=t,(y=i[t])!=null&&y.includes(u.key)&&(v.checked=!0);const m=document.createElement("span");m.textContent=u.key,m.className="text-sm";const p=document.createElement("span");p.textContent=u.doc_count,p.className=`text-xs text-secondary-500 bg-secondary-100 px-2 py-0.5 rounded-full flex-shrink-0 ml-auto ${u.doc_count===0?"text-seconday-800 bg-secondary-100":""}`,h.appendChild(v),h.appendChild(m),c.appendChild(h),c.appendChild(p),o.appendChild(c)}),e.appendChild(o)}_addFacetEventListeners(e){if(!this.config.aggregations){console.error("Aggregations configuration not found");return}Object.keys(this.config.aggregations).forEach(t=>{const n=document.getElementById(`${t}-facet`);n&&n.querySelectorAll('input[type="checkbox"]').forEach(s=>{s.addEventListener("change",i=>{this._onFacetChange(i,e)})})})}_onFacetChange(e,t){const{value:n,checked:s}=e.target,i=e.target.dataset.facetType;t({type:"FACET_CHANGE",facetType:i,value:n,checked:s})}clearAllSearches(){this.searchTerms={},Object.keys(this.config.aggregations).forEach(s=>{const i=document.getElementById(`search-${s}`);i&&(i.value="")}),document.querySelectorAll(".facet-option, label").forEach(s=>{s.style.display="block"}),document.querySelectorAll(".facet-group").forEach(s=>{s.style.display="block"}),document.querySelectorAll(".facet-category").forEach(s=>{s.style.display="block"})}_debounce(e,t){let n;return function(){clearTimeout(n),n=setTimeout(()=>e.apply(this,arguments),t)}}}class xa{constructor(e,t){this.searchEngine=e,this.config=t}performSearch(e,t={}){if(!this.searchEngine){console.error("Search engine not initialized");return}const{filters:n}=e,{regularFilters:s,dateFilters:i,taxonomyFilters:o}=this._separateFilters(n),a=this.searchEngine.search({query:e.query||"",filters:s,sort:e.sort||"title_asc",per_page:526,filter:c=>this._customFilter(c,i,o)}),u=this._extractCoordinates(a.data.items);if(t.onMarkersUpdate&&t.onMarkersUpdate(a.data.items),t.onResultsUpdate&&t.onResultsUpdate(a.data.items),t.onAggregationsUpdate){const c=this._formatAggregations(a.data.aggregations);t.onAggregationsUpdate(c)}return{items:a.data.items,coordinates:u,aggregations:this._formatAggregations(a.data.aggregations)}}_separateFilters(e){const t={},n={},s={};return Object.entries(e).forEach(([i,o])=>{if(!o||o.length===0)return;const a=this.config.aggregations[i];if(a)switch(a.type){case"range":n[i]=o;break;case"taxonomy":s[i]=o;break;default:t[i]=o}}),{regularFilters:t,dateFilters:n,taxonomyFilters:s}}_customFilter(e,t,n){for(const[s,i]of Object.entries(t))if(i.length===2){const[o,a]=i,u=new Date(e[s]).getTime();if(!(u>=o&&u<=a))return!1}for(const[s,i]of Object.entries(n)){if(!e[s])return!1;const o=e[s];let a;if(Array.isArray(o)?a=o.length>0?String(o[0]):"":typeof o=="string"?a=o:a=String(o||""),!i.some(c=>a===c||a.startsWith(c+" > ")))return!1}return!0}_extractCoordinates(e){return e.filter(t=>t.lat_long&&t.lat_long.length>0).map(t=>{const n=t.lat_long[0],[s,i]=n.split(",");return[parseFloat(s),parseFloat(i)]})}_formatAggregations(e){const t={};for(const n in e)e.hasOwnProperty(n)&&(t[n]=e[n].buckets);return t}}class _a{constructor(e,t=null){this.mapFocusCallback=e,this.config=t,this.allWorks=[],this.items=[],this.searchState=null,this.isModalOpen=!1,this.currentModalIndex=0,this.isAnimating=!1}setData(e,t){this.allWorks=e,this.items=t}setConfig(e){this.config=e}setSearchState(e){this.searchState=e}_getCompleteWorkData(e){const t=this.items.filter(o=>o.pivot_ID===e);if(t.length===0)return null;const n=t[0],s={pivot_ID:e,Title:n[window.ledaSearch.config.result_cards.card_title],Subtitle:n[window.ledaSearch.config.result_cards.card_subtitle],Subtitle2:n[window.ledaSearch.config.result_cards.card_subtitle_2],Location:[],coordinates:[],allEntries:t,geodataBySpace:new Map},i=new Map;return t.forEach(o=>{o.Location&&(Array.isArray(o.Location)?o.Location:[o.Location]).forEach((u,c)=>{if(!i.has(u)){const h=this._extractCoordinates(o,c);i.set(u,h);const v=this._getGeodataFields(),m={};v.forEach(p=>{o[p]!==void 0&&o[p]!==null&&o[p]!==""&&(Array.isArray(o[p])&&o[p].length>c?m[p]=o[p][c]:Array.isArray(o[p])||(m[p]=o[p]))}),s.geodataBySpace.set(u,m)}})}),s.Location=Array.from(i.keys()),s.coordinates=Array.from(i.values()),s}_getCatalogueFields(){var e,t,n;return((n=(t=(e=this.config)==null?void 0:e.datasetConfig)==null?void 0:t.fields)==null?void 0:n.catalogue)||[]}_getGeodataFields(){var e,t,n;return((n=(t=(e=this.config)==null?void 0:e.datasetConfig)==null?void 0:t.fields)==null?void 0:n.geodata)||[]}_getAllMetadataFields(){const e=this._getCatalogueFields(),t=this._getGeodataFields();return[...new Set([...e,...t])]}_renderSelectedFilters(){if(!this.searchState||!this.searchState.filters)return"";const e=[];return this.searchState.query&&this.searchState.query.trim()&&e.push(`
        <div class="inline-flex items-center gap-2 px-3 py-1 bg-secondary-100 text-secondary-800 rounded-full text-sm font-medium">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
            <path fill-rule="evenodd" d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z" clip-rule="evenodd" />
          </svg>
          <span>Ricerca: "${this.searchState.query}"</span>
        </div>
      `),Object.entries(this.searchState.filters).forEach(([t,n])=>{Array.isArray(n)&&n.length>0?n.forEach(s=>{e.push(`
            <div class="inline-flex items-center gap-2 px-3 py-1 bg-primary-100 text-primary-800 rounded-full text-sm font-medium">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
                <path d="M2 3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1a1 1 0 0 1-.293.707L10 8.414V12a1 1 0 0 1-.293.707l-2 2A1 1 0 0 1 6 14v-5.586L2.293 4.707A1 1 0 0 1 2 4V3Z" />
              </svg>
              <span>${t}: ${s}</span>
            </div>
          `)}):n&&!Array.isArray(n)&&e.push(`
          <div class="inline-flex items-center gap-2 px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
              <path d="M2 3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1a1 1 0 0 1-.293.707L10 8.414V12a1 1 0 0 1-.293.707l-2 2A1 1 0 0 1 6 14v-5.586L2.293 4.707A1 1 0 0 1 2 4V3Z" />
            </svg>
            <span>${t}: ${n}</span>
          </div>
        `)}),e.length===0?"":`
      <div class="flex flex-wrap items-center gap-2 bg-white/80 backdrop-blur-sm rounded-xl px-4 py-3 shadow-md ring-1 ring-gray-200/50 border border-gray-200/30">
        <div class="text-sm font-medium text-gray-700 mr-2">Filtri attivi:</div>
        ${e.join("")}
      </div>
    `}async toggleModal(e){this.isAnimating||(this.isModalOpen?await this._closeModal():(this.currentModalIndex=e,await this._openModal()))}async _openModal(){this.isAnimating=!0;let e=document.getElementById("works-modal");e||(e=this._createModal(),document.body.appendChild(e)),e.classList.remove("hidden"),e.style.opacity="0";const t=e.querySelector(".modal-container");t&&(t.style.transform="scale(0.8) translateY(20px)",t.style.opacity="0"),this._populateModal(),this.isModalOpen=!0,document.body.style.overflow="hidden",e.offsetHeight,e.style.transition="opacity 300ms cubic-bezier(0.4, 0, 0.2, 1)",e.style.opacity="1",t&&(t.style.transition="all 400ms cubic-bezier(0.34, 1.56, 0.64, 1)",t.style.transform="scale(1) translateY(0)",t.style.opacity="1"),setTimeout(()=>{this._animateContentItems(),this.isAnimating=!1},200)}async _closeModal(){if(!this.isModalOpen)return;this.isAnimating=!0;const e=document.getElementById("works-modal");if(e){const t=e.querySelector(".modal-container");e.style.transition="opacity 250ms cubic-bezier(0.4, 0, 1, 1)",e.style.opacity="0",t&&(t.style.transition="all 250ms cubic-bezier(0.4, 0, 1, 1)",t.style.transform="scale(0.95) translateY(-10px)",t.style.opacity="0"),await new Promise(n=>setTimeout(n,250)),e.classList.add("hidden"),e.style.opacity="",t&&(t.style.transform="",t.style.opacity="")}this.isModalOpen=!1,document.body.style.overflow="auto",this.isAnimating=!1}_animateContentItems(){const e=document.querySelector(".modal-header");e&&(e.style.opacity="0",e.style.transform="translateY(-20px)",e.style.transition="all 500ms cubic-bezier(0.4, 0, 0.2, 1)",setTimeout(()=>{e.style.opacity="1",e.style.transform="translateY(0)"},100));const t=document.querySelector(".filters-section");t&&(t.style.opacity="0",t.style.transform="translateY(-10px)",t.style.transition="all 400ms cubic-bezier(0.4, 0, 0.2, 1)",setTimeout(()=>{t.style.opacity="1",t.style.transform="translateY(0)"},150)),document.querySelectorAll(".metadata-card").forEach((i,o)=>{i.style.opacity="0",i.style.transform="translateY(20px)",i.style.transition="all 400ms cubic-bezier(0.4, 0, 0.2, 1)",setTimeout(()=>{i.style.opacity="1",i.style.transform="translateY(0)"},200+o*50)}),document.querySelectorAll(".space-card").forEach((i,o)=>{i.style.opacity="0",i.style.transform="translateX(-20px)",i.style.transition="all 500ms cubic-bezier(0.4, 0, 0.2, 1)",setTimeout(()=>{i.style.opacity="1",i.style.transform="translateX(0)"},300+o*75)})}_createModal(){const e=document.createElement("div");return e.id="works-modal",e.className="fixed inset-0 bg-gradient-to-br from-slate-900/90 to-gray-900/90 backdrop-blur-md z-50 hidden flex items-center justify-center p-4",e.innerHTML=`
      <div class="modal-container relative w-full max-w-7xl h-[90vh] overflow-hidden">
        <!-- Enhanced Header with Close Button and Filters -->
        <div class="absolute top-0 left-0 right-0 px-6 py-4 z-20">
          <div class="flex items-center justify-between">
            <!-- Filters section on the left -->
            <div class="filters-section flex-1 mr-6">
              <!-- Filters will be populated here -->
            </div>
            
            <!-- Close button on the right -->
            <button id="close-modal-btn" class="p-3 bg-white/90 hover:bg-white active:bg-gray-100 rounded-full text-gray-600 hover:text-red-500 shadow-lg hover:shadow-xl transition-all duration-300 group backdrop-blur-sm border border-gray-200/50 hover:border-red-200 flex-shrink-0">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 group-hover:rotate-90 transition-transform duration-300">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
        
        <!-- Content Container with fixed width to prevent resizing -->
        <div id="modal-content" class="h-full pt-20 pb-16 rounded-2xl w-full max-w-none overflow-hidden"></div>
        
        <!-- Enhanced Footer with Progress Indicator -->
        <div class="absolute bottom-0 left-0 right-0 px-6 py-4 z-20">
          <div class="flex items-center justify-center">
            <span id="modal-progress" class="text-sm font-semibold text-gray-700 bg-white/90 backdrop-blur-sm px-6 py-3 rounded-full shadow-lg ring-1 ring-white/20 border border-gray-200/50 transition-all duration-300 hover:shadow-xl">
            </span>
          </div>
        </div>
      </div>
    `,e.addEventListener("click",t=>{t.target===e&&this._closeModal()}),e.querySelector("#close-modal-btn").addEventListener("click",()=>{this._closeModal()}),document.addEventListener("keydown",t=>{!this.isModalOpen||this.isAnimating||(t.key==="Escape"?this._closeModal():t.key==="ArrowLeft"?this._navigateModal(-1):t.key==="ArrowRight"&&this._navigateModal(1))}),e}async _navigateModal(e){if(this.isAnimating)return;const t=this.currentModalIndex+e;if(t>=0&&t<this.allWorks.length){this.isAnimating=!0;const n=document.getElementById("modal-content");if(!n)return;const s=n.querySelector(".main-content-panel");if(!s)return;const i=document.createElement("div");i.className="relative w-full h-full overflow-hidden";const o=document.createElement("div");o.className="absolute inset-0 w-full h-full transition-transform duration-500 ease-out overflow-y-auto bg-white/95 backdrop-blur-sm rounded-xl shadow-xl border border-gray-200/50 ring-1 ring-white/20",o.innerHTML=s.innerHTML;const a=document.createElement("div");a.className="absolute inset-0 w-full h-full transition-transform duration-500 ease-out overflow-y-auto bg-white/95 backdrop-blur-sm rounded-xl shadow-xl border border-gray-200/50 ring-1 ring-white/20";const u="100%";a.style.transform=`translateX(${e>0?u:`-${u}`})`,this.currentModalIndex=t;const c=this.allWorks[this.currentModalIndex],h=this._getCompleteWorkData(c.pivot_ID);h&&(a.innerHTML=this._renderMainCard(h)),s.parentNode.replaceChild(i,s),i.appendChild(o),i.appendChild(a),this._updateNavigationButtons(),i.offsetHeight,o.style.transform=`translateX(${e>0?`-${u}`:u})`,a.style.transform="translateX(0)",o.style.opacity="0.8",a.style.opacity="1",await new Promise(p=>setTimeout(p,500));const v=document.createElement("div");v.className="main-content-panel flex-1 min-w-0 overflow-y-auto bg-white/95 backdrop-blur-sm rounded-xl shadow-xl hover:shadow-2xl transition-all duration-500 border border-gray-200/50 ring-1 ring-white/20",v.innerHTML=a.innerHTML,i.parentNode.replaceChild(v,i);const m=document.getElementById("modal-progress");m&&(m.textContent=`${this.currentModalIndex+1} di ${this.allWorks.length}`),this._addMapFocusListeners(),setTimeout(()=>{this._animateContentItems(),this.isAnimating=!1},100)}}_updateNavigationButtons(){const e=document.getElementById("prev-work-btn"),t=document.getElementById("next-work-btn");e&&(this.currentModalIndex===0?(e.disabled=!0,e.className=e.className.replace("hover:scale-110 hover:-translate-y-1","opacity-40 cursor-not-allowed")):(e.disabled=!1,e.className=e.className.replace("opacity-40 cursor-not-allowed","hover:scale-110 hover:-translate-y-1"))),t&&(this.currentModalIndex===this.allWorks.length-1?(t.disabled=!0,t.className=t.className.replace("hover:scale-110 hover:-translate-y-1","opacity-40 cursor-not-allowed")):(t.disabled=!1,t.className=t.className.replace("opacity-40 cursor-not-allowed","hover:scale-110 hover:-translate-y-1"))),this._updatePreviewCards()}_updatePreviewCards(){const e=this.currentModalIndex>0?this.allWorks[this.currentModalIndex-1]:null,t=this.currentModalIndex<this.allWorks.length-1?this.allWorks[this.currentModalIndex+1]:null,n=e?this._getCompleteWorkData(e.pivot_ID):null,s=t?this._getCompleteWorkData(t.pivot_ID):null,i=document.querySelector(".left-nav-panel .preview-card");i&&(n?(i.className="preview-card text-center bg-white/90 backdrop-blur-sm rounded-xl shadow-lg ring-1 ring-gray-200/50 border border-gray-200/30 px-4 py-6 w-48 transition-all duration-300 hover:shadow-xl hover:-translate-y-1",i.innerHTML=`
          <div class="w-12 h-1 bg-gradient-to-r from-secondary-400 to-secondary-600 rounded-full mx-auto mb-4"></div>
          <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${n.Title}</h4>
          <p class="text-xs text-gray-600 font-medium">${n.Subtitle}</p>
          <p class="text-xs text-gray-500">(${n.Subtitle2})</p>
        `):(i.className="preview-card text-center px-4 py-6 bg-gray-50/80 backdrop-blur-sm rounded-xl border-2 border-dashed border-gray-300/50 w-48",i.innerHTML='<div class="text-sm text-gray-400 font-medium">Nessuna opera precedente</div>'));const o=document.querySelector(".right-nav-panel .preview-card");o&&(s?(o.className="preview-card text-center px-4 py-6 bg-white/90 backdrop-blur-sm rounded-xl shadow-lg ring-1 ring-gray-200/50 border border-gray-200/30 w-48 transition-all duration-300 hover:shadow-xl hover:-translate-y-1",o.innerHTML=`
          <div class="w-12 h-1 bg-gradient-to-r from-secondary-400 to-secondary-600 rounded-full mx-auto mb-4"></div>
          <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${s.Title}</h4>
          <p class="text-xs text-gray-600 font-medium">${s.Subtitle}</p>
          <p class="text-xs text-gray-500">(${s.Subtitle2})</p>
        `):(o.className="preview-card text-center px-4 py-6 bg-gray-50/80 backdrop-blur-sm rounded-xl border-2 border-dashed border-gray-300/50 w-48",o.innerHTML='<div class="text-sm text-gray-400 font-medium">Nessuna opera successiva</div>'))}_addNavigationListeners(){const e=document.getElementById("prev-work-btn"),t=document.getElementById("next-work-btn");e&&this.currentModalIndex>0&&e.addEventListener("click",()=>this._navigateModal(-1)),t&&this.currentModalIndex<this.allWorks.length-1&&t.addEventListener("click",()=>this._navigateModal(1))}_populateModal(){const e=document.getElementById("modal-content"),t=document.getElementById("modal-progress"),n=document.querySelector(".filters-section");if(!e)return;n&&(n.innerHTML=this._renderSelectedFilters());const s=this.allWorks[this.currentModalIndex],i=this._getCompleteWorkData(s.pivot_ID),o=this.currentModalIndex>0?this.allWorks[this.currentModalIndex-1]:null,a=this.currentModalIndex<this.allWorks.length-1?this.allWorks[this.currentModalIndex+1]:null,u=o?this._getCompleteWorkData(o.pivot_ID):null,c=a?this._getCompleteWorkData(a.pivot_ID):null;if(!i){e.innerHTML='<div class="flex items-center justify-center h-full text-gray-500 text-lg">Dati non disponibili</div>';return}e.innerHTML=`
      <div class="flex h-full w-full">
        <!-- Enhanced Left Navigation Panel with fixed width -->
        <div class="left-nav-panel flex flex-col items-center justify-center p-6 space-y-6 w-64 flex-shrink-0">
          <button id="prev-work-btn" class="group p-4 bg-white/90 hover:bg-white active:bg-gray-50 rounded-2xl text-gray-600 hover:text-secondary-600 transition-all duration-300 shadow-lg hover:shadow-xl ring-1 ring-gray-200/50 hover:ring-secondary-200 backdrop-blur-sm border border-gray-200/30 ${this.currentModalIndex===0?"opacity-40 cursor-not-allowed":"hover:scale-110 hover:-translate-y-1"}" ${this.currentModalIndex===0?"disabled":""}>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 group-hover:-translate-x-1 transition-transform duration-300">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
            </svg>
          </button>
          
          ${u?`
            <div class="preview-card text-center bg-white/90 backdrop-blur-sm rounded-xl shadow-lg ring-1 ring-gray-200/50 border border-gray-200/30 px-4 py-6 w-48 transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
              <div class="w-12 h-1 bg-gradient-to-r from-secondary-400 to-secondary-600 rounded-full mx-auto mb-4"></div>
              <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${u.Title}</h4>
              <p class="text-xs text-gray-600 font-medium">${u.Subtitle}</p>
              <p class="text-xs text-gray-500">(${u.Subtitle2})</p>
            </div>
          `:`
            <div class="preview-card text-center px-4 py-6 bg-gray-50/80 backdrop-blur-sm rounded-xl border-2 border-dashed border-gray-300/50 w-48">
              <div class="text-sm text-gray-400 font-medium">Nessuna opera precedente</div>
            </div>
          `}
        </div>

        <!-- Enhanced Main Content Area with fixed flex properties -->
        <div class="main-content-panel flex-1 min-w-0 overflow-y-auto bg-white/95 backdrop-blur-sm rounded-xl shadow-xl hover:shadow-2xl transition-all duration-500 border border-gray-200/50 ring-1 ring-white/20">
          ${this._renderMainCard(i)}
        </div>

        <!-- Enhanced Right Navigation Panel with fixed width -->
        <div class="right-nav-panel flex flex-col items-center justify-center p-6 space-y-6 w-64 flex-shrink-0">
          <button id="next-work-btn" class="group p-4 bg-white/90 hover:bg-white active:bg-gray-50 rounded-2xl text-gray-600 hover:text-secondary-600 transition-all duration-300 shadow-lg hover:shadow-xl ring-1 ring-gray-200/50 hover:ring-secondary-200 backdrop-blur-sm border border-gray-200/30 ${this.currentModalIndex===this.allWorks.length-1?"opacity-40 cursor-not-allowed":"hover:scale-110 hover:-translate-y-1"}" ${this.currentModalIndex===this.allWorks.length-1?"disabled":""}>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 group-hover:translate-x-1 transition-transform duration-300">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
            </svg>
          </button>
          
          ${c?`
            <div class="preview-card text-center px-4 py-6 bg-white/90 backdrop-blur-sm rounded-xl shadow-lg ring-1 ring-gray-200/50 border border-gray-200/30 w-48 transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
              <div class="w-12 h-1 bg-gradient-to-r from-secondary-400 to-secondary-600 rounded-full mx-auto mb-4"></div>
              <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${c.Title}</h4>
              <p class="text-xs text-gray-600 font-medium">${c.Subtitle}</p>
              <p class="text-xs text-gray-500">(${c.Subtitle2})</p>
            </div>
          `:`
            <div class="preview-card text-center px-4 py-6 bg-gray-50/80 backdrop-blur-sm rounded-xl border-2 border-dashed border-gray-300/50 w-48">
              <div class="text-sm text-gray-400 font-medium">Nessuna opera successiva</div>
            </div>
          `}
        </div>
      </div>
    `,t&&(t.textContent=`${this.currentModalIndex+1} di ${this.allWorks.length}`),this._addNavigationListeners(),this._addMapFocusListeners()}_renderMainCard(e){const t=e.allEntries[0],n=this._renderCombinedMetadata(t),s=this._renderGeographicalSpaces(e);return`
      <div class="p-8 space-y-8 w-full">
        <!-- Enhanced Header Section -->
        <div class="modal-header bg-gradient-to-r from-slate-50/90 to-gray-50/90 backdrop-blur-sm rounded-2xl p-8 ring-1 ring-gray-200/50 border border-gray-200/30">
          <div class="flex items-start justify-between">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-1 h-12 bg-gradient-to-b from-secondary-500 to-secondary-600 rounded-full shadow-sm flex-shrink-0"></div>
                <div class="min-w-0 flex-1">
                  <h1 class="text-3xl font-bold text-gray-900 leading-tight truncate">${e.Title}</h1>
                  <div class="flex items-center gap-4 mt-2">
                    <p class="text-lg text-gray-700 font-medium truncate">${e.Subtitle}</p>
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full flex-shrink-0"></span>
                    <p class="text-lg text-gray-600 font-mono flex-shrink-0">${e.Subtitle2}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        ${n}
        ${s}
      </div>
    `}_renderCombinedMetadata(e){const t=this._getCatalogueFields(),n=[],s=t.filter(i=>!n.includes(i)&&e[i]!=null&&e[i]!=="").map(i=>{const o=e[i];let a=o;return Array.isArray(o)?a=o.join(", "):typeof o=="string"&&o.length>150&&(a=o.substring(0,147)+"..."),`
          <div class="metadata-card group bg-white/90 hover:bg-white backdrop-blur-sm hover:shadow-lg rounded-xl p-5 ring-1 ring-gray-200/50 hover:ring-gray-300/70 transition-all duration-300 border border-gray-200/30 hover:border-gray-300/50 hover:-translate-y-0.5">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-2 h-2 bg-gradient-to-r from-primary-400 to-primary-600 rounded-full group-hover:scale-125 transition-transform duration-300 shadow-sm"></div>
              <h4 class="text-sm font-semibold text-gray-800 uppercase tracking-wide">${i}</h4>
            </div>
            <div class="text-base text-gray-700 leading-relaxed pl-5">${a}</div>
          </div>
        `}).join("");return s?`
      <div>
        <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-primary-600">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0-1.125.504-1.125 1.125V11.25a9 9 0 0 0-9-9Z" />
          </svg>
          Metadati del catalogo
        </h2>
        <div class="grid gap-4">
          ${s}
        </div>
      </div>
    `:""}_renderGeographicalSpaces(e){return!e.Location||e.Location.length===0?`
        <div class="bg-gradient-to-r from-secondary-50/90 to-indigo-50/90 backdrop-blur-sm rounded-2xl p-8 ring-1 ring-secondary-200/50 border border-secondary-200/30">
          <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-secondary-600">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
            </svg>
            Location
          </h2>
          <div class="text-gray-500 italic">Nessun spazio geografico disponibile</div>
        </div>
      `:`
      <div class="bg-gradient-to-r from-secondary-50/90 to-indigo-50/90 backdrop-blur-sm rounded-2xl p-8 ring-1 ring-secondary-200/50 border border-secondary-200/30">
        <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-secondary-600">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
          </svg>
          Location
        </h2>
        <div class="grid gap-6">
          ${e.Location.map((n,s)=>{const i=e.coordinates[s],o=e.geodataBySpace.get(n)||{},a=this._getAllMetadataFields(),u=this._getCatalogueFields(),c=[],h=a.filter(m=>!c.includes(m)&&!u.includes(m)).map(m=>{let p=o[m];if(p==null||p==="")return"";let y=p;return typeof p=="string"&&p.length>100&&(y=p.substring(0,97)+"..."),`
            <div class="flex items-start gap-3 py-2">
              <div class="w-1.5 h-1.5 bg-secondary-400 rounded-full mt-2 flex-shrink-0"></div>
              <div class="min-w-0 flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-xs font-semibold text-gray-600 uppercase tracking-wide">${m}</span>
                </div>
                <span class="text-sm text-gray-800">${y}</span>
              </div>
            </div>
          `}).filter(Boolean).join(""),v=i&&i.lat&&i.lng;return`
        <div class="space-card bg-white/90 backdrop-blur-sm rounded-xl p-6 ring-1 ring-gray-200/50 hover:ring-secondary-300/70 transition-all duration-300 hover:shadow-lg border border-gray-200/30 hover:border-secondary-300/50 hover:-translate-y-1">
          <div class="flex items-start justify-between mb-4">
            <div class="flex items-center gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-5 h-5 text-secondary-600 flex-shrink-0">
                <path fill-rule="evenodd" d="m7.539 14.841.003.003.002.002a.755.755 0 0 0 .912 0l.002-.002.003-.003.012-.009a5.57 5.57 0 0 0 .19-.153 15.588 15.588 0 0 0 2.046-2.082c1.101-1.362 2.291-3.342 2.291-5.597A5 5 0 0 0 3 7c0 2.255 1.19 4.235 2.292 5.597a15.591 15.591 0 0 0 2.046 2.082 8.916 8.916 0 0 0 .189.153l.012.01ZM8 8.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" clip-rule="evenodd" />
              </svg>
              <h3 class="text-lg font-semibold text-gray-900">${n}</h3>
            </div>
            
            ${v?`
              <button class="map-btn group px-4 py-2 text-sm font-medium bg-gradient-to-r from-secondary-500 to-secondary-600 hover:from-secondary-600 hover:to-secondary-700 active:from-secondary-700 active:to-secondary-800 text-white rounded-lg shadow-md hover:shadow-lg transition-all duration-300 hover:scale-105 hover:-translate-y-0.5" 
                      data-lat="${i.lat}" 
                      data-lng="${i.lng}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 inline mr-1">
                  <path fill-rule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V6h4.5a.75.75 0 0 1 0 1.5H8.75v4.25a.75.75 0 0 1-1.5 0V7.5H2.75a.75.75 0 0 1 0-1.5h4.5V1.75A.75.75 0 0 1 8 1Z" clip-rule="evenodd" />
                </svg>
                Visualizza sulla mappa
              </button>
            `:`
              <span class="px-4 py-2 text-sm font-medium bg-gray-100/80 text-gray-500 rounded-lg ring-1 ring-gray-200/50 backdrop-blur-sm">
                Coordinate non disponibili
              </span>
            `}
          </div>
          
          ${h?`
            <div class="border-t border-gray-100/50 pt-4 mt-4">
              <h4 class="text-sm font-semibold text-gray-700 mb-3">Metadati geografici per questo spazio:</h4>
              <div class="space-y-2">
                ${h}
              </div>
            </div>
          `:`
            <div class="border-t border-gray-100/50 pt-4 mt-4">
              <div class="text-sm text-gray-500 italic">Nessun metadato geografico disponibile per questo spazio</div>
            </div>
          `}
        </div>
      `}).join("")}
        </div>
        <div class="mt-6 text-sm text-secondary-700 bg-secondary-100/80 backdrop-blur-sm rounded-lg p-3 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
            <path fill-rule="evenodd" d="M15 8A7 7 0 1 1 1 8a7 7 0 0 1 14 0ZM9 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0ZM6.75 8a.75.75 0 0 0 0 1.5h.75v1.75a.75.75 0 0 0 1.5 0v-2.5A.75.75 0 0 0 8.25 8h-1.5Z" clip-rule="evenodd" />
          </svg>
          <span>Clicca sui pulsanti per visualizzare i luoghi sulla mappa. Ogni spazio mostra solo i metadati geografici disponibili.</span>
        </div>
      </div>
    `}_addMapFocusListeners(){document.querySelectorAll(".map-btn").forEach(e=>{e.addEventListener("click",()=>{const t=parseFloat(e.getAttribute("data-lat")),n=parseFloat(e.getAttribute("data-lng"));t&&n&&this.mapFocusCallback&&(this.mapFocusCallback(t,n,8),this._closeModal())})})}_extractCoordinates(e,t){let n={lat:null,lng:null};if(Array.isArray(e.lat_long)&&e.lat_long.length>t){const s=e.lat_long[t];if(s&&typeof s=="string"){const i=s.split(",");if(i.length===2){const o=parseFloat(i[0].trim()),a=parseFloat(i[1].trim());!isNaN(o)&&!isNaN(a)&&(n={lat:o,lng:a})}}}else if(e.lat_long&&typeof e.lat_long=="string"){const s=e.lat_long.split(",");if(s.length===2){const i=parseFloat(s[0].trim()),o=parseFloat(s[1].trim());!isNaN(i)&&!isNaN(o)&&(n={lat:i,lng:o})}}return n}}class Sa{constructor(e){this.mapFocusCallback=e,this.allWorks=[],this.modalRenderer=new _a(e)}updateResultsList(e,t,n={}){const s=document.getElementById("results");if(!s){console.error("Results container not found");return}this.items=e,this.searchState=n;const i=this._groupByIdOpera(e);this.allWorks=Object.values(i),this.modalRenderer.setData(this.allWorks,this.items),this.modalRenderer.setConfig(t),this.modalRenderer.setSearchState(n),s.innerHTML=this.allWorks.map((o,a)=>this._renderResultItem(o,a)).join(""),this._addMapFocusListeners(),this._addModalListeners()}focusOnResult(e){const t=document.querySelector(`[data-result-id="${e}"]`);return t?(this._openFiltersPanel(),t.scrollIntoView({behavior:"smooth",block:"center"}),this._highlightResult(t),console.log(`Focused on result with pivot_ID: ${e}`),!0):(console.warn(`Result with pivot_ID ${e} not found in current results`),!1)}_openFiltersPanel(){const e=document.getElementById("results-panel");e?(e.classList.remove("panel-closed-right"),console.log("Filters panel opened")):console.warn('Filters panel with ID "results-panel" not found')}_highlightResult(e){const t=document.querySelector(".result-highlighted");t&&t.classList.remove("result-highlighted"),e.classList.add("result-highlighted"),e.style.transition="all 0.3s ease",e.style.transform="scale(1.02)",setTimeout(()=>{e.style.transform=""},1e3),setTimeout(()=>{e.classList.remove("result-highlighted")},3e3)}_groupByIdOpera(e){const t={};return e.forEach(n=>{const s=n.pivot_ID;t[s]||(t[s]={pivot_ID:s,Title:n[window.ledaSearch.config.result_cards.card_title],Subtitle:n[window.ledaSearch.config.result_cards.card_subtitle]||"",Subtitle2:n[window.ledaSearch.config.result_cards.card_subtitle_2]||"",Description:n[window.ledaSearch.config.result_cards.card_description]||"",Location:[],coordinates:[]}),n.Location&&(Array.isArray(n.Location)?n.Location:[n.Location]).forEach((o,a)=>{if(!t[s].Location.includes(o)){t[s].Location.push(o);const u=this._extractCoordinatesFromItem(n,a);t[s].coordinates.push(u)}})}),t}_renderResultItem(e,t){const n=e.Location.map((s,i)=>{const o=e.coordinates[i],a=o&&o.lat&&o.lng;return`
        <button class="focus-map-btn inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium transition-all duration-200 hover:shadow-sm hover:scale-105 active:scale-95 cursor-pointer transform 
                       ${a?"bg-secondary-100 hover:bg-secondary-200 text-secondary-700 border border-secondary-200":"bg-gray-100 text-gray-500 border border-gray-200"}" 
                data-space="${encodeURIComponent(s)}" 
                ${a?`data-lat="${o.lat}" data-lng="${o.lng}"`:""}
                title="${a?"Clicca per visualizzare sulla mappa":"Coordinate non disponibili"}">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 mr-1 ${a?"":"opacity-50"}">
            <path fill-rule="evenodd" d="m7.539 14.841.003.003.002.002a.755.755 0 0 0 .912 0l.002-.002.003-.003.012-.009a5.57 5.57 0 0 0 .19-.153 15.588 15.588 0 0 0 2.046-2.082c1.101-1.362 2.291-3.342 2.291-5.597A5 5 0 0 0 3 7c0 2.255 1.19 4.235 2.292 5.597a15.591 15.591 0 0 0 2.046 2.082 8.916 8.916 0 0 0 .189.153l.012.01ZM8 8.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" clip-rule="evenodd" />
          </svg>
          ${s}
        </button>
      `}).join("");return`
      <div class="result-card bg-white rounded-lg shadow-md border border-gray-200 hover:shadow-lg transition-all duration-300 p-6" 
     data-result-id="${e.pivot_ID}">
  <!-- Header -->
  <div class="flex items-start justify-between gap-4">
    <div class="min-w-0 flex-1">
      <!-- Title and Subtitles -->
      <div class="mb-4">
        <h1 class="text-xl font-bold text-gray-900 leading-tight">${e.Title}</h1>
        <div class="flex items-center gap-4 mt-2">
          ${e.Subtitle?`<p class="text-lg text-gray-700 font-medium truncate">${e.Subtitle}</p>`:""}
          ${e.Subtitle&&e.Subtitle2?'<span class="w-1.5 h-1.5 bg-gray-400 rounded-full flex-shrink-0"></span>':""}
          ${e.Subtitle2?`<p class="text-lg text-gray-600 font-mono flex-shrink-0">${e.Subtitle2}</p>`:""}
        </div>
      </div>
      
      <!-- Description with vertical bar -->
      ${e.Description?`
        <div class="flex items-start gap-2">
          <div class="w-1 bg-gradient-to-b from-primary-500 to-primary-600 rounded-full shadow-sm flex-shrink-0" style="height: auto; min-height: 1.5rem;"></div>
          <p class="text-base text-gray-600 flex-1">${e.Description}</p>
        </div>
      `:""}
    </div>
    
    <!-- More button -->
    <button class="modal-toggle-btn inline-flex items-center px-4 py-2 rounded-full shadow-md hover:shadow-lg transition-all duration-200 flex-shrink-0 bg-primary-500 hover:bg-primary-600 text-white"
            data-work-index="${t}"
            title="Visualizza tutte le opere">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
      </svg>
    </button>
  </div>
  
  <!-- Locations -->
  ${n?`
    <div class="pt-4 border-t border-gray-200">
      <div class="flex flex-wrap gap-2">
        ${n}
      </div>
    </div>
  `:""}
</div>
    `}_addModalListeners(){document.querySelectorAll(".modal-toggle-btn").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const n=parseInt(e.getAttribute("data-work-index"));this.modalRenderer.toggleModal(n)})})}_extractCoordinatesFromItem(e,t){let n={lat:null,lng:null};if(Array.isArray(e.lat_long)&&e.lat_long.length>t){const s=e.lat_long[t];if(s&&typeof s=="string"){const i=s.split(",");if(i.length===2){const o=parseFloat(i[0].trim()),a=parseFloat(i[1].trim());!isNaN(o)&&!isNaN(a)&&(n.lat=o,n.lng=a)}}}else if(e.lat_long&&typeof e.lat_long=="string"){const s=e.lat_long.split(",");if(s.length===2){const i=parseFloat(s[0].trim()),o=parseFloat(s[1].trim());!isNaN(i)&&!isNaN(o)&&(n.lat=i,n.lng=o)}}return n}_addMapFocusListeners(){document.querySelectorAll(".focus-map-btn").forEach(e=>{e.addEventListener("click",t=>{const n=e.getAttribute("data-lat"),s=e.getAttribute("data-lng");n&&s&&this.mapFocusCallback?this.mapFocusCallback(parseFloat(n),parseFloat(s),8):console.warn("Coordinate non disponibili per questa opera:",e.getAttribute("data-space"))})})}}class mn{static debounce(e,t){let n;return function(){clearTimeout(n),n=setTimeout(()=>e.apply(this,arguments),t)}}static parseCoordinates(e){if(!e||typeof e!="string")return{lat:null,lng:null};const t=e.split(",");return t.length===2?{lat:parseFloat(t[0].trim()),lng:parseFloat(t[1].trim())}:{lat:null,lng:null}}static encodeForAttribute(e){return encodeURIComponent(e||"")}static createUniqueId(e="element"){return`${e}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}static isEmpty(e){return e==null?!0:typeof e=="string"?e.trim()==="":Array.isArray(e)?e.length===0:typeof e=="object"?Object.keys(e).length===0:!1}}class Ca{constructor(){this.config=null,this.searchEngine=null,this.universalNav=null,this.universalFooter=null,this.state={query:"",filters:{},sort:"",bounds:null},this.isLoading=!1,this.isInitialLoad=!0,this.isFullyLoaded=!1,this.initialize()}async initialize(){try{this.showFullScreenLoader(),this.config=await os();const e=await cs();this.config.searchConfig.per_page=e.length,new as(this.config).render(),new ls(this.config).render(),this.searchEngine=Mo(e,this.config),this.state.sort=this.config.searchConfig.defaultSort,this.state.filters=this.createEmptyFilters(),await this.initializeComponents(),this.bindEvents(),this.bindNavBarEvents(),await this.performSearch(),this.applyUrlFilters(),this.isInitialLoad=!1,this.isFullyLoaded=!0,this.hideFullScreenLoader()}catch(e){console.error("Initialization error:",e),this.showNotification("Error loading application","error"),this.hideFullScreenLoader()}}applyUrlFilters(){const e=new URLSearchParams(window.location.search),t=e.get("filter"),n=e.get("value");console.log("Checking URL parameters:",{filterKey:t,filterValue:n}),t&&n&&(console.log(`Applying URL filter: ${t} = ${n}`),this.config.aggregations&&this.config.aggregations[t]?setTimeout(()=>{this.handleStateChange({type:"FACET_CHANGE",facetType:t,value:n,checked:!0}),console.log(`Filter applied: ${t} = ${n}`),this.showFilterNotification(t,n)},1500):(console.warn(`Filter key '${t}' not found in configuration`),this.showNotification(`Filtro '${t}' non trovato`,"warning")))}showFilterNotification(e,t){const n=document.createElement("div");n.className="fixed top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300",n.style.transform="translateX(100%)",n.innerHTML=`
      <div class="flex items-center space-x-3">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
        </svg>
        <span>Filtro applicato: <strong>${e}</strong> = "${t}"</span>
        <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    `,document.body.appendChild(n),setTimeout(()=>{n.style.transform="translateX(0)"},100),setTimeout(()=>{n.style.transform="translateX(100%)",setTimeout(()=>{n.parentElement&&n.parentElement.removeChild(n)},300)},5e3)}createEmptyFilters(){const e={};for(const[t]of Object.entries(this.config.aggregations))e[t]=[];return e}async initializeComponents(){const e=us(this.config);this.map=e.map,this.markers=e.markers,this.renderMarkers=e.renderMarkers,this.setFocusResultCallback=e.setFocusResultCallback,this.mapInstance=e,window.ledaSearch||(window.ledaSearch={}),window.ledaSearch.config=this.config,window.ledaSearch.mapInstance=this.mapInstance,window.switchMarkerType=t=>{this.mapInstance&&this.mapInstance.switchMarkerType&&this.mapInstance.switchMarkerType(t)},this.facetRenderer=new wa(this.config),this.rangeRenderer=new Xn,this.taxonomyRenderer=new Hn,this.searchHandler=new xa(this.searchEngine,this.config),this.resultsRenderer=new Sa((t,n,s)=>this.focusOnMap(t,n,s)),this.navBar=Po,this.connectMapToResults(),this.debouncedSearch=mn.debounce(async()=>{await this.performSearch()},300)}connectMapToResults(){this.setFocusResultCallback&&this.setFocusResultCallback(e=>{const t=this.resultsRenderer.focusOnResult(e);return t||this.showNotification("Item not found in current results","warning"),t})}showFullScreenLoader(){this.fullScreenLoader||(this.fullScreenLoader=document.createElement("div"),this.fullScreenLoader.className="fixed inset-0 z-[9999] bg-white flex items-center justify-center",this.fullScreenLoader.innerHTML=`
        <div class="text-center">
          <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-primary-500 mx-auto mb-4"></div>
          <h2 class="text-xl font-semibold text-gray-700 mb-2">Loading LEDA Search</h2>
          <p class="text-gray-500">Initializing map, data, and components...</p>
        </div>
      `,document.body.appendChild(this.fullScreenLoader)),this.fullScreenLoader.style.display="flex"}hideFullScreenLoader(){this.fullScreenLoader&&(this.fullScreenLoader.style.opacity="0",this.fullScreenLoader.style.transition="opacity 0.3s ease-out",setTimeout(()=>{this.fullScreenLoader&&(this.fullScreenLoader.style.display="none")},300))}showNotification(e,t="info"){const n=document.createElement("div");n.className=`fixed top-4 right-4 z-50 p-3 rounded-lg shadow-lg max-w-sm text-white transition-all duration-300 ${t==="error"?"bg-red-500":t==="warning"?"bg-yellow-500":"bg-blue-500"}`,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.opacity="0",setTimeout(()=>n.remove(),300)},300)}async performSearch(){var e,t;try{const n=this.searchHandler.performSearch(this.state,{onMarkersUpdate:i=>this.renderMarkers(i),onResultsUpdate:i=>this.resultsRenderer.updateResultsList(i,this.config,{filters:this.state.filters,query:this.state.query,sort:this.state.sort}),onAggregationsUpdate:i=>this.renderFacets(i)}),s=this.calculateUniqueResultsCount(n.items);return this.updateNavBar(((e=n.items)==null?void 0:e.length)||0,{uniqueResultsCount:s}),console.log("Search completed:",((t=n.items)==null?void 0:t.length)||0,"items found"),n}catch(n){console.error("Search error:",n),this.showNotification("Search failed","error")}}calculateUniqueResultsCount(e){if(!e||!Array.isArray(e))return 0;const t=new Set;return e.forEach(n=>{var i,o,a,u,c,h;const s=n.pivot_ID||n.pivotID||n.pivot_id||((i=n._source)==null?void 0:i.pivot_ID)||((o=n._source)==null?void 0:o.pivotID)||((a=n._source)==null?void 0:a.pivot_id)||((u=n.source)==null?void 0:u.pivot_ID)||((c=n.source)==null?void 0:c.pivotID)||((h=n.source)==null?void 0:h.pivot_id);s!=null&&s!==""&&t.add(s)}),t.size}async handleStateChange(e){var t,n;console.log("handleStateChange called with action:",e);try{switch(e.type){case"FACET_CHANGE":this.updateFilters(e.facetType,e.value,e.checked);break;case"RANGE_CHANGE":this.state.filters[e.facetKey]=e.value;break;case"QUERY_CHANGE":this.state.query=e.query;break;case"SORT_CHANGE":this.state.sort=e.sort;break}console.log("State updated, triggering search. New state:",this.state),this.isLoading=!1;const s=this.searchHandler.performSearch(this.state,{onMarkersUpdate:o=>this.renderMarkers(o),onResultsUpdate:o=>this.resultsRenderer.updateResultsList(o,this.config,{filters:this.state.filters,query:this.state.query,sort:this.state.sort}),onAggregationsUpdate:o=>this.renderFacets(o)}),i=this.calculateUniqueResultsCount(s.items);this.updateNavBar(((t=s.items)==null?void 0:t.length)||0,{uniqueResultsCount:i}),console.log("Filter search completed:",((n=s.items)==null?void 0:n.length)||0,"items found")}catch(s){console.error("Error in handleStateChange:",s)}}hasActiveFilters(){if(!this.state.filters)return!1;for(const[e,t]of Object.entries(this.state.filters))if(Array.isArray(t)&&t.length>0||!Array.isArray(t)&&t)return!0;return!1}updateFilters(e,t,n){var s;console.log(`Updating filter: ${e}, value: ${t}, checked: ${n}`),n?(this.state.filters[e]||(this.state.filters[e]=[]),this.state.filters[e].push(t)):this.state.filters[e]=((s=this.state.filters[e])==null?void 0:s.filter(i=>i!==t))||[],console.log("Updated filters:",this.state.filters)}bindEvents(){this.setupSearchInput(),this.setupSortSelect(),this.setupMapEvents()}bindNavBarEvents(){this.navBar.addEventListener("clearAllFilters",()=>this.clearAllFilters()),this.navBar.addEventListener("removeFilter",e=>{const{facetKey:t,value:n}=e.detail;this.removeFilter(t,n)}),this.navBar.addEventListener("clearSearchQuery",()=>this.clearSearchQuery())}setupSearchInput(){const e=document.getElementById("search-input");e&&e.addEventListener("input",()=>{this.state.query=e.value,this.debouncedSearch()})}setupSortSelect(){const e=document.getElementById("sort-select");e&&this.config.searchConfig.sortOptions&&(e.innerHTML=this.config.searchConfig.sortOptions.map(t=>`<option value="${t.value}">${t.label}</option>`).join(""),e.addEventListener("change",t=>{this.state.sort=t.target.value,this.performSearch()}))}setupMapEvents(){const e=mn.debounce(async()=>{await this.performSearch()},500);this.map.on("moveend",e)}focusOnMap(e,t,n=15){this.map&&this.map.setView([parseFloat(e),parseFloat(t)],n)}renderFacets(e){this.facetRenderer.renderFacets(e,this.state,t=>this.handleStateChange(t))}updateNavBar(e=0,t={}){this.navBar.updateFromSearchState(this.state,e,t)}clearAllFilters(){this.state.query="",this.state.filters=this.createEmptyFilters();const e=document.getElementById("search-input");e&&(e.value=""),this.performSearch()}removeFilter(e,t){this.state.filters[e]&&(t?this.state.filters[e]=this.state.filters[e].filter(n=>n!==t):this.state.filters[e]=[],this.performSearch())}clearSearchQuery(){this.state.query="";const e=document.getElementById("search-input");e&&(e.value=""),this.performSearch()}getLoadingStatus(){return{isLoading:this.isLoading,isFullyLoaded:this.isFullyLoaded,searchEngineReady:!!this.searchEngine,mapReady:!!this.map,configLoaded:!!this.config}}}document.addEventListener("DOMContentLoaded",()=>{window.ledaSearch=new Ca})});export default Ea();
